<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">



























<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png?v=6.6.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.6.0" color="#222">









<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.6.0',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Kafka相关的技术知识，本文内容均基于 Ubuntu 18.04 虚拟机进行。说明，本文档共涉及6台服务器192.168.56.101 - kafka0192.168.56.102 - kafka1192.168.56.103 - kafka2192.168.56.104 - zookeeper0192.168.56.105 - zookeeper1192.168.56.106 - zookee">
<meta name="keywords" content="Docker,Kafka">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafka学习指南">
<meta property="og:url" content="https://www.leezy.top/2020/02/07/Kafka学习指南/index.html">
<meta property="og:site_name" content="SAKURA">
<meta property="og:description" content="Kafka相关的技术知识，本文内容均基于 Ubuntu 18.04 虚拟机进行。说明，本文档共涉及6台服务器192.168.56.101 - kafka0192.168.56.102 - kafka1192.168.56.103 - kafka2192.168.56.104 - zookeeper0192.168.56.105 - zookeeper1192.168.56.106 - zookee">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://www.leezy.top/assets/blogImg/Kafka%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.png">
<meta property="og:image" content="https://www.leezy.top/assets/blogImg/Zookeeper%E5%AE%89%E8%A3%85.png">
<meta property="og:image" content="https://www.leezy.top/assets/blogImg/Kafka%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE.png">
<meta property="og:image" content="https://www.leezy.top/assets/blogImg/Kafka%E6%96%B0%E5%BB%BAtopic.png">
<meta property="og:image" content="https://www.leezy.top/assets/blogImg/Kafka%E7%94%9F%E4%BA%A7%E8%80%85%E5%8F%82%E6%95%B0.png">
<meta property="og:image" content="https://www.leezy.top/assets/blogImg/Kafka%E6%B6%88%E8%B4%B9%E8%80%85%E5%8F%82%E6%95%B0.png">
<meta property="og:image" content="https://www.leezy.top/assets/blogImg/Kafka%E5%88%86%E5%8C%BA%E8%AF%B4%E6%98%8E.png">
<meta property="og:image" content="https://www.leezy.top/assets/blogImg/Kafka%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E5%88%86%E7%B1%BB.png">
<meta property="og:image" content="https://www.leezy.top/assets/blogImg/Kafka%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84%E6%93%8D%E4%BD%9C.png">
<meta property="og:updated_time" content="2020-11-28T08:46:52.501Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kafka学习指南">
<meta name="twitter:description" content="Kafka相关的技术知识，本文内容均基于 Ubuntu 18.04 虚拟机进行。说明，本文档共涉及6台服务器192.168.56.101 - kafka0192.168.56.102 - kafka1192.168.56.103 - kafka2192.168.56.104 - zookeeper0192.168.56.105 - zookeeper1192.168.56.106 - zookee">
<meta name="twitter:image" content="https://www.leezy.top/assets/blogImg/Kafka%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.png">



  <link rel="alternate" href="/atom.xml" title="SAKURA" type="application/atom+xml">




  <link rel="canonical" href="https://www.leezy.top/2020/02/07/Kafka学习指南/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Kafka学习指南 | SAKURA</title>
  












  <noscript>
  <style>
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion .logo-line-before i { left: initial; }
    .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">SAKURA</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.leezy.top/2020/02/07/Kafka学习指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LEEZY">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SAKURA">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Kafka学习指南

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-02-07 16:49:21" itemprop="dateCreated datePublished" datetime="2020-02-07T16:49:21+08:00">2020-02-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-11-28 16:46:52" itemprop="dateModified" datetime="2020-11-28T16:46:52+08:00">2020-11-28</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/07/Kafka学习指南/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2020/02/07/Kafka学习指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2020/02/07/Kafka学习指南/" class="leancloud_visitors" data-flag-title="Kafka学习指南">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Kafka相关的技术知识，本文内容均基于 Ubuntu 18.04 虚拟机进行。说明，本文档共涉及6台服务器<br>192.168.56.101 - kafka0<br>192.168.56.102 - kafka1<br>192.168.56.103 - kafka2<br>192.168.56.104 - zookeeper0<br>192.168.56.105 - zookeeper1<br>192.168.56.106 - zookeeper2</p>
<a id="more"></a>

<p>Kafka将所有消息组织成多个topic的形式存储，而每个topic又可以拆分为多个partition，每个partition又由一个一个的消息组成，每个消息都被标识了一个递增的序列号代表其进来的先后顺序，并按照顺序存储到partition；</p>
<ul>
<li><p>producer选择一个topic，生产消息，消息会通过分配策略append到某个partition末尾</p>
</li>
<li><p>consumer选择一个topic, 通过id指定从那个位置开始消费消息。消费完成之后保留id，下次可以从这个位置开始继续消费，也可以从其他任意位置开始消费，这里的id即为offset。<br>一个典型的 Kafka 体系架构包括若干 Producer、若干 Broker、若干 Consumer，以及一个ZooKeeper集群，其中ZooKeeper是Kafka用来负责集群元数据的管理、控制器的选举等操作的。Producer将消息发送到Broker，Broker负责将收到的消息存储到磁盘中，而Consumer负责从Broker订阅并消费消息。</p>
</li>
</ul>
<p><img src="/assets/blogImg/Kafka%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.png" alt="Kafka基本概念"></p>
<h1 id="Kafka的安装配置"><a href="#Kafka的安装配置" class="headerlink" title="Kafka的安装配置"></a>Kafka的安装配置</h1><h2 id="Ubuntu服务器环境下Kafka安装与配置"><a href="#Ubuntu服务器环境下Kafka安装与配置" class="headerlink" title="Ubuntu服务器环境下Kafka安装与配置"></a>Ubuntu服务器环境下Kafka安装与配置</h2><h3 id="Zookeeper安装与配置-standalone模式"><a href="#Zookeeper安装与配置-standalone模式" class="headerlink" title="Zookeeper安装与配置 - standalone模式"></a>Zookeeper安装与配置 - standalone模式</h3><ol>
<li>首先安装JAVA环境，下载jdk tar.gz安装包，上传到<code>/usr/local</code>路径下，并执行<code>tar -zxvf jdk-8u241-linux-x64.tar.gz</code>解压。然后修改系统配置文件<code>vim /etc/profile</code>。<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/local/jdk1.8.0_241</span><br><span class="line">export CLASSPATH=.:$&#123;JAVA_HOME&#125;/jre/lib/rt.jar:$&#123;JAVA_HOME&#125;/lib/dt.jar:$&#123;JAVA_HOME&#125;/lib/tools.jar</span><br><span class="line">export PATH=$PATH:$&#123;JAVA_HOME&#125;/bin</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>使得配置文件生效<code>source /etc/profile</code></p>
<ol start="2">
<li>下载zookeeper, <a href="https://mirrors.cnnic.cn/apache/zookeeper/zookeeper-3.5.6/" target="_blank" rel="noopener">这里</a>, 解压到<code>/usr/local/</code>, <code>tar -zxvf /usr/local/apache-zookeeper-3.5.6-bin.tar.gz</code>, 修改config目录下的<code>zoo_sample.cfg</code>重命名为<code>zoo.cfg</code><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> zk中的时间单元，zk中所有时间都以此时间单元为基准，进行整数倍配置</span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="meta">#</span> follower在启动过程中，会从leader同步所有最新数据，确定自己能够对外服务的起始状态。</span><br><span class="line"><span class="meta">#</span> 当follower在initLimit个tickTime还没完成数据同步时，则leader认为follower连接失败。</span><br><span class="line">initLimit=10</span><br><span class="line"><span class="meta">#</span> leader与Follower之间通信请求和应答的时间长度。</span><br><span class="line"><span class="meta">#</span> 当leader在syncLimit个tickTime还没有收到follower的应答，则认为leader已下线。</span><br><span class="line">syncLimit=5</span><br><span class="line"><span class="meta">#</span> 快照文件存储目录，如果不配置dataLogDir，则事务日志也会保存在这个目录（不推荐）</span><br><span class="line">dataDir=/opt/data/zookeeper/data</span><br><span class="line"><span class="meta">#</span> 事务日志存储目录</span><br><span class="line">dataLogDir=/opt/data/zookeeper/logs</span><br><span class="line"><span class="meta">#</span> zk对外提供服务端口</span><br><span class="line">clientPort=2181</span><br><span class="line"><span class="meta">#</span> the maximum number of client connections.</span><br><span class="line"><span class="meta">#</span> increase this if you need to handle more clients</span><br><span class="line"><span class="meta">#</span>maxClientCnxns=60</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>修改zookeeper环境变量，节省操作步骤<code>vim /etc/profile</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export ZOOKEEPER_HOME=/usr/local/apache-zookeeper-3.5.6</span><br><span class="line"><span class="meta">#</span> 在文件的Path配置项里添加下列配置，注意有:号</span><br><span class="line">:$&#123;ZOOKEEPER_HOME&#125;/bin</span><br></pre></td></tr></table></figure>

<p>更新环境变量<code>source /etc/profile</code>。启动Zookeeper<code>zkServer.sh start</code>。如果遇到<code>Permission denied</code>的问题就授权给zk的安装目录<code>chmod -R 755 /usr/local/apache-zookeeper-3.5.6/</code>。可以通过<code>zkServer.sh status</code>查看运行状态。通过<code>jps</code>可以看到zk对应的java进程。</p>
<p><img src="/assets/blogImg/Zookeeper%E5%AE%89%E8%A3%85.png" alt="Zookeeper安装"><br>还可以通过以下命令通过zk客户端进行连接。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 登录zk服务器</span><br><span class="line">zkCli.sh -server 127.0.0.1:2181</span><br></pre></td></tr></table></figure>

<p>执行<code>ls /</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[zk: 127.0.0.1:2181(CONNECTED) 0] ls /</span><br><span class="line"><span class="meta">#</span> 只有一个zookeeper节点</span><br><span class="line">[zookeeper]</span><br></pre></td></tr></table></figure>

<h3 id="Zookeeper安装与配置-集群模式"><a href="#Zookeeper安装与配置-集群模式" class="headerlink" title="Zookeeper安装与配置 - 集群模式"></a>Zookeeper安装与配置 - 集群模式</h3><p>与单机模式类似，集群模式需要对机器进行映射。我本地有三台zk的虚拟机，单机的配置，这三台集群都要有。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.56.104 - zookeeper0</span><br><span class="line">192.168.56.105 - zookeeper1</span><br><span class="line">192.168.56.106 - zookeeper2</span><br></pre></td></tr></table></figure>

<p>然后进入其中一台机器的ZooKeeper安装路径conf目录。这里我们选择先在<code>IP为192.168.56.104</code>的机器上进行配置，编辑<code>conf/zoo.cfg</code>文件，在该文件中添加以下配置：</p>
<p><em>server.N=N-server-IP:A:B 其中N是一个数字, 表示这是第几号server，它的值和myid文件中的值对应。N-server-IP是第N个server所在的IP地址。A是配置该server和集群中的leader交换消息所使用的端口。B配置选举leader时服务器相互通信所使用的端口。</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 在每个zk的配置文件里都同时配置三台机器</span><br><span class="line">server.1=192.168.56.104:2888:3888</span><br><span class="line">server.2=192.168.56.105:2888:3888</span><br><span class="line">server.3=192.168.56.106:2888:3888</span><br></pre></td></tr></table></figure>

<p>接着在<code>${dataDir}</code>路径下创建一个<code>myid文件</code>。myid里存放的值就是<code>服务器的编号</code>，即对应上述公式中的<code>N</code>，在这里第一台机器myid存放的值为1。ZooKeeper在启动时会读取myid文件中的值与zoo.cfg文件中的配置信息进行比较，以确定是哪台服务器。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/data/zookeeper/data</span><br><span class="line">touch myid</span><br><span class="line">echo 1 &gt; myid</span><br></pre></td></tr></table></figure>

<p>同理在其它两个机器上分别修改<code>zoo.cfg</code>以及<code>myid</code>文件。<br>然后在三台机器上分别执行<code>zkServer.sh start</code>以及<code>zkServer.sh status</code>, 打印出如下日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 192.168.56.104 - zookeeper0</span><br><span class="line">root@zookeeper0:/opt/data/zookeeper/data# zkServer.sh start</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/apache-zookeeper-3.5.6/bin/../conf/zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br><span class="line">root@zookeeper0:/opt/data/zookeeper/data# zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/apache-zookeeper-3.5.6/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost.</span><br><span class="line">Mode: follower</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 192.168.56.105 - zookeeper1</span><br><span class="line">root@zookeeper1:/opt/data/zookeeper/data# zkServer.sh start</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/apache-zookeeper-3.5.6/bin/../conf/zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br><span class="line">root@zookeeper1:/opt/data/zookeeper/data# zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/apache-zookeeper-3.5.6/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost.</span><br><span class="line">Mode: leader</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 192.168.56.106 - zookeeper2</span><br><span class="line"> ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/apache-zookeeper-3.5.6/bin/../conf/zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br><span class="line">root@zookeeper2:/opt/data/zookeeper/data# zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/apache-zookeeper-3.5.6/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost.</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure>

<p>可以看到，这3台机器中，一台机器作为Leader，其他两台服务器作为Follower。</p>
<h3 id="Kafka安装与配置-单机模式"><a href="#Kafka安装与配置-单机模式" class="headerlink" title="Kafka安装与配置 - 单机模式"></a>Kafka安装与配置 - 单机模式</h3><ol>
<li><p>下载kafka, <a href="https://mirrors.cnnic.cn/apache/zookeeper/zookeeper-3.5.6/" target="_blank" rel="noopener">这里</a>, 解压到<code>/usr/local/</code>, <code>tar -zxvf /usr/local/kafka_2.13-2.4.0.tgz</code></p>
</li>
<li><p>配置环境变量, <code>vim /etc/profile</code>，按照下图配置后保存文件退出，执行source /etc/profile命令让刚才新增的Kafka环境变量设置生效。再在任一路径下输入kafka然后按Tab键，会提示补全Kafka运行相关脚本．sh文件，表示Kafka环境变量配置成功。</p>
</li>
</ol>
<p><img src="/assets/blogImg/Kafka%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE.png" alt="Kafka环境变量配置"></p>
<ol start="3">
<li>修改kafka配置，修改<code>$KAFKA_HOME/config</code>目录下的<code>server.properties</code>文件，为了便于后续集群环境搭建的配置，需要保证同一个集群下broker.id要唯一，因此这里手动配置<code>broker.id</code>，直接保持与zk的myid值一致，同时配置日志存储路径。server.properties修改的配置如下：<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 指定的代理ID，由于是单机模式，这里指定zk节点id为<span class="number">1</span>，及zookeeper0那台机器。</span><br><span class="line">broker.id=<span class="number">1</span></span><br><span class="line"># 指定Log存储路径</span><br><span class="line"><span class="built_in">log</span>.dirs=/<span class="keyword">opt</span>/data/kafka-logs</span><br><span class="line"># 指定kafka的安装路径，由于我zk没和kafka安装在同一台机器上所以这里要修改。</span><br><span class="line">zookeeper.connect=<span class="number">192.168</span>.<span class="number">56.104</span>:<span class="number">2181</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>修改完后，保存文件然后启动Kafka，进入Kafka安装路径$KAFKA_HOME/bin目录下，执行启动KafkaServer命令。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> -daemon参数表示使程序以守护进程的方式后台运行</span><br><span class="line">kafka-server-start.sh -daemon /usr/local/kafka_2.13-2.4.0/config/server.properties</span><br></pre></td></tr></table></figure>

<p>执行jps命令查看Java进程，可以看到kafka的进程名，同时进入$KAFKA_HOME/logs目录下，查看server.log会看到KafkaServer启动日志，在启动日志中会记录KafkaServer启动时加载的配置信息。<br>此时登录<code>192.168.56.104</code>这台zk可以再次查看目录结构：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkCli.sh -server 192.168.56.104:2181</span><br></pre></td></tr></table></figure>

<p>通过zk客户端登录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 在Kafka启动之前ZooKeeper中只有一个zookeeper目录节点，Kafka启动后目录节点如下：</span><br><span class="line">[zk: 127.0.0.1:2181(CONNECTED) 0] ls /</span><br><span class="line">[admin, brokers, cluster, config, consumers, controller, controller_epoch, isr_change_notification, latest_producer_id_block, log_dir_event_notification, zookeeper]</span><br><span class="line"><span class="meta">#</span> 查看当前已启动的Kafka代理节点：输出信息显示当前只有一个Kafka代理节点，当前代理的brokerId为1</span><br><span class="line">[zk: 127.0.0.1:2181(CONNECTED) 1] ls /brokers/ids</span><br><span class="line">[1]</span><br></pre></td></tr></table></figure>

<h3 id="Kafka安装与配置-集群模式"><a href="#Kafka安装与配置-集群模式" class="headerlink" title="Kafka安装与配置 - 集群模式"></a>Kafka安装与配置 - 集群模式</h3><p>集群与单机类似，这里只需修改<code>server.properties</code>文件中Kafka连接ZooKeeper的配置，将Kafka连接到ZooKeeper集群，配置格式为<code>ZooKeeper服务器IP:ZooKeeper的客户端端口</code>，多个ZooKeeper机器之间以逗号分隔开。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zookeeper.connect=192.168.56.104:2181,192.168.56.105:2181,192.168.56.106:2181</span><br></pre></td></tr></table></figure>

<p>执行下列命令复制kafka整个目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local</span><br><span class="line"># 复制文件到kafka1</span><br><span class="line">scp -r kafka_2.13-2.4.0 root@192.168.56.102:/usr/local/</span><br><span class="line"># 复制文件到kafka2</span><br><span class="line">scp -r kafka_2.13-2.4.0 root@192.168.56.103:/usr/local/</span><br></pre></td></tr></table></figure>

<p>分别登录另外两台机器，修改<code>server.properties</code>文件中的<code>broker.id</code>依次为<code>2</code>和<code>3</code>, 并安装java环境，配置环境变量，同时也添加上述zk配置。<br>同样的，修改三台机器的<code>advertised.listeners=PLAINTEXT://your.host.name:9092</code>属性为具体的ip和端口。</p>
<p><em>listeners：kafka的连接协议名、主机名和端口，如果没有配置，将使用java.net.InetAddress.getCanonicalHostName()的返回值作为主机名<br>advertised.listeners：生产者和消费者使用的主机名和端口，如果没有配置，将使用listeners的配置，如果listeners也没有配置，将使用java.net.InetAddress.getCanonicalHostName()的返回值</em><br>然后在3台机器上启动kafka</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-server-start.sh -daemon /usr/local/kafka_2.13-2.4.0/config/server.properties</span><br></pre></td></tr></table></figure>

<p>这个时候在任意一台zk服务器上执行<code>ls /brokers/ids</code>都会得到一下结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: 127.0.0.1:2181(CONNECTED) 4] ls /brokers/ids</span><br><span class="line">[1, 2, 3]</span><br></pre></td></tr></table></figure>

<h2 id="Docker环境安装与配置"><a href="#Docker环境安装与配置" class="headerlink" title="Docker环境安装与配置"></a>Docker环境安装与配置</h2><h3 id="镜像下载"><a href="#镜像下载" class="headerlink" title="镜像下载"></a>镜像下载</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull wurstmeister/zookeeper</span><br><span class="line"></span><br><span class="line">docker pull wurstmeister/kafka</span><br></pre></td></tr></table></figure>

<h3 id="zookeeper容器启动"><a href="#zookeeper容器启动" class="headerlink" title="zookeeper容器启动"></a>zookeeper容器启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> -d参数 表示后台运行容器，并返回容器ID</span><br><span class="line">docker run -d --name zookeeper -p 2181:2181 -t wurstmeister/zookeeper</span><br><span class="line"><span class="meta">#</span> 查看zk服务器目录结构</span><br><span class="line">ls /</span><br></pre></td></tr></table></figure>

<h3 id="kafka容器启动"><a href="#kafka容器启动" class="headerlink" title="kafka容器启动"></a>kafka容器启动</h3><h4 id="单节点部署"><a href="#单节点部署" class="headerlink" title="单节点部署"></a>单节点部署</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 启动Kafka(注意 修改IP为镜像安装IP)</span><br><span class="line">docker run -d --name kafka \</span><br><span class="line">-p 9092:9092 \</span><br><span class="line">-e KAFKA_BROKER_ID=0 \</span><br><span class="line">-e KAFKA_ZOOKEEPER_CONNECT=192.168.56.101:2181 \</span><br><span class="line">-e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.56.101:9092 \</span><br><span class="line">-e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \</span><br><span class="line">-t wurstmeister/kafka</span><br></pre></td></tr></table></figure>

<p>注意有以下四个参数：</p>
<ul>
<li>KAFKA_BROKER_ID=0</li>
<li>KAFKA_ZOOKEEPER_CONNECT=<code>&lt;zookeeper IP&gt;</code>:<code>&lt;zookeeper port&gt;</code></li>
<li>KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://<ip>:9092</ip></li>
<li>KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092</li>
</ul>
<p>进入kafka容器内部</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it kafka /bin/bash</span><br><span class="line"><span class="meta">#</span> 查看Kafka版本，进入Kafka所在目录</span><br><span class="line">cd /opt/kafka_2.12-2.4.0</span><br><span class="line"><span class="meta">#</span> 启动消息发送方</span><br><span class="line">./bin/kafka-console-producer.sh --broker-list localhost:9092 --topic mykafka</span><br><span class="line"><span class="meta">#</span> 启动消息接收方</span><br><span class="line">./bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic mykafka --from-beginning</span><br></pre></td></tr></table></figure>

<h4 id="Kafka伪分布式环境部署"><a href="#Kafka伪分布式环境部署" class="headerlink" title="Kafka伪分布式环境部署"></a>Kafka伪分布式环境部署</h4><p>在同一台机器上启动多个Kafka Server 在单节点搭建的基础上再搭建一个节点，只需修改<code>KAFKA_BROKER_ID</code>以及<code>端口</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name kafka1 \</span><br><span class="line">-p 9093:9093 \</span><br><span class="line"><span class="meta">#</span> 修改broker_id</span><br><span class="line">-e KAFKA_BROKER_ID=1 \</span><br><span class="line">-e KAFKA_ZOOKEEPER_CONNECT=192.168.56.101:2181 \</span><br><span class="line"><span class="meta">#</span> 修改端口</span><br><span class="line">-e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.56.101:9093 \</span><br><span class="line">-e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9093 \</span><br><span class="line">-t wurstmeister/kafka</span><br></pre></td></tr></table></figure>

<p>然后再在<code>/opt/kafka_2.12-2.4.0</code>目录下执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-topics.sh --create --zookeeper 192.168.56.101:2181 --replication-factor 2 --partitions 2 --topic mytopic</span><br></pre></td></tr></table></figure>

<p>查看topic状态 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-topics.sh --describe --zookeeper 192.168.56.101:2181 --topic mytopic</span><br></pre></td></tr></table></figure>

<p>Isr表示存活的备份<br><img src="/assets/blogImg/Kafka%E6%96%B0%E5%BB%BAtopic.png" alt="Kafka新建topic"></p>
<h2 id="Kafka-Manager安装"><a href="#Kafka-Manager安装" class="headerlink" title="Kafka Manager安装"></a>Kafka Manager安装</h2><p>下载kafka Manager<a href="https://github.com/yahoo/CMAK" target="_blank" rel="noopener">这里</a>，上传到<code>/usr/local</code>文件下，并解压<code>tar -zxvf CMAK-2.0.0.2.tar.gz</code>。Kafka Manager是用Scala语言开发的，通过sbt(Simple Build Tool)构建，sbt是对Scala或Java语言进行编译的一个工具，它类似于Maven, Gradle。需要通过以下方式进行源码编译</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ./CMAK-2.0.0.2</span><br><span class="line"><span class="meta">#</span> 此过程巨慢无比，推荐直接搜索打包好的kafka-manager</span><br><span class="line">./sbt clean dist</span><br></pre></td></tr></table></figure>

<p>在下载了一晚上无果后，打开<code>/root/.sbt</code>看了看发现就下载了一个jar包，网上找了一份别人编译好的kafka-manager-2.0.0.2.zip。解压好上传，进行如下配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/kafka-manager-2.0.0.2/conf</span><br><span class="line">vim ./application.conf</span><br><span class="line"><span class="meta">#</span> 修改以下配置为真正的zk集群地址，注意是修改倒数第二行的这个配置才可以生效</span><br><span class="line">kafka-manager.zkhosts="192.168.56.104:2181,192.168.56.105:2181,192.168.56.106:2181"</span><br></pre></td></tr></table></figure>

<p>修改<code>logback.xml</code>文件中的<code>${application.home}</code>为<code>..</code>，即logs日志存储位置。启动kafka-manager</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 进入bin目录输入如下启动命令</span><br><span class="line">nohup ./kafka-manager -Dconfig.file=../conf/application.conf</span><br><span class="line"><span class="meta">#</span> 权限不够</span><br><span class="line">chmod -R 755 ../../kafka-manager-2.0.0.2/</span><br></pre></td></tr></table></figure>

<p>关闭Kafka Manager。Kafka Manager没有提供关闭操作的执行脚本及命令，当希望关闭Kafka Manager时，可直接通过kill命令强制杀掉Kafka Manager进程。查看Kafka Manager进程，输入jps命令，其中ProdServerStart即为Kafka Manager进程。通过kill命令关闭Kafka Manager。同时，由于Kafka Manager运行时有一个类似锁的文件<code>RUNNING_PID</code>，位于Kafka Manager安装路径bin同目录下，为了不影响下次启动，在执行kill命令后同时删除<code>RUNNING_PID</code>文件，<code>rm -f RUNNING_PID</code>.<br>完成以上配置后打开<code>http://192.168.56.101:9000/</code>即可。</p>
<h1 id="Kafka概念说明"><a href="#Kafka概念说明" class="headerlink" title="Kafka概念说明"></a>Kafka概念说明</h1><h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><p>Kafka系统中有四种核心应用接口——生产者、消费者、数据流、连接器。</p>
<h3 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h3><p>Kafka生产者可以理解成Kafka系统与外界进行数据交互的应用接口。生产者应用接口的作用是写入消息数据到Kafka中。Kafka系统提供了一系列的操作脚本，这些脚本放置在<code>$KAFKA_HOME/bin</code>目录中。其中，<code>kafka-console-producer.sh</code>脚本可用来作为生产者客户端。</p>
<p>生产者属性如下：</p>
<p><img src="/assets/blogImg/Kafka%E7%94%9F%E4%BA%A7%E8%80%85%E5%8F%82%E6%95%B0.png" alt="Kafka生产者参数"></p>
<p>这里重点说明以下acks属性：</p>
<ul>
<li><p>当acks=0时，生产者不用等待代理返回确认信息，而连续发送消息。显然这种方式加快了消息投递的速度，然而无法保证消息是否已被代理接受，有可能存在丢失数据的风险。</p>
</li>
<li><p>当acsk=1时，生产者需要等待Leader副本已成功将消息写入日志文件中。这种方式在一定程度上降低了数据丢失的可能性，但仍无法保证数据一定不会丢失。如果在Leader副本成功存储数据后，Follower副本还没有来得及进行同步，而此时Leader宕机了，那么此时虽然数据已进行了存储，由于原来的Leader已不可用而会从集群中下线，同时存活的代理又再也不会有从原来的Leader副本存储的数据，此时数据就会丢失。</p>
</li>
<li><p>当acks=-1时，Leader副本和所有ISR列表中的副本都完成数据存储时才会向生产者发送确认信息，这种策略保证只要Leader副本和Follower副本中至少有一个节点存活，数据就不会丢失。为了保证数据不丢失，需要保证同步的副本至少大于1，通过参数min.insync.replicas设置，当同步副本数不足此配置值时，生产者会抛出异常，但这种方式同时也影响了生产者发送消息的速度以及吞吐量。</p>
</li>
</ul>
<h3 id="消费者-与-消费组"><a href="#消费者-与-消费组" class="headerlink" title="消费者 与 消费组"></a>消费者 与 消费组</h3><p>Kafka消费著可以理解成，外界从Kafka系统中获取消息数据的一种应用接口。消费者应用接口的主要作用是读取消息数据。Kafka系统提供了一系列的可操作脚本，这些脚本放置在<code>$KAFKA_HOME/bin</code>目录下。其中，有一个脚本可用来作为消费者客户端，即<code>kafka-console-consumer.sh</code>。<br>消费者属性如下：</p>
<p><img src="/assets/blogImg/Kafka%E6%B6%88%E8%B4%B9%E8%80%85%E5%8F%82%E6%95%B0.png" alt="Kafka消费者参数"></p>
<p>消费者（Comsumer）以拉取（pull）方式拉取数据，它是消费的客户端。在Kafka中每一个消费者都属于一个特定消费组（ConsumerGroup），我们可以为每个消费者指定一个消费组，以<code>groupId</code>代表消费组名称，通过<code>group.id</code>配置设置。如果不指定消费组，则该消费者属于默认消费组<code>test-consumer-group</code>。同时，每个消费者也有一个全局唯一的id，通过配置项<code>client.id</code>指定，如果客户端没有指定消费者的id, Kafka会自动为该消费者生成一个全局唯一的id，格式为<code>${groupId}-${hostName}-${timestamp}-${UUID前8位字符}</code>。<em>同一个主题的一条消息只能被同一个消费组下某一个消费者消费，但不同消费组的消费者可同时消费该消息</em>。</p>
<h3 id="broker-代理"><a href="#broker-代理" class="headerlink" title="broker - 代理"></a>broker - 代理</h3><p>对于kafka而言，broker可以简单地看作一个独立的Kafka服务节点或Kafka服务实例。大多数情况下也可以将Broker看作一台Kafka服务器，前提是这台服务器上只部署了一个Kafka实例。</p>
<h3 id="topic-主题-partition-分区-以及-Replica-副本"><a href="#topic-主题-partition-分区-以及-Replica-副本" class="headerlink" title="topic - 主题 partition - 分区 以及 Replica - 副本"></a>topic - 主题 partition - 分区 以及 Replica - 副本</h3><p>Kafka中的消息以<code>主题(topic)</code>为单位进行归类，生产者负责将消息发送到特定的主题（发送到Kafka集群中的每一条消息都要指定一个主题），而消费者负责订阅主题并进行消费。每一个代理都有唯一的标识id，这个id是一个非负整数。在一个Kafka集群中，每增加一个代理就需要为这个代理配置一个与该集群中其他代理不同的id, id值可以选择任意非负整数即可，只要保证它在整个Kafka集群中唯一，这个id就是代理的名字，也就是在启动代理时配置的broker.id对应的值。</p>
<p>主题是一个逻辑上的概念，它还可以细分为多个<code>分区(partition)</code>，一个分区只属于单个主题。每个分区由一系列<code>有序、不可变</code>的消息组成，是一个有序队列。每个分区在物理上对应为一个文件夹，分区的命名规则为主题名称后接<code>—</code>连接符，之后再接分区编号，分区编号从0开始，编号最大值为分区的总数减1。每个分区又有一至多个<code>副本(Replica)</code>，分区的副本分布在集群的不同代理上，以提高可用性。从存储角度上分析，分区的每个副本在逻辑上抽象为一个<code>日志（Log）对象</code>，即<code>分区的副本与日志对象是一一对应的</code>。每个主题对应的分区数可以在Kafka启动时所加载的配置文件中配置，也可以在创建主题时指定。当然，客户端还可以在主题创建后修改主题的分区数。由于Kafka副本的存在，就需要保证一个分区的多个副本之间数据的一致性，Kafka会选择该分区的一个副本作为Leader副本，而该分区其他副本即为Follower副本，只有Leader副本才负责处理客户端读/写请求，Follower副本从Leader副本同步数据。副本Follower与Leader的角色并不是固定不变的，如果Leader失效，通过相应的选举算法将从其他Follower副本中选出新的Leader副本。同一主题下的不同分区包含的消息是不同的，分区在存储层面可以看作一个<code>可追加的日志（Log）文件</code>，消息在被追加到分区日志文件的时候都会分配一个特定的<code>偏移量（offset）</code>。offset是消息在分区中的唯一标识，Kafka通过它来保证消息在分区内的顺序性，不过offset并不跨越分区，也就是说，Kafka保证的是分区有序而不是主题有序。</p>
<p>每一条消息被发送到broker之前，会根据分区规则选择存储到哪个具体的分区。如果分区规则设定得合理，所有的消息都可以均匀地分配到不同的分区中。如果一个主题只对应一个文件，那么这个文件所在的机器 I/O 将会成为这个主题的性能瓶颈，而分区解决了这个问题。在创建主题的时候可以通过指定的参数来设置分区的个数，当然也可以在主题创建完成之后去修改分区的数量，通过增加分区的数量可以实现水平扩展。</p>
<p>Kafka 为分区引入了<code>多副本（Replica）</code>机制，通过增加副本数量可以提升容灾能力。同一分区的不同副本中保存的是相同的消息（在同一时刻，副本之间并非完全一样），副本之间是“一主多从”的关系，其中leader副本负责处理读写请求，follower副本只负责与leader副本的消息同步。副本处于不同的broker中，当leader副本出现故障时，从follower副本中重新选举新的leader副本对外提供服务。Kafka通过多副本机制实现了故障的自动转移，当Kafka集群中某个broker失效时仍然能保证服务可用。</p>
<h3 id="日志段"><a href="#日志段" class="headerlink" title="日志段"></a>日志段</h3><p>一个日志又被划分为多个<code>日志段（LogSegment）</code>，日志段是Kafka日志对象分片的最小单位。与日志对象一样，日志段也是一个逻辑概念，一个日志段对应磁盘上一个具体日志文件和两个索引文件。日志文件是以“.log”为文件名后缀的数据文件，用于保存消息实际数据。两个索引文件分别以“.index”和“.timeindex”作为文件名后缀，分别表示消息偏移量索引文件和消息时间戳索引文件。</p>
<h3 id="ISR"><a href="#ISR" class="headerlink" title="ISR"></a>ISR</h3><p>Kafka在ZooKeeper中动态维护了一个<code>ISR（In-sync Replica）</code>，即保存同步的副本列表，该列表中保存的是与Leader副本保持消息同步的所有副本对应的代理节点id。分区中的所有副本统称为<code>AR（Assigned Replicas）</code>。所有与leader副本保持一定程度同步的副本（包括leader副本在内）组成ISR（In-Sync Replicas），ISR集合是AR集合中的一个子集。消息会先发送到leader副本，然后follower副本才能从leader副本中拉取消息进行同步，同步期间内follower副本相对于leader副本而言会有一定程度的滞后。如果一个Follower副本宕机或是落后太多，则该Follower副本节点将从ISR列表中移除。与leader副本同步滞后过多的副本（不包括leader副本）组成<code>OSR（Out-of-Sync Replicas</code>），由此可见，<code>AR=ISR+OSR</code>。在正常情况下，所有的 follower 副本都应该与 leader 副本保持一定程度的同步，即 AR=ISR，OSR集合为空。</p>
<p><code>LEO是Log End Offset</code>的缩写，它标识当前日志文件中下一条待写入消息的offset，offset为9的位置即为当前日志文件的LEO，LEO的大小相当于当前日志分区中最后一条消息的<code>offset值加1</code>。分区ISR集合中的每个副本都会维护自身的LEO，而ISR集合中最小的LEO即为分区的HW，对消费者而言只能消费HW之前的消息。</p>
<p><img src="/assets/blogImg/Kafka%E5%88%86%E5%8C%BA%E8%AF%B4%E6%98%8E.png" alt="Kafka分区说明"></p>
<p>Kafka 的复制机制既不是完全的同步复制，也不是单纯的异步复制。事实上，同步复制要求所有能工作的 follower 副本都复制完，这条消息才会被确认为已成功提交，这种复制方式极大地影响了性能。而在异步复制方式下，follower副本异步地从leader副本中复制数据，数据只要被leader副本写入就被认为已经成功提交。在这种情况下，如果follower副本都还没有复制完而落后于leader副本，突然leader副本宕机，则会造成数据丢失。Kafka使用的这种<code>ISR的方式则有效地权衡了数据可靠性和性能之间的关系</code>。</p>
<h1 id="Kafka的基础操作"><a href="#Kafka的基础操作" class="headerlink" title="Kafka的基础操作"></a>Kafka的基础操作</h1><h2 id="KafkaServer管理"><a href="#KafkaServer管理" class="headerlink" title="KafkaServer管理"></a>KafkaServer管理</h2><h3 id="单节点启动"><a href="#单节点启动" class="headerlink" title="单节点启动"></a>单节点启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 进入bin目录</span><br><span class="line">kafka-server-start.sh -daemon ../config/server.properties</span><br></pre></td></tr></table></figure>

<p>bin目录下的<code>kafka-server-start.sh</code>即为启动脚本。启动后会在<code>$KAFKA_HOME/logs</code>目录下创建相应的日志文件。</p>
<p><img src="/assets/blogImg/Kafka%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E5%88%86%E7%B1%BB.png" alt="Kafka日志文件分类"></p>
<p>启动完毕后，登录ZooKeeper客户端查看相应节点信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 启动zk客户端</span><br><span class="line">zkCli.sh -server 192.168.56.104:2181</span><br><span class="line">[zk: 192.168.56.104:2181(CONNECTED) 0] get /controller</span><br><span class="line">&#123;"version":1,"brokerid":1,"timestamp":"1581667736716"&#125;</span><br><span class="line">[zk: 192.168.56.104:2181(CONNECTED) 1]</span><br></pre></td></tr></table></figure>

<p>JMX监控开启，需要将<code>JMX_PORT</code>配置添加到KafkaServer启动脚本<code>kafka-server-start.sh</code>文件中，该项监控可以在<code>kafka-manager</code>中看到。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 在启动脚本中首行添加</span><br><span class="line">export JMX_PORT=9999</span><br></pre></td></tr></table></figure>

<p>也可以在启动命令中配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JMX_PORT=9999 kafka-server-start.sh -daemon ../config/server.properties</span><br></pre></td></tr></table></figure>

<h3 id="集群启动"><a href="#集群启动" class="headerlink" title="集群启动"></a>集群启动</h3><p>可以编写个脚本来启动集群中所有节点 <em># $?是指上一次命令执行的成功或者失败的状态。如果成功就是0，失败为1</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> kafka-cluster-start.sh</span><br><span class="line"><span class="meta">#</span> !/bin/bash</span><br><span class="line">brokers="192.168.56.101 192.168.56.102 192.168.56.103"</span><br><span class="line">KAFKA_HOME="/usr/local/kafka_2.13-2.4.0"</span><br><span class="line">echo "INFO: Begin to start kafka cluster..."</span><br><span class="line"></span><br><span class="line">for broker in $brokers</span><br><span class="line">do</span><br><span class="line">    echo "INFO:Start kafka on $&#123;broker&#125;..."</span><br><span class="line">    ssh $broker -C "source /etc/profile; sh $&#123;KAFKA_HOME&#125;/bin/kafka-server-start.sh -daemon $&#123;KAFKA_HOME&#125;/config/server.properties"</span><br><span class="line">    if [ $? -eq 0 ]; then</span><br><span class="line">        echo "INFO:[$&#123;broker&#125;] Start successfully..."</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line">echo "INFO:Kafka cluster starts successfully!"</span><br></pre></td></tr></table></figure>

<h3 id="单节点关闭"><a href="#单节点关闭" class="headerlink" title="单节点关闭"></a>单节点关闭</h3><p>执行<code>bin</code>目录下的<code>kafka-server-stop.sh</code>即可停止kafka。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SIGNAL=$&#123;SIGNAL:-TERM&#125;</span><br><span class="line">PIDS=$(ps ax | grep -i 'kafka\.Kafka' | grep java | grep -v grep | awk '&#123;print $1&#125;')</span><br><span class="line"></span><br><span class="line">if [ -z "$PIDS" ]; then</span><br><span class="line">  echo "No kafka server to stop"</span><br><span class="line">  exit 1</span><br><span class="line">else</span><br><span class="line">  kill -s $SIGNAL $PIDS</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>停止的原理是<code>kill</code> kafka的PID，由于我的kafka-manager和kafka0节点装在一起，所以会连代停止我的kafka-manager。<br>如果想准确的停止kafka，获取PID时可以使用<code>PIDS=$(jps | grep -i &#39;Kafka&#39; | awk &#39;{print $1}&#39;)</code></p>
<h3 id="集群关闭"><a href="#集群关闭" class="headerlink" title="集群关闭"></a>集群关闭</h3><p>与集群启动类似，编写一个调用<code>bin</code>目录下的<code>kafka-server-stop.sh</code>的脚本即可停止。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> kafka-cluster-stop.sh</span><br><span class="line"><span class="meta">#</span> !/bin/bash</span><br><span class="line">brokers="192.168.56.101 192.168.56.102 192.168.56.103"</span><br><span class="line">KAFKA_HOME="/usr/local/kafka_2.13-2.4.0"</span><br><span class="line">echo "INFO: Begin to shut down kafka cluster..."</span><br><span class="line"></span><br><span class="line">for broker in $brokers</span><br><span class="line">do</span><br><span class="line">    echo "INFO:Shut down kafka on $&#123;broker&#125;..."</span><br><span class="line">    ssh $broker -C "$&#123;KAFKA_HOME&#125;/bin/kafka-server-stop.sh"</span><br><span class="line">    if [ $? -eq 0 ]; then</span><br><span class="line">        echo "INFO:[$&#123;broker&#125;] Shut down successfully..."</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line">echo "INFO:Kafka cluster shut down successfully!"</span><br></pre></td></tr></table></figure>

<h2 id="主题管理"><a href="#主题管理" class="headerlink" title="主题管理"></a>主题管理</h2><h3 id="主题创建"><a href="#主题创建" class="headerlink" title="主题创建"></a>主题创建</h3><p>客户端通过执行<code>kafka-topics.sh</code>脚本创建一个主题。若开启了自动创建主题配置项auto.create.topics.enable=true，当生产者向一个还不存在的主题发送消息时，Kafka会自动创建该主题。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 直接输入该脚本的名字可以查看有哪些命令参数</span><br><span class="line">kafka-topics.sh</span><br><span class="line"><span class="meta">#</span> 创建一个名为 kafka-action的主题，该主题拥有2个副本，3个分区</span><br><span class="line">kafka-topics.sh --create --zookeeper 192.168.56.104:2181,192.168.56.105:2181,192.168.56.106:2181 --replication-factor 2 --partitions 3 --topic kafka-action</span><br><span class="line"><span class="meta">#</span> 登录ZooKeeper客户端查看所创建的主题元数据信息</span><br><span class="line">[zk: 192.168.56.104:2181(CONNECTED) 4] ls /brokers/topics/kafka-action/partitions</span><br><span class="line">[0, 1, 2]</span><br><span class="line">[zk: 192.168.56.104:2181(CONNECTED) 5] get /brokers/topics/kafka-action</span><br><span class="line">&#123;"version":2,"partitions":&#123;"0":[1,2],"1":[2,3],"2":[3,1]&#125;,"adding_replicas":&#123;&#125;,"removing_replicas":&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>zookeeper参数是必传参数，用于配置Kafka集群与ZooKeeper连接地址，这里并不要求传递${ zookeeper.connect }配置的所有连接地址。为了容错，建议多个ZooKeeper节点的集群至少传递两个ZooKeeper连接配置，多个配置之间以逗号隔开。</p>
</li>
<li><p>partitions参数用于设置主题分区数，该配置为必传参数。Kafka通过分区分配策略，将一个主题的消息分散到多个分区并分别保存到不同的代理上，以此来提高消息处理的吞吐量。Kafka的生产者和消费者可以采用多线程并行对主题消息进行处理，而每个线程处理的是一个分区的数据，因此分区实际上是Kafka并行处理的基本单位。分区数越多一定程度上会提升消息处理的吞吐量，然而Kafka消息是以追加的形式存储在文件中的，这就意味着分区越多需要打开更多的文件句柄，这样也会带来一定的开销。</p>
</li>
<li><p>replication-factor参数用来设置主题副本数，该配置也是必传参数。副本会被分布在不同的节点上，副本数不能超过节点数，否则创建主题会失败</p>
</li>
</ul>
<p>进入在<code>server.properties</code>中配置的<code>log.dirs=/opt/data/kafka-logs</code>对应的目录下，创建主题后会在<code>${log.dir}</code>目录下创建相应的分区文件目录，副本分别分布在不同的节点上。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 以kafka0节点为例子，查看分区文件</span><br><span class="line">cd /opt/data/kafka-logs</span><br><span class="line">ls -l</span><br><span class="line">drwxr-xr-x 2 root root 4096 Feb 16 04:08 kafka-action-0</span><br><span class="line">drwxr-xr-x 2 root root 4096 Feb 16 04:08 kafka-action-2</span><br><span class="line"></span><br><span class="line">root@kafka0:/opt/data/kafka-logs# cd ./kafka-action-0</span><br><span class="line">root@kafka0:/opt/data/kafka-logs/kafka-action-0# ls -l</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 10485760 Feb 16 04:08 00000000000000000000.index</span><br><span class="line">-rw-r--r-- 1 root root        0 Feb 16 04:08 00000000000000000000.log</span><br><span class="line">-rw-r--r-- 1 root root 10485756 Feb 16 04:08 00000000000000000000.timeindex</span><br><span class="line">-rw-r--r-- 1 root root        8 Feb 16 04:08 leader-epoch-checkpoint</span><br></pre></td></tr></table></figure>

<h3 id="主题删除"><a href="#主题删除" class="headerlink" title="主题删除"></a>主题删除</h3><p>执行kafka-topics.sh脚本进行删除，若希望通过该脚本彻底删除主题，则需要保证在启动Kafka时所加载的<code>server.properties</code>文件中配置<code>delete.topic.enable=true</code>，该配置默认为<code>false</code>。否则执行该脚本并未真正删除主题，而是在ZooKeeper的/admin/delete_topics目录下创建一个与待删除主题同名的节点，将该主题标记为删除状态。主题在<code>${log.dir}</code>目录下对应的分区文件及在ZooKeeper中的相应节点并未被删除，这个时候需要你手动删除。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --delete --zookeeper 192.168.56.104:2181,192.168.56.105:2181,192.168.56.106:2181 --topic kafka-action</span><br></pre></td></tr></table></figure>

<p>直接执行的话，用zk客户端去看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: 192.168.56.104:2181(CONNECTED) 8] ls /admin/delete_topics</span><br><span class="line">[kafka-action]</span><br></pre></td></tr></table></figure>

<h3 id="查看主题"><a href="#查看主题" class="headerlink" title="查看主题"></a>查看主题</h3><ul>
<li><p>查看该集群下所有主题</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --list --zookeeper 192.168.56.104:2181,192.168.56.105:2181,192.168.56.106:2181</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看特定主题的信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --topic kafka-action --describe --zookeeper 192.168.56.104:2181,192.168.56.105:2181,192.168.56.106:2181</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="查看消息"><a href="#查看消息" class="headerlink" title="查看消息"></a>查看消息</h3><p>Kafka生产的消息以二进制的形式存在文件中，Kafka提供了一个查看日志文件的工具类<code>kafka.tools.DumpLogSegments</code>。通过<code>kafka-run-class.sh</code>脚本，可以直接在终端运行该工具类</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 查看kafka-action-test主题下的消息内容</span><br><span class="line">kafka-run-class.sh kafka.tools.DumpLogSegments --files /opt/data/kafka-logs/kafka-action-test-1/00000000000000000000.log</span><br></pre></td></tr></table></figure>

<h2 id="生产者-1"><a href="#生产者-1" class="headerlink" title="生产者"></a>生产者</h2><h3 id="启动生产者"><a href="#启动生产者" class="headerlink" title="启动生产者"></a>启动生产者</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> broker-list 指定Kafka的代理地址列表 topic 指定消息被发送的目标主题 key.separator 指定key 和 消息之间的分隔符</span><br><span class="line">kafka-console-producer.sh --broker-list 192.168.56.101:9092,192.168.56.102:9092,192.168.56.103:9092 --topic kafka-action-test --property parse.key=true --property key.separator=' '</span><br></pre></td></tr></table></figure>

<h3 id="生产者性能测试"><a href="#生产者性能测试" class="headerlink" title="生产者性能测试"></a>生产者性能测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-producer-perf-test.sh --num-records 10000 --record-size 1000 --topic kafka-action-test --throughput 10000 --producer-props bootstrap.servers=192.168.56.101:9092,192.168.56.102:9092,192.168.56.103:9092</span><br></pre></td></tr></table></figure>

<p><code>kafka-producer-perf-test.sh</code>脚本调用的是org.apache.kafka.tools.ProducerPerformance类</p>
<ul>
<li>topic  指定了生产者发送消息的目标主题</li>
<li>num-records 测试时发送消息的总条数</li>
<li>record-size 每条消息的字节数</li>
<li>throughput 限流控制 throughput值小于0时则不进行限流；若该参数值大于0时，当已发送的消息总字节数与当前已执行的时间取整大于该字段时生产者线程会被阻塞一段时间。生产者线程被阻塞时，在控制台可以看到输出一行吞吐量统计信息；若该参数值等于0时，则生产者在发送一次消息之后检测满足阻塞条件时将会一直被阻塞。</li>
</ul>
<p>上述命令执行结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10000 records sent, 4618.937644 records/sec (4.40 MB/sec), 895.99 ms avg latency, 1232.00 ms max latency, 940 ms 50th, 1199 ms 95th, 1220 ms 99th, 1232 ms 99.9th.</span><br></pre></td></tr></table></figure>

<ul>
<li>recores send 测试时发送的消息总数</li>
<li>records/sec 每秒发送的消息数 - 吞吐量</li>
<li>avg latency 消息处理的平均耗时 ms</li>
<li>max latency 消息处理的最大耗时 ms</li>
<li>X th %Xd的消息处理耗时</li>
</ul>
<h2 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h2><p>Kafka采用了消费组的模式，每个消费者都属于某一个消费组，在创建消费者时，若不指定消费者的groupId，则该消费者属于默认消费组。消费组是一个全局的概念，因此在设置group.id时，要确保该值在Kafka集群中唯一。同一个消费组下的各消费者在消费消息时是互斥的，也就是说，对于一条消息而言，就同一个消费组下的消费者来讲，只能被同组下的某一个消费者消费，但不同消费组的消费者能消费同一条消息。</p>
<h3 id="启动消费者"><a href="#启动消费者" class="headerlink" title="启动消费者"></a>启动消费者</h3><p><code>kafka-console-consumer.sh</code>脚本调用的是Kafka core工程下kafka.tools包下的ConsoleConsumer对象，该对象调用（org.apache.kafka.clients.consumer.KafkaConsumer）消费消息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-console-consumer.sh --bootstrap-server 192.168.56.101:9092,192.168.56.102:9092,192.168.56.103:9092 --consumer-property group.id=consumer-test --topic kafka-action-test --from-beginning</span><br></pre></td></tr></table></figure>

<h3 id="查看消费者组的信息"><a href="#查看消费者组的信息" class="headerlink" title="查看消费者组的信息"></a>查看消费者组的信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 查看所有消费者组</span><br><span class="line">kafka-consumer-groups.sh --bootstrap-server 192.168.56.101:9092,192.168.56.102:9092,192.168.56.103:9092 --list</span><br><span class="line"><span class="meta">#</span> 查看指定消费者组信息</span><br><span class="line">kafka-consumer-groups.sh --bootstrap-server 192.168.56.101:9092,192.168.56.102:9092,192.168.56.103:9092 --describe --group hello</span><br><span class="line"><span class="meta">#</span> 删除指定消费者组</span><br><span class="line">kafka-consumer-groups.sh --bootstrap-server 192.168.56.101:9092,192.168.56.102:9092,192.168.56.103:9092 --delete --group hello</span><br></pre></td></tr></table></figure>

<p><img src="/assets/blogImg/Kafka%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84%E6%93%8D%E4%BD%9C.png" alt="Kafka消费者组操作"></p>
<h3 id="消费者性能测试工具"><a href="#消费者性能测试工具" class="headerlink" title="消费者性能测试工具"></a>消费者性能测试工具</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-consumer-perf-test.sh --broker-list 192.168.56.101:9092,192.168.56.102:9092,192.168.56.103:9092 --threads 5 --messages 10000 --socket-buffer-size 10000 --num-fetch-threads 2 --group consumer-perf-test --topic kafka-action-test</span><br></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start.time, end.time, data.consumed.in.MB, MB.sec, data.consumed.in.nMsg, nMsg.sec, rebalance.time.ms, fetch.time.ms, fetch.MB.sec, fetch.nMsg.sec</span><br><span class="line">2020-02-20 16:07:33:457, 2020-02-20 16:07:34:668, 9.5369, 7.8752, 10029, 8281.5855, 1582214853971, -1582214852760, -0.0000, -0.0000</span><br></pre></td></tr></table></figure>

<h1 id="Kafka的源码编译"><a href="#Kafka的源码编译" class="headerlink" title="Kafka的源码编译"></a>Kafka的源码编译</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="安装Scala"><a href="#安装Scala" class="headerlink" title="安装Scala"></a>安装Scala</h3><p>Windows环境下，下载并安装Scala。先进入Scala官方网站<a href="http://www.scala-lang.org/download/" target="_blank" rel="noopener">这里</a>下载相应的安装包并安装。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 查询Scala版本</span><br><span class="line">scala -version</span><br></pre></td></tr></table></figure>

<h3 id="安装Gradle"><a href="#安装Gradle" class="headerlink" title="安装Gradle"></a>安装Gradle</h3><p>进入Gradle官方网站<a href="https://gradle.org/releases/" target="_blank" rel="noopener">这里</a>下载Gradle安装包。将下载好的<code>gradle-6.1.1-bin</code>解压后，配置<code>GRADLE_HOME</code>以及<code>%GRADLE_HOME%\bin</code>到环境变量。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 查询gradle版本</span><br><span class="line">gradle -version</span><br></pre></td></tr></table></figure>

<h3 id="Kafka源码编译"><a href="#Kafka源码编译" class="headerlink" title="Kafka源码编译"></a>Kafka源码编译</h3><p>先进入<a href="http://kafka.apache.org/downloads.html" target="_blank" rel="noopener">这里</a>下载Kafka src 源码文件。进入源码根目录，执行<code>gradle idea</code>。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Docker/" rel="tag"><i class="fa fa-tag"></i> Docker</a>
          
            <a href="/tags/Kafka/" rel="tag"><i class="fa fa-tag"></i> Kafka</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/02/05/Spring的循环依赖/" rel="next" title="Spring循环依赖三级缓存解析">
                <i class="fa fa-chevron-left"></i> Spring循环依赖三级缓存解析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/03/09/JAVA基础知识-NIO/" rel="prev" title="JAVA基础知识-NIO">
                JAVA基础知识-NIO <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">LEEZY</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">34</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">21</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="/string.zhengyang@gmail.com" title="E-Mail &rarr; string.zhengyang@gmail.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Kafka的安装配置"><span class="nav-number">1.</span> <span class="nav-text">Kafka的安装配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Ubuntu服务器环境下Kafka安装与配置"><span class="nav-number">1.1.</span> <span class="nav-text">Ubuntu服务器环境下Kafka安装与配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Zookeeper安装与配置-standalone模式"><span class="nav-number">1.1.1.</span> <span class="nav-text">Zookeeper安装与配置 - standalone模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zookeeper安装与配置-集群模式"><span class="nav-number">1.1.2.</span> <span class="nav-text">Zookeeper安装与配置 - 集群模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kafka安装与配置-单机模式"><span class="nav-number">1.1.3.</span> <span class="nav-text">Kafka安装与配置 - 单机模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kafka安装与配置-集群模式"><span class="nav-number">1.1.4.</span> <span class="nav-text">Kafka安装与配置 - 集群模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker环境安装与配置"><span class="nav-number">1.2.</span> <span class="nav-text">Docker环境安装与配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#镜像下载"><span class="nav-number">1.2.1.</span> <span class="nav-text">镜像下载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zookeeper容器启动"><span class="nav-number">1.2.2.</span> <span class="nav-text">zookeeper容器启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kafka容器启动"><span class="nav-number">1.2.3.</span> <span class="nav-text">kafka容器启动</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#单节点部署"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">单节点部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Kafka伪分布式环境部署"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">Kafka伪分布式环境部署</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kafka-Manager安装"><span class="nav-number">1.3.</span> <span class="nav-text">Kafka Manager安装</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kafka概念说明"><span class="nav-number">2.</span> <span class="nav-text">Kafka概念说明</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#基础概念"><span class="nav-number">2.1.</span> <span class="nav-text">基础概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#生产者"><span class="nav-number">2.1.1.</span> <span class="nav-text">生产者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消费者-与-消费组"><span class="nav-number">2.1.2.</span> <span class="nav-text">消费者 与 消费组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#broker-代理"><span class="nav-number">2.1.3.</span> <span class="nav-text">broker - 代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#topic-主题-partition-分区-以及-Replica-副本"><span class="nav-number">2.1.4.</span> <span class="nav-text">topic - 主题 partition - 分区 以及 Replica - 副本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志段"><span class="nav-number">2.1.5.</span> <span class="nav-text">日志段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ISR"><span class="nav-number">2.1.6.</span> <span class="nav-text">ISR</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kafka的基础操作"><span class="nav-number">3.</span> <span class="nav-text">Kafka的基础操作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#KafkaServer管理"><span class="nav-number">3.1.</span> <span class="nav-text">KafkaServer管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#单节点启动"><span class="nav-number">3.1.1.</span> <span class="nav-text">单节点启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群启动"><span class="nav-number">3.1.2.</span> <span class="nav-text">集群启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#单节点关闭"><span class="nav-number">3.1.3.</span> <span class="nav-text">单节点关闭</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群关闭"><span class="nav-number">3.1.4.</span> <span class="nav-text">集群关闭</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#主题管理"><span class="nav-number">3.2.</span> <span class="nav-text">主题管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#主题创建"><span class="nav-number">3.2.1.</span> <span class="nav-text">主题创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主题删除"><span class="nav-number">3.2.2.</span> <span class="nav-text">主题删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看主题"><span class="nav-number">3.2.3.</span> <span class="nav-text">查看主题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看消息"><span class="nav-number">3.2.4.</span> <span class="nav-text">查看消息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生产者-1"><span class="nav-number">3.3.</span> <span class="nav-text">生产者</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动生产者"><span class="nav-number">3.3.1.</span> <span class="nav-text">启动生产者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生产者性能测试"><span class="nav-number">3.3.2.</span> <span class="nav-text">生产者性能测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消费者"><span class="nav-number">3.4.</span> <span class="nav-text">消费者</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动消费者"><span class="nav-number">3.4.1.</span> <span class="nav-text">启动消费者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看消费者组的信息"><span class="nav-number">3.4.2.</span> <span class="nav-text">查看消费者组的信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消费者性能测试工具"><span class="nav-number">3.4.3.</span> <span class="nav-text">消费者性能测试工具</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kafka的源码编译"><span class="nav-number">4.</span> <span class="nav-text">Kafka的源码编译</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#环境搭建"><span class="nav-number">4.1.</span> <span class="nav-text">环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装Scala"><span class="nav-number">4.1.1.</span> <span class="nav-text">安装Scala</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装Gradle"><span class="nav-number">4.1.2.</span> <span class="nav-text">安装Gradle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kafka源码编译"><span class="nav-number">4.1.3.</span> <span class="nav-text">Kafka源码编译</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LEEZY</span>

  

  
</div>


  <div class="powered-by">由 <a href="#" class="theme-link">Hexo</a> 强力驱动 </div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="#" class="theme-link">NexT.Mist</a> </div>





  <span class="post-meta-divider">|</span>


<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共60.5k字</span>
</div></div>
        








        
      </footer></div>
    

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
      <div>
        <!-- Go to www.addthis.com/dashboard to customize your tools -->
<div class="addthis_inline_share_toolbox">
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c1ba94c46868e3e" async="async"></script>
</div>

      </div>
    
  

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script src="/js/src/utils.js?v=6.6.0"></script>

  <script src="/js/src/motion.js?v=6.6.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.6.0"></script>
<script src="/js/src/post-details.js?v=6.6.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>

  <script>
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'tdvMb2E4CfK077KFm5aDvXV7-gzGzoHsz',
        appKey: 'wPLAP3mIpwojzLkmbeiNMEoP',
        placeholder: 'Just go go',
        avatar:'identicon',
        meta:guest,
        pageSize:'10' || 10,
        visitor: false
    });
  </script>




  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script>
    
    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function ({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text(counter.time + 1);
            
            Counter('put', `/classes/Counter/${counter.objectId}`, JSON.stringify({ time: { "__op":"Increment", "amount":1 } }))
            
            .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
            })
          } else {
            
              Counter('post', '/classes/Counter', JSON.stringify({ title: title, url: url, time: 1}))
                .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(1);
                })
                .fail(function () {
                  console.log('Failed to create');
                });
            
          }
        })
      .fail(function ({ responseJSON }) {
        console.log('LeanCloud Counter Error:' + responseJSON.code + " " + responseJSON.error);
      });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "tdvMb2E4CfK077KFm5aDvXV7-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "tdvMb2E4CfK077KFm5aDvXV7-gzGzoHsz",
                'X-LC-Key': "wPLAP3mIpwojzLkmbeiNMEoP",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          addCount(Counter);
          
        })
    });
  </script>



  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>
