<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">



























<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png?v=6.6.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.6.0" color="#222">









<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.6.0',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="もう一回もう一回行こうぜ 僕らの声 アイムアルーザー ずっと前から聞こえてた">
<meta name="keywords" content="Python">
<meta property="og:type" content="article">
<meta property="og:title" content="データとの絆">
<meta property="og:url" content="https://www.leezy.top/2019/08/15/THE_DATA_ANALYSIS/index.html">
<meta property="og:site_name" content="SAKURA">
<meta property="og:description" content="もう一回もう一回行こうぜ 僕らの声 アイムアルーザー ずっと前から聞こえてた">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://www.leezy.top/assets/blogImg/OUTPUT_FEATURE.png">
<meta property="og:image" content="https://www.leezy.top/assets/blogImg/OUTPUT_CUST_INFO.png">
<meta property="og:image" content="https://www.leezy.top/assets/blogImg/OUTPUT_BOEING.png">
<meta property="og:image" content="https://www.leezy.top/assets/blogImg/OUTPUT_IMPORTANCES.png">
<meta property="og:image" content="https://www.leezy.top/assets/blogImg/OUTPUT_HEATMAP.png">
<meta property="og:image" content="https://www.leezy.top/assets/blogImg/OUTPUT_COUNTPLOT.png">
<meta property="og:image" content="https://www.leezy.top/assets/blogImg/OUTPUT_HIST.png">
<meta property="og:updated_time" content="2019-09-18T12:12:30.743Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="データとの絆">
<meta name="twitter:description" content="もう一回もう一回行こうぜ 僕らの声 アイムアルーザー ずっと前から聞こえてた">
<meta name="twitter:image" content="https://www.leezy.top/assets/blogImg/OUTPUT_FEATURE.png">



  <link rel="alternate" href="/atom.xml" title="SAKURA" type="application/atom+xml">




  <link rel="canonical" href="https://www.leezy.top/2019/08/15/THE_DATA_ANALYSIS/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>データとの絆 | SAKURA</title>
  












  <noscript>
  <style>
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion .logo-line-before i { left: initial; }
    .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">SAKURA</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.leezy.top/2019/08/15/THE_DATA_ANALYSIS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LEEZY">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SAKURA">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">データとの絆

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-15 19:56:02" itemprop="dateCreated datePublished" datetime="2019-08-15T19:56:02+08:00">2019-08-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-09-18 20:12:30" itemprop="dateModified" datetime="2019-09-18T20:12:30+08:00">2019-09-18</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/15/THE_DATA_ANALYSIS/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2019/08/15/THE_DATA_ANALYSIS/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/08/15/THE_DATA_ANALYSIS/" class="leancloud_visitors" data-flag-title="データとの絆">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>もう一回もう一回行こうぜ 僕らの声</p>
<p>アイムアルーザー ずっと前から聞こえてた</p>
<a id="more"></a>


<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">init_woody</span><br></pre></td></tr></table></figure>

<pre><code>Matplotlib env init complete.
Warnings off.</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不省略行的查看数据</span></span><br><span class="line">pd.set_option(<span class="string">'display.max_columns'</span>, <span class="number">200</span>)</span><br></pre></td></tr></table></figure>

<h3 id="数据源准备"><a href="#数据源准备" class="headerlink" title="数据源准备"></a>数据源准备</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入train数据</span></span><br><span class="line">train_idv_td = pd.read_csv(<span class="string">"../data/2/train/IDV_TD.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 个人定期存款账户信息（IDV_TD）</span></span><br><span class="line">train_idv_dpsa = pd.read_csv(<span class="string">"../data/2/train/IDV_DPSA.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 个人活期存款账户信息（IDV_DPSA）</span></span><br><span class="line">train_loan = pd.read_csv(<span class="string">"../data/2/train/LOAN.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 贷款账户信息（LOAN）</span></span><br><span class="line">train_bond = pd.read_csv(<span class="string">"../data/2/train/BOND.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 国债账户信息（BOND）</span></span><br><span class="line">train_fund = pd.read_csv(<span class="string">"../data/2/train/FUND.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 基金账户信息（FUND）</span></span><br><span class="line">train_prec_metal = pd.read_csv(<span class="string">"../data/2/train/PREC_METAL.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 贵金属账户信息（PREC_METAL）</span></span><br><span class="line">train_aget_insr = pd.read_csv(<span class="string">"../data/2/train/AGET_INSR.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 代理保险账户信息（AGET_INSR）</span></span><br><span class="line">train_thr_pty_cstd = pd.read_csv(<span class="string">"../data/2/train/THR_PTY_CSTD.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 第三方存管账户信息（THR_PTY_CSTD）</span></span><br><span class="line">train_idv_cust_basic = pd.read_csv(<span class="string">"../data/2/train/IDV_CUST_BASIC.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 个人客户基本信息（IDV_CUST_BASIC）</span></span><br><span class="line">train_tr_dc = pd.read_csv(<span class="string">"../data/2/train/TR_DC.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 交易信息（TR_DC）</span></span><br><span class="line">train_base_excg = pd.read_csv(<span class="string">"../data/2/train/BASE_EXCG.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 汇率表（BASE_EXCG）</span></span><br><span class="line">train_cust_result = pd.read_csv(<span class="string">"../data/2/train/CUST_RESULT.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 客户标记（CUST_RESULT）</span></span><br><span class="line"><span class="comment"># A榜</span></span><br><span class="line"><span class="comment"># BASE_EXCG.csv 无</span></span><br><span class="line">A_idv_td = pd.read_csv(<span class="string">"../data/2/A/IDV_TD.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">A_idv_dpsa = pd.read_csv(<span class="string">"../data/2/A/IDV_DPSA.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">A_loan = pd.read_csv(<span class="string">"../data/2/A/LOAN.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">A_bond = pd.read_csv(<span class="string">"../data/2/A/BOND.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">A_fund = pd.read_csv(<span class="string">"../data/2/A/FUND.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">A_prec_metal = pd.read_csv(<span class="string">"../data/2/A/PREC_METAL.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">A_aget_insr = pd.read_csv(<span class="string">"../data/2/A/AGET_INSR.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">A_thr_pty_cstd = pd.read_csv(<span class="string">"../data/2/A/THR_PTY_CSTD.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">A_idv_cust_basic = pd.read_csv(<span class="string">"../data/2/A/IDV_CUST_BASIC.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">A_tr_dc = pd.read_csv(<span class="string">"../data/2/A/TR_DC.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">A_customid = pd.read_csv(<span class="string">"../data/2/A/CUSTOMID.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="comment"># B榜</span></span><br><span class="line">B_idv_td = pd.read_csv(<span class="string">"../data/2/B/IDV_TD.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">B_idv_dpsa = pd.read_csv(<span class="string">"../data/2/B/IDV_DPSA.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">B_loan = pd.read_csv(<span class="string">"../data/2/B/LOAN.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">B_bond = pd.read_csv(<span class="string">"../data/2/B/BOND.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">B_fund = pd.read_csv(<span class="string">"../data/2/B/FUND.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">B_prec_metal = pd.read_csv(<span class="string">"../data/2/B/PREC_METAL.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">B_aget_insr = pd.read_csv(<span class="string">"../data/2/B/AGET_INSR.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">B_thr_pty_cstd = pd.read_csv(<span class="string">"../data/2/B/THR_PTY_CSTD.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">B_idv_cust_basic = pd.read_csv(<span class="string">"../data/2/B/IDV_CUST_BASIC.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">B_tr_dc = pd.read_csv(<span class="string">"../data/2/B/TR_DC.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">B_customid = pd.read_csv(<span class="string">"../data/2/B/CUSTOMID.csv"</span>, encoding=<span class="string">'utf-8'</span>)</span><br></pre></td></tr></table></figure>

<pre><code>/root/anaconda3/lib/python3.6/site-packages/IPython/core/interactiveshell.py:2728: DtypeWarning: Columns (12) have mixed types. Specify dtype option on import or set low_memory=False.
  interactivity=interactivity, compiler=compiler, result=result)</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把汇率表中的CCY_LETE_CD字段转化为CCY_CD字段</span></span><br><span class="line">train_base_excg = pd.read_csv(<span class="string">"../data/2/train/BASE_EXCG.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 汇率表（BASE_EXCG）</span></span><br><span class="line">train_base_excg[<span class="string">'CCY_CD'</span>] = train_base_excg[<span class="string">'CCY_LETE_CD'</span>]</span><br><span class="line">train_base_excg = train_base_excg.drop([<span class="string">'CCY_LETE_CD'</span>], axis=<span class="number">1</span>)</span><br><span class="line">train_base_excg[<span class="string">'RMB_MID_PRIC'</span>].apply(<span class="keyword">lambda</span> x: float(x))</span><br><span class="line"><span class="comment"># 把汇率表中的CCY_LETE_CD字段转化为CCY_CD字段</span></span><br><span class="line">train_tr_dc[<span class="string">'TR_DAT'</span>].apply(<span class="keyword">lambda</span> x: int(x))</span><br></pre></td></tr></table></figure>

<h3 id="公用函数"><a href="#公用函数" class="headerlink" title="公用函数"></a>公用函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 按汇率计算价值（传入2个参数返回计算结果）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compute_REAL_MONEY</span><span class="params">(train_IDV_DPSA_SAMPLE, A, B)</span>:</span></span><br><span class="line">    NEED = train_IDV_DPSA_SAMPLE[A]</span><br><span class="line">    RMB_MID_PRIC = train_IDV_DPSA_SAMPLE[B]</span><br><span class="line">    <span class="keyword">return</span> NEED * float(RMB_MID_PRIC)</span><br><span class="line"></span><br><span class="line"><span class="comment"># one-hot 处理函数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地评价</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">evaluate</span><span class="params">(test_y, y_pred)</span>:</span></span><br><span class="line">    <span class="keyword">from</span> sklearn <span class="keyword">import</span> metrics</span><br><span class="line">    test_pct_1 = test_y.sum()/test_y.shape[<span class="number">0</span>]</span><br><span class="line">    pred_pct_1 = y_pred.sum()/y_pred.shape[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    roc_auc = metrics.roc_auc_score(test_y,y_pred)</span><br><span class="line">    acc = metrics.accuracy_score(test_y,y_pred)</span><br><span class="line">    Recall = metrics.recall_score(test_y,y_pred)</span><br><span class="line">    F1 = metrics.f1_score(test_y,y_pred)</span><br><span class="line">    Precision = metrics.precision_score(test_y,y_pred)</span><br><span class="line">    Confusion = metrics.confusion_matrix(test_y,y_pred)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'test_pct_1: %.4f'</span> %  test_pct_1)</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'pred_pct_1: %.4f'</span> %  pred_pct_1)</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'Precesion: %.4f'</span> % Precision)</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'Recall: %.4f'</span> %  Recall)</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'F1-score: %.4f'</span> % F1)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'confusion matrix:'</span>)</span><br><span class="line">    <span class="keyword">print</span> (metrics.confusion_matrix(test_y,y_pred))</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'test_pct_1'</span>:test_pct_1,<span class="string">'pred_pct_1'</span>:pred_pct_1,<span class="string">'roc_auc'</span>:roc_auc,<span class="string">'acc'</span>:acc,<span class="string">'recall'</span>:Recall,<span class="string">'F1'</span>:F1,<span class="string">'Precision'</span>:Precision,<span class="string">'Confusuion'</span>:Confusion&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">feature_rank</span><span class="params">(model,num)</span>:</span></span><br><span class="line">    <span class="comment">##计算特征得分</span></span><br><span class="line">    feature_score = model.get_fscore()</span><br><span class="line">    df_feature_score = pd.DataFrame(&#123;<span class="string">"feature_name"</span>:list(feature_score.keys()),<span class="string">"feature_score"</span>:list(feature_score.values())&#125;)</span><br><span class="line">    df_feature_score_sort = df_feature_score.sort_values(ascending=<span class="number">0</span>,by=[<span class="string">'feature_score'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">#result_name = "feature_score_1_A_%s_%s_%s_%6f.csv"%(time_str,feature_num,train_steps,F1_score)</span></span><br><span class="line">    <span class="comment">#result_name_full = datas_dir_e + "out/" + result_name</span></span><br><span class="line">    <span class="comment">#df_feature_score_sort.to_csv(result_name_full,index=None)</span></span><br><span class="line">    <span class="keyword">return</span> df_feature_score_sort.head(num)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stat_df</span><span class="params">(df)</span>:</span></span><br><span class="line">    stats = []</span><br><span class="line">    <span class="keyword">for</span> col <span class="keyword">in</span> df.columns:</span><br><span class="line">        stats.append((col, df[col].nunique(),df[col].isnull().sum()*<span class="number">100</span>/df.shape[<span class="number">0</span>],</span><br><span class="line">                     df[col].value_counts(normalize=<span class="keyword">True</span>,dropna=<span class="keyword">False</span>).values[<span class="number">0</span>]*<span class="number">100</span>,df[col].dtype))</span><br><span class="line">    stats_df = pd.DataFrame(stats, columns=[<span class="string">'特征'</span>,<span class="string">'唯一数数量'</span>,<span class="string">'缺失值占比'</span>,<span class="string">'最多数占比'</span>,<span class="string">'类型'</span>])</span><br><span class="line">    stats_df.sort_values(<span class="string">'缺失值占比'</span>,ascending=<span class="keyword">False</span>)</span><br><span class="line">    <span class="keyword">return</span> stats_df</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_feature_distribution</span><span class="params">(df1,df2,label1,label2,features,width=<span class="number">6</span>,height=<span class="number">6</span>)</span>:</span></span><br><span class="line">    i=<span class="number">0</span></span><br><span class="line">    sns.set_style(<span class="string">'whitegrid'</span>)</span><br><span class="line">    plt.figure()</span><br><span class="line">    fig,ax = plt.subplots(width,height,figsize=(<span class="number">20</span>,<span class="number">12</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> feature <span class="keyword">in</span> features:</span><br><span class="line">        i+=<span class="number">1</span></span><br><span class="line">        plt.subplot(width,height,i)</span><br><span class="line">        sns.kdeplot(df1[feature],bw=<span class="number">0.5</span>,label=label1)</span><br><span class="line">        sns.kdeplot(df2[feature],bw=<span class="number">0.5</span>,label=label2)</span><br><span class="line">        plt.xlabel(feature,fontsize=<span class="number">9</span>)</span><br><span class="line">        locs, labels = plt.xticks()</span><br><span class="line">        plt.tick_params(axis=<span class="string">'x'</span>,which=<span class="string">'major'</span>,labelsize=<span class="number">6</span>,pad=<span class="number">-6</span>)</span><br><span class="line">        plt.tick_params(axis=<span class="string">'y'</span>,which=<span class="string">'major'</span>,labelsize=<span class="number">6</span>)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>

<h3 id="特征工程"><a href="#特征工程" class="headerlink" title="特征工程"></a>特征工程</h3><h4 id="个人客户基本信息表-IDV-CUST-BASIC-处理"><a href="#个人客户基本信息表-IDV-CUST-BASIC-处理" class="headerlink" title="个人客户基本信息表(IDV_CUST_BASIC) - 处理"></a>个人客户基本信息表(IDV_CUST_BASIC) - 处理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除没用的字段</span></span><br><span class="line">train_idv_cust_basic_SAMPLE = train_idv_cust_basic.drop([<span class="string">'DATA_DAT'</span>, <span class="string">'PROV_CD'</span>, <span class="string">'CUST_SEX_CD'</span>, <span class="string">'RES_CD'</span>, <span class="string">'RES_STA_CD'</span>, <span class="string">'NATY_CD'</span>,</span><br><span class="line">       <span class="string">'NATN_CD'</span>, <span class="string">'CULT_DGR_CD'</span>, <span class="string">'DGR_CD'</span>, <span class="string">'PLC_STS_CD'</span>, <span class="string">'PRFN'</span>, <span class="string">'ADMI_POS_CD'</span>,</span><br><span class="line">       <span class="string">'SPEC_TECH_PRFN_QUA_CD'</span>, <span class="string">'TITLE_RANK_CD'</span>, <span class="string">'WORK_TYP_CD'</span>, <span class="string">'GC_BRTH'</span>,</span><br><span class="line">       <span class="string">'UNIT_PROP_CD'</span>, <span class="string">'WORK_YEAR'</span>, <span class="string">'OCP_CD'</span>], axis=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 将个人客户基本信息表与结果整合</span></span><br><span class="line">train_idv_cust_basic_SAMPLE = pd.merge(train_idv_cust_basic_SAMPLE, train_cust_result, on=<span class="string">'CUST_NO'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">features = [x <span class="keyword">for</span> x <span class="keyword">in</span> train_idv_cust_basic_SAMPLE.columns <span class="keyword">if</span> x <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">'CUST_NO'</span>,<span class="string">'FLAG'</span>]]</span><br><span class="line">df0 = train_idv_cust_basic_SAMPLE[train_idv_cust_basic_SAMPLE.FLAG==<span class="number">0</span>]</span><br><span class="line">df1 = train_idv_cust_basic_SAMPLE[train_idv_cust_basic_SAMPLE.FLAG==<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">plot_feature_distribution(df0,df1,<span class="string">'0'</span>,<span class="string">'1'</span>,features,<span class="number">2</span>,<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<pre><code>/root/anaconda3/lib/python3.6/site-packages/statsmodels/nonparametric/kde.py:454: RuntimeWarning: invalid value encountered in greater
  X = X[np.logical_and(X&gt;clip[0], X&lt;clip[1])] # won&apos;t work for two columns.
/root/anaconda3/lib/python3.6/site-packages/statsmodels/nonparametric/kde.py:454: RuntimeWarning: invalid value encountered in less
  X = X[np.logical_and(X&gt;clip[0], X&lt;clip[1])] # won&apos;t work for two columns.



&lt;matplotlib.figure.Figure at 0x7f0167e93dd8&gt;</code></pre><p><img src="/assets/blogImg/OUTPUT_FEATURE.png" alt="FEATURE"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 声明函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">IDV_CUST_BASIC_PARSE</span><span class="params">(dataset_IDV_CUST_BASIC)</span>:</span></span><br><span class="line">    <span class="comment"># 删除个人用户信息表中无关元素</span></span><br><span class="line">    dataset_IDV_CUST_BASIC = dataset_IDV_CUST_BASIC.drop([<span class="string">'DATA_DAT'</span>, <span class="string">'PROV_CD'</span>, <span class="string">'CUST_SEX_CD'</span>, <span class="string">'RES_CD'</span>, <span class="string">'RES_STA_CD'</span>, <span class="string">'NATY_CD'</span>,</span><br><span class="line">       <span class="string">'NATN_CD'</span>, <span class="string">'CULT_DGR_CD'</span>, <span class="string">'DGR_CD'</span>, <span class="string">'PLC_STS_CD'</span>, <span class="string">'PRFN'</span>, <span class="string">'ADMI_POS_CD'</span>,</span><br><span class="line">       <span class="string">'SPEC_TECH_PRFN_QUA_CD'</span>, <span class="string">'TITLE_RANK_CD'</span>, <span class="string">'WORK_TYP_CD'</span>, <span class="string">'GC_BRTH'</span>,</span><br><span class="line">       <span class="string">'UNIT_PROP_CD'</span>, <span class="string">'WORK_YEAR'</span>, <span class="string">'OCP_CD'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> dataset_IDV_CUST_BASIC</span><br></pre></td></tr></table></figure>

<h4 id="个人定期存款账户信息（IDV-TD）-处理"><a href="#个人定期存款账户信息（IDV-TD）-处理" class="headerlink" title="个人定期存款账户信息（IDV_TD）- 处理"></a>个人定期存款账户信息（IDV_TD）- 处理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看数据比例</span></span><br><span class="line">stat_df(train_idv_td)</span><br></pre></td></tr></table></figure>

<p><img src="/assets/blogImg/OUTPUT_CUST_INFO.png" alt="客户表信息情况"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编成函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">IDV_TD_PARSE</span><span class="params">(dataset_IDV_TD)</span>:</span></span><br><span class="line">    train_idv_td_3 = dataset_IDV_TD[dataset_IDV_TD[<span class="string">'DATA_DAT'</span>]==<span class="number">3734035200</span>]</span><br><span class="line">    <span class="comment"># 简化IDV_TD表</span></span><br><span class="line">    train_idv_td_3 = train_idv_td_3.drop([<span class="string">'DATA_DAT'</span>, <span class="string">'ARG_CRT_DAT'</span>, <span class="string">'DATA_DAT'</span>, <span class="string">'CLS_ACCT_DAT'</span>, <span class="string">'MATU_DAT'</span>, <span class="string">'LAC'</span>, <span class="string">'ACCT_STS_CD'</span>,<span class="string">'DP_DAY_CD'</span>, <span class="string">'RDEP_IND_CD'</span>, <span class="string">'RDEP_DP_DAY_CD'</span>, <span class="string">'RAT_CTG'</span>,<span class="string">'FXDI_SA_ACCM'</span>, <span class="string">'MTH_ACT_DAYS_TOT'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 去重</span></span><br><span class="line">    train_idv_td_3.drop_duplicates(subset=<span class="keyword">None</span>, keep=<span class="string">'first'</span>, inplace=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># 将train_idv_td和train_base_excg合并</span></span><br><span class="line">    train_IDV_TD_SAMPLE_3 = pd.merge(train_idv_td_3, train_base_excg, on = <span class="string">'CCY_CD'</span>)</span><br><span class="line">    <span class="comment"># 执行汇率计算函数</span></span><br><span class="line">    train_IDV_TD_SAMPLE_3[<span class="string">'CRBAL'</span>] = train_IDV_TD_SAMPLE_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'CRBAL'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_IDV_TD_SAMPLE_3[<span class="string">'REG_CAP'</span>] = train_IDV_TD_SAMPLE_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'REG_CAP'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_IDV_TD_SAMPLE_3[<span class="string">'FXDI_T_ACCM'</span>] = train_IDV_TD_SAMPLE_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'FXDI_T_ACCM'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_IDV_TD_SAMPLE_3[<span class="string">'TDOP_SHD_PAY_INTS'</span>] = train_IDV_TD_SAMPLE_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'TDOP_SHD_PAY_INTS'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_IDV_TD_SAMPLE_3[<span class="string">'MOTH_CR_ACCM'</span>] = train_IDV_TD_SAMPLE_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'MOTH_CR_ACCM'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_IDV_TD_SAMPLE_3[<span class="string">'IDV_TD_SUM'</span>] = train_IDV_TD_SAMPLE_3[<span class="string">'TDOP_SHD_PAY_INTS'</span>] +  train_IDV_TD_SAMPLE_3[<span class="string">'REG_CAP'</span>]</span><br><span class="line">    <span class="comment"># 再次精简表</span></span><br><span class="line">    train_IDV_TD_SAMPLE_3 = train_IDV_TD_SAMPLE_3.drop([<span class="string">'CCY_CD'</span>, <span class="string">'RMB_MID_PRIC'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 数据去重</span></span><br><span class="line">    train_IDV_TD_SAMPLE_3.drop_duplicates(subset=<span class="keyword">None</span>, keep=<span class="string">'first'</span>, inplace=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># 将个人账户里的数据合并即金额加起来</span></span><br><span class="line">    train_IDV_TD_SAMPLE_SUM_3 = train_IDV_TD_SAMPLE_3[[<span class="string">'CUST_NO'</span>, <span class="string">'CRBAL'</span>, <span class="string">'REG_CAP'</span>, <span class="string">'FXDI_T_ACCM'</span>, <span class="string">'TDOP_SHD_PAY_INTS'</span>, <span class="string">'MOTH_CR_ACCM'</span>, <span class="string">'IDV_TD_SUM'</span>]].groupby(<span class="string">'CUST_NO'</span>).sum().reset_index()</span><br><span class="line">    <span class="comment"># 区分字段</span></span><br><span class="line">    train_IDV_TD_SAMPLE_SUM_3 = train_IDV_TD_SAMPLE_SUM_3.rename(columns=&#123;<span class="string">'CRBAL'</span>:<span class="string">'IDV_TD_CRBAL'</span>, <span class="string">'MOTH_CR_ACCM'</span>:<span class="string">'IDV_TD_MOTH_CR_ACCM'</span>&#125;)</span><br><span class="line">    <span class="comment"># @ 去除过分关联的特征</span></span><br><span class="line">    train_IDV_TD_SAMPLE_SUM_3 = train_IDV_TD_SAMPLE_SUM_3.drop([<span class="string">'TDOP_SHD_PAY_INTS'</span>, <span class="string">'REG_CAP'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 返回第三个时间段的数据</span></span><br><span class="line">    <span class="keyword">return</span> train_IDV_TD_SAMPLE_SUM_3</span><br></pre></td></tr></table></figure>

<h4 id="个人活期存款账户信息（IDV-DPSA）-处理"><a href="#个人活期存款账户信息（IDV-DPSA）-处理" class="headerlink" title="个人活期存款账户信息（IDV_DPSA）-  处理"></a>个人活期存款账户信息（IDV_DPSA）-  处理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编成函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">IDV_DPSA_PARSE</span><span class="params">(dataset_IDV_DPSA)</span>:</span></span><br><span class="line">    <span class="comment"># 划分三张表</span></span><br><span class="line">    train_idv_dpsa_1 = dataset_IDV_DPSA[dataset_IDV_DPSA[<span class="string">'DATA_DAT'</span>]==<span class="number">3728764800</span>].reset_index()</span><br><span class="line">    train_idv_dpsa_2 = dataset_IDV_DPSA[dataset_IDV_DPSA[<span class="string">'DATA_DAT'</span>]==<span class="number">3731443200</span>].reset_index()</span><br><span class="line">    train_idv_dpsa_3 = dataset_IDV_DPSA[dataset_IDV_DPSA[<span class="string">'DATA_DAT'</span>]==<span class="number">3734035200</span>].reset_index()</span><br><span class="line">    <span class="comment"># 精简字段</span></span><br><span class="line">    train_idv_dpsa_3 = train_idv_dpsa_3.drop([<span class="string">'DATA_DAT'</span>, <span class="string">'ARG_CRT_DAT'</span>, <span class="string">'CLS_ACCT_DAT'</span>, <span class="string">'MATU_DAT'</span>, <span class="string">'LAC'</span>, <span class="string">'ACCT_STS_CD'</span>, <span class="string">'RAT_CTG'</span>, <span class="string">'CUST_RANK_CD'</span>, <span class="string">'DAY_TFO_SUM'</span>, <span class="string">'MTH_ACT_DAYS_TOT'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 将IDV_DPSA表与汇率表整合</span></span><br><span class="line">    train_IDV_DPSA_SAMPLE_3 = pd.merge(train_idv_dpsa_3, train_base_excg, on = <span class="string">'CCY_CD'</span>)</span><br><span class="line">    <span class="comment"># 去重</span></span><br><span class="line">    train_IDV_DPSA_SAMPLE_3.drop_duplicates(subset=<span class="keyword">None</span>, keep=<span class="string">'first'</span>, inplace=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># 执行汇率计算函数</span></span><br><span class="line">    train_IDV_DPSA_SAMPLE_3[<span class="string">'FRZ_TOT_AMT'</span>] = train_IDV_DPSA_SAMPLE_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'FRZ_TOT_AMT'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_IDV_DPSA_SAMPLE_3[<span class="string">'DAY_WD_ACT_AMT'</span>] = train_IDV_DPSA_SAMPLE_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'DAY_WD_ACT_AMT'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_IDV_DPSA_SAMPLE_3[<span class="string">'DAY_CSH_DP_SUM'</span>] = train_IDV_DPSA_SAMPLE_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'DAY_CSH_DP_SUM'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_IDV_DPSA_SAMPLE_3[<span class="string">'DAY_CSH_WD_SUM'</span>] = train_IDV_DPSA_SAMPLE_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'DAY_CSH_WD_SUM'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_IDV_DPSA_SAMPLE_3[<span class="string">'DAY_TFI_SUM'</span>] = train_IDV_DPSA_SAMPLE_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'DAY_TFI_SUM'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_IDV_DPSA_SAMPLE_3[<span class="string">'MOTH_CR_ACCM'</span>] = train_IDV_DPSA_SAMPLE_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'MOTH_CR_ACCM'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_IDV_DPSA_SAMPLE_3[<span class="string">'BEG_MOTH_CRBAL'</span>] = train_IDV_DPSA_SAMPLE_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'BEG_MOTH_CRBAL'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    <span class="comment"># 再次精简表</span></span><br><span class="line">    train_IDV_DPSA_SAMPLE_3 = train_IDV_DPSA_SAMPLE_3.drop([<span class="string">'CCY_CD'</span>, <span class="string">'RMB_MID_PRIC'</span>, <span class="string">'index'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 避免重复字段</span></span><br><span class="line">    train_IDV_DPSA_SAMPLE_3 = train_IDV_DPSA_SAMPLE_3.rename(columns=&#123;<span class="string">'CRBAL'</span>:<span class="string">'IDV_DPSA_CRBAL'</span>, <span class="string">'MOTH_CR_ACCM'</span>:<span class="string">'IDV_DPSA_MOTH_CR_ACCM'</span>&#125;)</span><br><span class="line">    <span class="comment"># 按 CUST_NO 求和</span></span><br><span class="line">    train_IDV_DPSA_SAMPLE_3 = train_IDV_DPSA_SAMPLE_3[[<span class="string">'CUST_NO'</span>, <span class="string">'IDV_DPSA_CRBAL'</span>, <span class="string">'ITST_BRNG_ACCM'</span>, <span class="string">'FRZ_TOT_AMT'</span>, <span class="string">'DAY_WD_ACT_AMT'</span>, <span class="string">'DAY_CSH_DP_SUM'</span>,</span><br><span class="line">                                                 <span class="string">'DAY_CSH_WD_SUM'</span>, <span class="string">'DAY_TFI_SUM'</span>, <span class="string">'IDV_DPSA_MOTH_CR_ACCM'</span>, <span class="string">'BEG_MOTH_CRBAL'</span>]].groupby(<span class="string">'CUST_NO'</span>).sum().reset_index()</span><br><span class="line">    <span class="comment"># @ 去除过分关联的特征</span></span><br><span class="line">    train_IDV_DPSA_SAMPLE_3 = train_IDV_DPSA_SAMPLE_3.drop([<span class="string">'BEG_MOTH_CRBAL'</span>, <span class="string">'IDV_DPSA_MOTH_CR_ACCM'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 返回第三个时间段的数据</span></span><br><span class="line">    <span class="keyword">return</span> train_IDV_DPSA_SAMPLE_3</span><br></pre></td></tr></table></figure>

<h4 id="交易信息（TR-DC）-处理"><a href="#交易信息（TR-DC）-处理" class="headerlink" title="交易信息（TR_DC） - 处理"></a>交易信息（TR_DC） - 处理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">train_tr_dc_TR_TYPE = train_tr_dc.groupby([<span class="string">'CUST_NO'</span>,<span class="string">'TR_TYPE'</span>])[<span class="string">'TR_TYPE'</span>].count().unstack().reset_index()</span><br><span class="line">train_tr_dc_TR_TYPE[<span class="string">'TR_TYPE_TIMES'</span>] = train_tr_dc_TR_TYPE.drop(<span class="string">'CUST_NO'</span>,axis=<span class="number">1</span>).sum(axis=<span class="number">1</span>)</span><br><span class="line">train_tr_dc_BOE = train_tr_dc_TR_TYPE[[<span class="string">'CUST_NO'</span>,<span class="string">'TR_TYPE_TIMES'</span>,<span class="string">'EBMKO5RA'</span>]]</span><br><span class="line">train_tr_dc_BOE.columns = [<span class="string">'CUST_NO'</span>, <span class="string">'TR_TYPE_TIMES'</span>,<span class="string">'EBMKO5RA'</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train_tr_dc_BOE.head()</span><br></pre></td></tr></table></figure>

<p><img src="/assets/blogImg/OUTPUT_BOEING.png" alt="BOEING"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 声明函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">TR_DC_PARSE</span><span class="params">(dataset_TR_DC)</span>:</span></span><br><span class="line">    <span class="comment"># 去除抹帐(1),无意义列- RED_BLU_CD，这里全是0</span></span><br><span class="line">    dataset_TR_DC = dataset_TR_DC[dataset_TR_DC[<span class="string">'CAN_IND'</span>]==<span class="number">0</span>].drop([<span class="string">'RED_BLU_CD'</span>],axis=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 将交易按照 正 / 负 分开</span></span><br><span class="line">    dataset_TR_DC[<span class="string">'INCOME'</span>] = dataset_TR_DC[<span class="string">'TR_AMT'</span>] &gt; <span class="number">0</span></span><br><span class="line">    myseries = dataset_TR_DC.groupby([<span class="string">'CUST_NO'</span>, <span class="string">'INCOME'</span>])[<span class="string">'TR_AMT'</span>].sum()</span><br><span class="line">    myseries = myseries.unstack()</span><br><span class="line">    TR_DC_IN_OUT = pd.DataFrame(myseries).reset_index()</span><br><span class="line">    TR_DC_IN_OUT[<span class="string">'IN_SUM'</span>] = TR_DC_IN_OUT[<span class="keyword">True</span>]</span><br><span class="line">    TR_DC_IN_OUT[<span class="string">'OUT_SUM'</span>] = TR_DC_IN_OUT[<span class="keyword">False</span>]</span><br><span class="line">    TR_DC_IN_OUT = TR_DC_IN_OUT.drop([<span class="keyword">True</span>, <span class="keyword">False</span>], axis=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 根据BOE交易代码划分 仅使用 EBMKO5RA</span></span><br><span class="line">    train_tr_dc_TR_TYPE = dataset_TR_DC.groupby([<span class="string">'CUST_NO'</span>,<span class="string">'TR_TYPE'</span>])[<span class="string">'TR_TYPE'</span>].count().unstack().reset_index()</span><br><span class="line">    train_tr_dc_TR_TYPE[<span class="string">'TR_TYPE_TIMES'</span>] = train_tr_dc_TR_TYPE.drop(<span class="string">'CUST_NO'</span>,axis=<span class="number">1</span>).sum(axis=<span class="number">1</span>)</span><br><span class="line">    train_tr_dc_BOE = train_tr_dc_TR_TYPE[[<span class="string">'CUST_NO'</span>,<span class="string">'TR_TYPE_TIMES'</span>,<span class="string">'EBMKO5RA'</span>]]</span><br><span class="line">    train_tr_dc_BOE.columns = [<span class="string">'CUST_NO'</span>, <span class="string">'TR_TYPE_TIMES'</span>,<span class="string">'EBMKO5RA'</span>]</span><br><span class="line">    <span class="comment"># 根据SVRTO交易码划分 使用SVRTO061和SVRTO161</span></span><br><span class="line">    train_tr_dc_SVRTO061 = train_tr_dc_TR_TYPE[[<span class="string">'CUST_NO'</span>,<span class="string">'SVRTO061'</span>]]</span><br><span class="line">    train_tr_dc_SVRTO161 = train_tr_dc_TR_TYPE[[<span class="string">'CUST_NO'</span>,<span class="string">'SVRTO161'</span>]]</span><br><span class="line">    train_tr_dc_SVRTO061.columns = [<span class="string">'CUST_NO'</span>, <span class="string">'SVRTO061'</span>]</span><br><span class="line">    train_tr_dc_SVRTO161.columns = [<span class="string">'CUST_NO'</span>, <span class="string">'SVRTO161'</span>]</span><br><span class="line">    <span class="comment"># 计算每笔交易金额的均值</span></span><br><span class="line">    TR_DC_IN_MEAN = dataset_TR_DC[dataset_TR_DC[<span class="string">'TR_AMT'</span>]&gt;<span class="number">0</span>][[<span class="string">'CUST_NO'</span>, <span class="string">'TR_AMT'</span>]].groupby(<span class="string">'CUST_NO'</span>).mean().reset_index()</span><br><span class="line">    TR_DC_IN_MEAN.columns = [<span class="string">'CUST_NO'</span>, <span class="string">'TR_DC_IN_MEAN'</span>]</span><br><span class="line">    TR_DC_OUT_MEAN = dataset_TR_DC[dataset_TR_DC[<span class="string">'TR_AMT'</span>]&lt;<span class="number">0</span>][[<span class="string">'CUST_NO'</span>, <span class="string">'TR_AMT'</span>]].groupby(<span class="string">'CUST_NO'</span>).mean().reset_index()</span><br><span class="line">    TR_DC_OUT_MEAN.columns = [<span class="string">'CUST_NO'</span>, <span class="string">'TR_DC_OUT_MEAN'</span>]</span><br><span class="line">    <span class="comment"># 合并各个特征 36041</span></span><br><span class="line">    <span class="comment"># train_TR_DC_SAMPLE = pd.merge(TR_DC_IN_OUT, train_tr_dc_BOE, on='CUST_NO', how='outer')</span></span><br><span class="line">    train_TR_DC_SAMPLE = pd.merge(TR_DC_IN_OUT, TR_DC_IN_MEAN, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">    train_TR_DC_SAMPLE = pd.merge(train_TR_DC_SAMPLE, TR_DC_OUT_MEAN, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">    <span class="comment"># train_TR_DC_SAMPLE = pd.merge(train_TR_DC_SAMPLE, train_tr_dc_SVRTO061, on='CUST_NO', how='outer')</span></span><br><span class="line">    <span class="comment"># train_TR_DC_SAMPLE = pd.merge(train_TR_DC_SAMPLE, train_tr_dc_SVRTO161, on='CUST_NO', how='outer')</span></span><br><span class="line">    <span class="keyword">return</span> train_TR_DC_SAMPLE</span><br></pre></td></tr></table></figure>

<h4 id="第三方存管账户信息（THR-PTY-CSTD）-处理"><a href="#第三方存管账户信息（THR-PTY-CSTD）-处理" class="headerlink" title="第三方存管账户信息（THR_PTY_CSTD） - 处理"></a>第三方存管账户信息（THR_PTY_CSTD） - 处理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提前删掉无用字段</span></span><br><span class="line">train_thr_pty_cstd_temple = train_thr_pty_cstd.drop([<span class="string">'CCY_CD'</span>, <span class="string">'CUST_CTG_CD'</span>, <span class="string">'MTH_ACT_DAYS_TOT'</span>], axis=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 划分三张表</span></span><br><span class="line">train_thr_pty_cstd_1 = train_thr_pty_cstd_temple[train_thr_pty_cstd_temple[<span class="string">'DATA_DAT'</span>]==<span class="number">3728764800</span>].reset_index()</span><br><span class="line">train_thr_pty_cstd_2 = train_thr_pty_cstd_temple[train_thr_pty_cstd_temple[<span class="string">'DATA_DAT'</span>]==<span class="number">3731443200</span>].reset_index()</span><br><span class="line">train_thr_pty_cstd_3 = train_thr_pty_cstd_temple[train_thr_pty_cstd_temple[<span class="string">'DATA_DAT'</span>]==<span class="number">3734035200</span>].reset_index()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 清理没用字段</span></span><br><span class="line">train_thr_pty_cstd_3 = train_thr_pty_cstd_3.drop([<span class="string">'index'</span>, <span class="string">'DATA_DAT'</span>], axis=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 对字段进行处理</span></span><br><span class="line">ARG_BAL = train_thr_pty_cstd_3.groupby([<span class="string">'CUST_NO'</span>])[<span class="string">'ARG_BAL'</span>].sum().reset_index()</span><br><span class="line">AVL_BAL = train_thr_pty_cstd_3.groupby([<span class="string">'CUST_NO'</span>])[<span class="string">'AVL_BAL'</span>].sum().reset_index()</span><br><span class="line">MTH_ARG_BAL_ACCM = train_thr_pty_cstd_3.groupby([<span class="string">'CUST_NO'</span>])[<span class="string">'MTH_ARG_BAL_ACCM'</span>].sum().reset_index()</span><br><span class="line">MTH_FUD_TF_INWD_AMT = train_thr_pty_cstd_3.groupby([<span class="string">'CUST_NO'</span>])[<span class="string">'MTH_FUD_TF_INWD_AMT'</span>].sum().reset_index()</span><br><span class="line">MTH_FUD_TF_OUT_AMT = train_thr_pty_cstd_3.groupby([<span class="string">'CUST_NO'</span>])[<span class="string">'MTH_FUD_TF_OUT_AMT'</span>].sum().reset_index()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将字段合并</span></span><br><span class="line">train_thr_pty_cstd_SAMPLE = pd.merge(ARG_BAL, AVL_BAL, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">train_thr_pty_cstd_SAMPLE = pd.merge(train_thr_pty_cstd_SAMPLE, MTH_ARG_BAL_ACCM, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">train_thr_pty_cstd_SAMPLE = pd.merge(train_thr_pty_cstd_SAMPLE, MTH_FUD_TF_INWD_AMT, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">train_thr_pty_cstd_SAMPLE = pd.merge(train_thr_pty_cstd_SAMPLE, MTH_FUD_TF_OUT_AMT, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># @ 去除过分关联的特征</span></span><br><span class="line">train_thr_pty_cstd_SAMPLE = train_thr_pty_cstd_SAMPLE.drop([<span class="string">'ARG_BAL'</span>, <span class="string">'MTH_ARG_BAL_ACCM'</span>], axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 声明函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">THR_PTY_CSTD_PARSE</span><span class="params">(dataset_THR_PTY_CSTD)</span>:</span></span><br><span class="line">    <span class="comment"># 提前删掉无用字段</span></span><br><span class="line">    dataset_THR_PTY_CSTD = dataset_THR_PTY_CSTD.drop([<span class="string">'CCY_CD'</span>, <span class="string">'CUST_CTG_CD'</span>, <span class="string">'MTH_ACT_DAYS_TOT'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 划分三张表</span></span><br><span class="line">    train_thr_pty_cstd_1 = dataset_THR_PTY_CSTD[dataset_THR_PTY_CSTD[<span class="string">'DATA_DAT'</span>]==<span class="number">3728764800</span>].reset_index()</span><br><span class="line">    train_thr_pty_cstd_2 = dataset_THR_PTY_CSTD[dataset_THR_PTY_CSTD[<span class="string">'DATA_DAT'</span>]==<span class="number">3731443200</span>].reset_index()</span><br><span class="line">    train_thr_pty_cstd_3 = dataset_THR_PTY_CSTD[dataset_THR_PTY_CSTD[<span class="string">'DATA_DAT'</span>]==<span class="number">3734035200</span>].reset_index()</span><br><span class="line">    <span class="comment"># 清理没用字段</span></span><br><span class="line">    train_thr_pty_cstd_3 = train_thr_pty_cstd_3.drop([<span class="string">'index'</span>, <span class="string">'DATA_DAT'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 对字段进行处理</span></span><br><span class="line">    ARG_BAL = train_thr_pty_cstd_3.groupby([<span class="string">'CUST_NO'</span>])[<span class="string">'ARG_BAL'</span>].sum().reset_index()</span><br><span class="line">    AVL_BAL = train_thr_pty_cstd_3.groupby([<span class="string">'CUST_NO'</span>])[<span class="string">'AVL_BAL'</span>].sum().reset_index()</span><br><span class="line">    MTH_ARG_BAL_ACCM = train_thr_pty_cstd_3.groupby([<span class="string">'CUST_NO'</span>])[<span class="string">'MTH_ARG_BAL_ACCM'</span>].sum().reset_index()</span><br><span class="line">    MTH_FUD_TF_INWD_AMT = train_thr_pty_cstd_3.groupby([<span class="string">'CUST_NO'</span>])[<span class="string">'MTH_FUD_TF_INWD_AMT'</span>].sum().reset_index()</span><br><span class="line">    MTH_FUD_TF_OUT_AMT = train_thr_pty_cstd_3.groupby([<span class="string">'CUST_NO'</span>])[<span class="string">'MTH_FUD_TF_OUT_AMT'</span>].sum().reset_index()</span><br><span class="line">    <span class="comment"># 将字段合并</span></span><br><span class="line">    train_thr_pty_cstd_SAMPLE = pd.merge(AVL_BAL, ARG_BAL, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">    train_thr_pty_cstd_SAMPLE = pd.merge(train_thr_pty_cstd_SAMPLE, MTH_ARG_BAL_ACCM, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">    train_thr_pty_cstd_SAMPLE = pd.merge(train_thr_pty_cstd_SAMPLE, MTH_FUD_TF_INWD_AMT, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">    train_thr_pty_cstd_SAMPLE = pd.merge(train_thr_pty_cstd_SAMPLE, MTH_FUD_TF_OUT_AMT, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">    <span class="comment"># @ 去除过分关联的特征</span></span><br><span class="line">    train_thr_pty_cstd_SAMPLE = train_thr_pty_cstd_SAMPLE.drop([<span class="string">'ARG_BAL'</span>, <span class="string">'MTH_ARG_BAL_ACCM'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> train_thr_pty_cstd_SAMPLE</span><br></pre></td></tr></table></figure>

<h4 id="贷款账户信息（LOAN）-处理"><a href="#贷款账户信息（LOAN）-处理" class="headerlink" title="贷款账户信息（LOAN）- 处理"></a>贷款账户信息（LOAN）- 处理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 选择有用字段</span></span><br><span class="line">train_loan_temple = train_loan[[<span class="string">'CUST_NO'</span>, <span class="string">'DATA_DAT'</span>, <span class="string">'ARG_TYP_CD'</span>, <span class="string">'CCY_CD'</span>, <span class="string">'ARG_LIF_CYC_STA_CD'</span>, <span class="string">'LN_STS_CD'</span>, <span class="string">'CHANL_CD'</span>, <span class="string">'LN_TERM'</span>, <span class="string">'RPAY_MOD_CD'</span>, <span class="string">'LAC'</span>, <span class="string">'NON_MATU_CAP'</span>, <span class="string">'ACD_NML_INTS'</span>, <span class="string">'INTS_TOT_AMT'</span></span><br><span class="line">                        , <span class="string">'BUS_BREED_CD'</span>, <span class="string">'NML_CAP_BAL'</span>, <span class="string">'MTH_NML_CAP_ACCM'</span>]]</span><br><span class="line">train_loan_temple =  pd.merge(train_loan_temple, train_base_excg, on = <span class="string">'CCY_CD'</span>)</span><br><span class="line"><span class="comment"># 划分三张表</span></span><br><span class="line">train_loan_1 = train_loan_temple[train_loan_temple[<span class="string">'DATA_DAT'</span>]==<span class="number">3728764800</span>]</span><br><span class="line">train_loan_2 = train_loan_temple[train_loan_temple[<span class="string">'DATA_DAT'</span>]==<span class="number">3731443200</span>]</span><br><span class="line">train_loan_3 = train_loan_temple[train_loan_temple[<span class="string">'DATA_DAT'</span>]==<span class="number">3734035200</span>]</span><br><span class="line">train_loan_3 = train_loan_3.drop([<span class="string">'DATA_DAT'</span>], axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train_loan_3.drop_duplicates(subset=<span class="keyword">None</span>, keep=<span class="string">'first'</span>, inplace=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行汇率计算函数</span></span><br><span class="line">train_loan_3[<span class="string">'ACD_NML_INTS'</span>] = train_loan_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'ACD_NML_INTS'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">train_loan_3[<span class="string">'NON_MATU_CAP'</span>] = train_loan_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'NON_MATU_CAP'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">train_loan_3[<span class="string">'NML_CAP_BAL'</span>] = train_loan_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'NML_CAP_BAL'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">train_loan_3[<span class="string">'INTS_TOT_AMT'</span>] = train_loan_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'INTS_TOT_AMT'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">train_loan_3[<span class="string">'MTH_NML_CAP_ACCM'</span>] = train_loan_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'MTH_NML_CAP_ACCM'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 平均应计正常利息</span></span><br><span class="line">MEAN_ACD_NML_INTS = train_loan_3[[<span class="string">'CUST_NO'</span>, <span class="string">'ACD_NML_INTS'</span>]].groupby([<span class="string">'CUST_NO'</span>]).mean().reset_index()</span><br><span class="line"><span class="comment"># 平均应计未到期本金</span></span><br><span class="line">MEAN_NON_MATU_CAP = train_loan_3[[<span class="string">'CUST_NO'</span>, <span class="string">'NON_MATU_CAP'</span>]].groupby([<span class="string">'CUST_NO'</span>]).mean().reset_index()</span><br><span class="line"><span class="comment"># 平均月内正常本金基数</span></span><br><span class="line">MEAN_MTH_NML_CAP_ACCM = train_loan_3[[<span class="string">'CUST_NO'</span>,<span class="string">'MTH_NML_CAP_ACCM'</span>]].groupby([<span class="string">'CUST_NO'</span>]).mean().reset_index()</span><br><span class="line"><span class="comment"># 平均贷款期限</span></span><br><span class="line">MEAN_LOAN_TERM = train_loan_3[[<span class="string">'CUST_NO'</span>,<span class="string">'LN_TERM'</span>]].groupby([<span class="string">'CUST_NO'</span>]).mean().reset_index()</span><br><span class="line"><span class="comment"># 平均贷款金额</span></span><br><span class="line">MEAN_NML_CAP_BAL = train_loan_3[[<span class="string">'CUST_NO'</span>, <span class="string">'NML_CAP_BAL'</span>]].groupby([<span class="string">'CUST_NO'</span>]).mean().reset_index()</span><br><span class="line"><span class="comment"># 平均利息总额</span></span><br><span class="line">MEAN_INTS_TOT_AMT = train_loan_3[[<span class="string">'CUST_NO'</span>, <span class="string">'INTS_TOT_AMT'</span>]].groupby([<span class="string">'CUST_NO'</span>]).mean().reset_index()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">train_loan_3_SAMPLE = pd.merge(pd.merge(pd.merge(pd.merge(pd.merge(MEAN_ACD_NML_INTS, MEAN_NON_MATU_CAP, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>), MEAN_MTH_NML_CAP_ACCM, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>), MEAN_LOAN_TERM, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>),</span><br><span class="line">                              MEAN_NML_CAP_BAL, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>), MEAN_INTS_TOT_AMT, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">BY_MONTH_LOAN_METHOD</span><span class="params">(dataset_LOAN)</span>:</span></span><br><span class="line">    <span class="comment"># 选择有用字段</span></span><br><span class="line">    train_loan_temple = dataset_LOAN[[<span class="string">'CUST_NO'</span>, <span class="string">'DATA_DAT'</span>, <span class="string">'ARG_TYP_CD'</span>, <span class="string">'CCY_CD'</span>, <span class="string">'ARG_LIF_CYC_STA_CD'</span>, <span class="string">'LN_STS_CD'</span>, <span class="string">'CHANL_CD'</span>, <span class="string">'LN_TERM'</span>, <span class="string">'RPAY_MOD_CD'</span>, <span class="string">'LAC'</span>, <span class="string">'NON_MATU_CAP'</span>, <span class="string">'ACD_NML_INTS'</span>, <span class="string">'INTS_TOT_AMT'</span> , <span class="string">'BUS_BREED_CD'</span>, <span class="string">'NML_CAP_BAL'</span>, <span class="string">'MTH_NML_CAP_ACCM'</span>]]</span><br><span class="line">    train_loan_temple =  pd.merge(train_loan_temple, train_base_excg, on = <span class="string">'CCY_CD'</span>)</span><br><span class="line">    <span class="comment"># 划分三张表</span></span><br><span class="line">    train_loan_1 = train_loan_temple[train_loan_temple[<span class="string">'DATA_DAT'</span>]==<span class="number">3728764800</span>]</span><br><span class="line">    train_loan_2 = train_loan_temple[train_loan_temple[<span class="string">'DATA_DAT'</span>]==<span class="number">3731443200</span>]</span><br><span class="line">    train_loan_3 = train_loan_temple[train_loan_temple[<span class="string">'DATA_DAT'</span>]==<span class="number">3734035200</span>]</span><br><span class="line">    train_loan_3 = train_loan_3.drop([<span class="string">'DATA_DAT'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    train_loan_3.drop_duplicates(subset=<span class="keyword">None</span>, keep=<span class="string">'first'</span>, inplace=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># 执行汇率计算函数</span></span><br><span class="line">    train_loan_3[<span class="string">'ACD_NML_INTS'</span>] = train_loan_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'ACD_NML_INTS'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_loan_3[<span class="string">'NON_MATU_CAP'</span>] = train_loan_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'NON_MATU_CAP'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_loan_3[<span class="string">'NML_CAP_BAL'</span>] = train_loan_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'NML_CAP_BAL'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_loan_3[<span class="string">'INTS_TOT_AMT'</span>] = train_loan_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'INTS_TOT_AMT'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_loan_3[<span class="string">'MTH_NML_CAP_ACCM'</span>] = train_loan_3.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'MTH_NML_CAP_ACCM'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    <span class="comment"># 平均应计正常利息</span></span><br><span class="line">    MEAN_ACD_NML_INTS = train_loan_3[[<span class="string">'CUST_NO'</span>, <span class="string">'ACD_NML_INTS'</span>]].groupby([<span class="string">'CUST_NO'</span>]).mean().reset_index()</span><br><span class="line">    <span class="comment"># 平均应计未到期本金</span></span><br><span class="line">    MEAN_NON_MATU_CAP = train_loan_3[[<span class="string">'CUST_NO'</span>, <span class="string">'NON_MATU_CAP'</span>]].groupby([<span class="string">'CUST_NO'</span>]).mean().reset_index()</span><br><span class="line">    <span class="comment"># 平均月内正常本金基数</span></span><br><span class="line">    MEAN_MTH_NML_CAP_ACCM = train_loan_3[[<span class="string">'CUST_NO'</span>,<span class="string">'MTH_NML_CAP_ACCM'</span>]].groupby([<span class="string">'CUST_NO'</span>]).mean().reset_index()</span><br><span class="line">    <span class="comment"># 平均贷款期限</span></span><br><span class="line">    MEAN_LOAN_TERM = train_loan_3[[<span class="string">'CUST_NO'</span>,<span class="string">'LN_TERM'</span>]].groupby([<span class="string">'CUST_NO'</span>]).mean().reset_index()</span><br><span class="line">    <span class="comment"># 平均贷款金额</span></span><br><span class="line">    MEAN_NML_CAP_BAL = train_loan_3[[<span class="string">'CUST_NO'</span>, <span class="string">'NML_CAP_BAL'</span>]].groupby([<span class="string">'CUST_NO'</span>]).mean().reset_index()</span><br><span class="line">    <span class="comment"># 平均利息总额</span></span><br><span class="line">    MEAN_INTS_TOT_AMT = train_loan_3[[<span class="string">'CUST_NO'</span>, <span class="string">'INTS_TOT_AMT'</span>]].groupby([<span class="string">'CUST_NO'</span>]).mean().reset_index()</span><br><span class="line">    train_loan_3_SAMPLE = pd.merge(pd.merge(pd.merge(pd.merge(pd.merge(MEAN_ACD_NML_INTS, MEAN_NON_MATU_CAP, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>), MEAN_MTH_NML_CAP_ACCM, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>), MEAN_LOAN_TERM, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>),</span><br><span class="line">                              MEAN_NML_CAP_BAL, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>), MEAN_INTS_TOT_AMT, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> train_loan_3_SAMPLE</span><br></pre></td></tr></table></figure>

<h4 id="基金账户信息（FUND）-处理"><a href="#基金账户信息（FUND）-处理" class="headerlink" title="基金账户信息（FUND）- 处理"></a>基金账户信息（FUND）- 处理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">BY_MONTH_FUND_METHOD</span><span class="params">(dataset_FOUND)</span>:</span></span><br><span class="line">    <span class="comment"># 预处理</span></span><br><span class="line">    train_fund_temple = dataset_FOUND.drop([<span class="string">'CCY_CD'</span>, <span class="string">'ARG_CRT_DAT'</span>, <span class="string">'ARG_LIF_CYC_STA_CD'</span>, <span class="string">'CHANL_CD'</span>, <span class="string">'VLU_DAT'</span>, <span class="string">'DATE_MATU'</span>, <span class="string">'CLS_ACCT_DAT'</span>, <span class="string">'LAST_ACT_CHNG_DAT'</span>, <span class="string">'MTH_ACT_DAYS_TOT'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 按月将金额分组</span></span><br><span class="line">    BY_MONTH_FUND_TABLE = train_fund_temple.groupby([<span class="string">'CUST_NO'</span>, <span class="string">'DATA_DAT'</span>])[[<span class="string">'FUD_UNIT_NET_VAL'</span>, <span class="string">'FUD_PROD_TYP_CD'</span>, <span class="string">'RSK_RANK_CD'</span>, <span class="string">'SHR'</span>,</span><br><span class="line">           <span class="string">'MOTH_BAL_ACCM'</span>, <span class="string">'FUND_BAL'</span>, <span class="string">'FUND_BAL_MOTH_BAL_ACCM'</span>]].sum().unstack()</span><br><span class="line">    <span class="comment"># 声明函数 计算三个月的标准差、均值、最大值、最小值</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">BY_MONTH_FUND</span><span class="params">(key)</span>:</span></span><br><span class="line">        train_fund_temple_STD = BY_MONTH_FUND_TABLE[key].std(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_fund_temple_STD.columns = [<span class="string">'CUST_NO'</span>, str(<span class="string">'FUND_'</span>+key+<span class="string">'_STD'</span>)]</span><br><span class="line">        train_fund_temple_MEAN = BY_MONTH_FUND_TABLE[key].mean(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_fund_temple_MEAN.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'FUND_'</span>+key+<span class="string">'_MEAN'</span>)]</span><br><span class="line">        train_fund_temple_MAX = BY_MONTH_FUND_TABLE[key].max(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_fund_temple_MAX.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'FUND_'</span>+key+<span class="string">'_MAX'</span>)]</span><br><span class="line">        train_fund_temple_MIN = BY_MONTH_FUND_TABLE[key].min(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_fund_temple_MIN.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'FUND_'</span>+key+<span class="string">'_MIN'</span>)]</span><br><span class="line">        <span class="comment"># 合并字段</span></span><br><span class="line">        train_fund_temple = pd.merge(train_fund_temple_STD, train_fund_temple_MEAN, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_fund_temple = pd.merge(train_fund_temple, train_fund_temple_MAX, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_fund_temple = pd.merge(train_fund_temple, train_fund_temple_MIN, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        <span class="keyword">return</span> train_fund_temple</span><br><span class="line">    train_fund_temple = BY_MONTH_FUND(<span class="string">'RSK_RANK_CD'</span>)</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> [<span class="string">'FUD_UNIT_NET_VAL'</span>, <span class="string">'FUD_PROD_TYP_CD'</span>, <span class="string">'SHR'</span>, <span class="string">'MOTH_BAL_ACCM'</span>, <span class="string">'FUND_BAL'</span>, <span class="string">'FUND_BAL_MOTH_BAL_ACCM'</span>]:</span><br><span class="line">        train_fund_temple = pd.merge(train_fund_temple, BY_MONTH_FUND(key))</span><br><span class="line">        train_fund_temple.drop_duplicates(subset=<span class="keyword">None</span>, keep=<span class="string">'first'</span>, inplace=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># 定申定赎 开通标识</span></span><br><span class="line">    SUM_FUND_RATN_APLY_OPN_IND = dataset_FOUND[[<span class="string">'CUST_NO'</span>, <span class="string">'RATN_APLY_OPN_IND'</span>]].groupby([<span class="string">'CUST_NO'</span>]).sum().reset_index()</span><br><span class="line">    STD_FUND_RATN_APLY_OPN_IND = dataset_FOUND[[<span class="string">'CUST_NO'</span>, <span class="string">'RATN_APLY_OPN_IND'</span>]].groupby([<span class="string">'CUST_NO'</span>]).std().reset_index()</span><br><span class="line">    MEAN_FUND_RATN_APLY_OPN_IND = dataset_FOUND[[<span class="string">'CUST_NO'</span>, <span class="string">'RATN_APLY_OPN_IND'</span>]].groupby([<span class="string">'CUST_NO'</span>]).mean().reset_index()</span><br><span class="line">    MAX_FUND_RATN_APLY_OPN_IND = dataset_FOUND[[<span class="string">'CUST_NO'</span>, <span class="string">'RATN_APLY_OPN_IND'</span>]].groupby([<span class="string">'CUST_NO'</span>]).max().reset_index()</span><br><span class="line">    MIN_FUND_RATN_APLY_OPN_IND = dataset_FOUND[[<span class="string">'CUST_NO'</span>, <span class="string">'RATN_APLY_OPN_IND'</span>]].groupby([<span class="string">'CUST_NO'</span>]).min().reset_index()</span><br><span class="line"></span><br><span class="line">    SUM_FUND_RATN_REDM_OPN_IND = dataset_FOUND[[<span class="string">'CUST_NO'</span>, <span class="string">'RATN_REDM_OPN_IND'</span>]].groupby([<span class="string">'CUST_NO'</span>]).sum().reset_index()</span><br><span class="line">    STD_FUND_RATN_REDM_OPN_IND = dataset_FOUND[[<span class="string">'CUST_NO'</span>, <span class="string">'RATN_REDM_OPN_IND'</span>]].groupby([<span class="string">'CUST_NO'</span>]).std().reset_index()</span><br><span class="line">    MEAN_FUND_RATN_REDM_OPN_IND = dataset_FOUND[[<span class="string">'CUST_NO'</span>, <span class="string">'RATN_REDM_OPN_IND'</span>]].groupby([<span class="string">'CUST_NO'</span>]).mean().reset_index()</span><br><span class="line">    MAX_FUND_RATN_REDM_OPN_IND = dataset_FOUND[[<span class="string">'CUST_NO'</span>, <span class="string">'RATN_REDM_OPN_IND'</span>]].groupby([<span class="string">'CUST_NO'</span>]).max().reset_index()</span><br><span class="line">    MIN_FUND_RATN_REDM_OPN_IND = dataset_FOUND[[<span class="string">'CUST_NO'</span>, <span class="string">'RATN_REDM_OPN_IND'</span>]].groupby([<span class="string">'CUST_NO'</span>]).min().reset_index()</span><br><span class="line">    train_fund_temple = pd.merge(pd.merge(train_fund_temple, STD_FUND_RATN_APLY_OPN_IND, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>), MIN_FUND_RATN_REDM_OPN_IND, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">    <span class="keyword">return</span> train_fund_temple</span><br></pre></td></tr></table></figure>

<h4 id="国债账户信息（BOND）-处理"><a href="#国债账户信息（BOND）-处理" class="headerlink" title="国债账户信息（BOND）- 处理"></a>国债账户信息（BOND）- 处理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">BY_MONTH_BOND_METHOD</span><span class="params">(dataset_BOND)</span>:</span></span><br><span class="line">    <span class="comment"># 预处理</span></span><br><span class="line">    train_bond_temple = dataset_BOND.drop([<span class="string">'CCY_CD'</span>, <span class="string">'ARG_CRT_DAT'</span>, <span class="string">'MATU_DAT'</span>, <span class="string">'MATU_DAT'</span>, <span class="string">'PROD_CLS_CD'</span>, <span class="string">'CERT_DAT'</span>, <span class="string">'CLS_ACCT_DAT'</span>, <span class="string">'ARG_LIF_CYC_STA_CD'</span>, <span class="string">'NTNL_DEBT_INTS_TYP_CD'</span>, <span class="string">'MTH_ACT_DAYS_TOT'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 按月将金额分组</span></span><br><span class="line">    BY_MONTH_BOND_TABLE = train_bond_temple.groupby([<span class="string">'CUST_NO'</span>, <span class="string">'DATA_DAT'</span>])[[<span class="string">'BOND_TERM_CD'</span>, <span class="string">'ARG_CUR_BAL'</span>, <span class="string">'HOD_SHR'</span>,</span><br><span class="line">       <span class="string">'UNIT_NET_VAL'</span>, <span class="string">'NVTA_MOTH_ACCM'</span>]].sum().unstack()</span><br><span class="line">    <span class="comment"># 声明函数 计算三个月的标准差、均值、最大值、最小值</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span>  <span class="title">BY_MONTH_BOND</span><span class="params">(key)</span>:</span></span><br><span class="line">        train_bond_temple_STD = BY_MONTH_BOND_TABLE[key].std(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_bond_temple_STD.columns = [<span class="string">'CUST_NO'</span>, str(<span class="string">'BOND_'</span>+key+<span class="string">'_STD'</span>)]</span><br><span class="line">        train_bond_temple_MEAN = BY_MONTH_BOND_TABLE[key].mean(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_bond_temple_MEAN.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'BOND_'</span>+key+<span class="string">'_MEAN'</span>)]</span><br><span class="line">        train_bond_temple_MAX = BY_MONTH_BOND_TABLE[key].max(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_bond_temple_MAX.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'BOND_'</span>+key+<span class="string">'_MAX'</span>)]</span><br><span class="line">        train_bond_temple_MIN = BY_MONTH_BOND_TABLE[key].min(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_bond_temple_MIN.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'BOND_'</span>+key+<span class="string">'_MIN'</span>)]</span><br><span class="line">        <span class="comment"># 合并字段</span></span><br><span class="line">        train_bond_temple = pd.merge(train_bond_temple_STD, train_bond_temple_MEAN, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_bond_temple = pd.merge(train_bond_temple, train_bond_temple_MAX, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_bond_temple = pd.merge(train_bond_temple, train_bond_temple_MIN, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        <span class="keyword">return</span> train_bond_temple</span><br><span class="line">    train_bond_temple = BY_MONTH_BOND(<span class="string">'BOND_TERM_CD'</span>)</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> [<span class="string">'ARG_CUR_BAL'</span>, <span class="string">'HOD_SHR'</span>, <span class="string">'UNIT_NET_VAL'</span>, <span class="string">'NVTA_MOTH_ACCM'</span>]:</span><br><span class="line">        train_bond_temple = pd.merge(train_bond_temple, BY_MONTH_BOND(key))</span><br><span class="line">        train_bond_temple.drop_duplicates(subset=<span class="keyword">None</span>, keep=<span class="string">'first'</span>, inplace=<span class="keyword">True</span>)</span><br><span class="line">    <span class="keyword">return</span> train_bond_temple</span><br></pre></td></tr></table></figure>

<h4 id="贵金属账户信息（PREC-METAL）-处理"><a href="#贵金属账户信息（PREC-METAL）-处理" class="headerlink" title="贵金属账户信息（PREC_METAL）- 处理"></a>贵金属账户信息（PREC_METAL）- 处理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">BY_MONTH_PREC_METAL_METHOD</span><span class="params">(dataset_PREC_METAL)</span>:</span></span><br><span class="line">    <span class="comment"># 预处理</span></span><br><span class="line">    train_prec_metal_temple = dataset_PREC_METAL.drop([<span class="string">'PREC_METAL_BREED_CD'</span>, <span class="string">'ARG_STS_CD'</span>, <span class="string">'SIGD_DAT'</span>, <span class="string">'SIGD_CHANL_CD'</span>, <span class="string">'TEMN_DAT'</span>, <span class="string">'TEMN_CHANL_CD'</span>, <span class="string">'MTH_ACT_DAYS_TOT'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 将train_prec_metal和train_base_excg合并</span></span><br><span class="line">    train_prec_metal_temple = pd.merge(train_prec_metal_temple, train_base_excg, on = <span class="string">'CCY_CD'</span>)</span><br><span class="line">    <span class="comment"># 执行汇率计算函数</span></span><br><span class="line">    train_prec_metal_temple[<span class="string">'ARG_BAL'</span>] = train_prec_metal_temple.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'ARG_BAL'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    <span class="comment"># 按月将金额分组</span></span><br><span class="line">    BY_MONTH_PREC_METAL_TABLE = train_prec_metal_temple.groupby([<span class="string">'CUST_NO'</span>, <span class="string">'DATA_DAT'</span>])[[<span class="string">'BUS_CTG_CD'</span>, <span class="string">'CNT'</span>, <span class="string">'ARG_BAL'</span>,</span><br><span class="line">       <span class="string">'MTH_ARG_ACCM'</span>]].sum().unstack()</span><br><span class="line">    <span class="comment"># 声明函数 计算三个月的标准差、均值、最大值、最小值</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span>  <span class="title">BY_MONTH_PREC_METAL</span><span class="params">(key)</span>:</span></span><br><span class="line">        train_prec_metal_temple_STD = BY_MONTH_PREC_METAL_TABLE[key].std(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_prec_metal_temple_STD.columns = [<span class="string">'CUST_NO'</span>, str(<span class="string">'PREC_METAL_'</span>+key+<span class="string">'_STD'</span>)]</span><br><span class="line">        train_prec_metal_temple_MEAN = BY_MONTH_PREC_METAL_TABLE[key].mean(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_prec_metal_temple_MEAN.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'PREC_METAL_'</span>+key+<span class="string">'_MEAN'</span>)]</span><br><span class="line">        train_prec_metal_temple_MAX = BY_MONTH_PREC_METAL_TABLE[key].max(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_prec_metal_temple_MAX.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'PREC_METAL_'</span>+key+<span class="string">'_MAX'</span>)]</span><br><span class="line">        train_prec_metal_temple_MIN = BY_MONTH_PREC_METAL_TABLE[key].min(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_prec_metal_temple_MIN.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'PREC_METAL_'</span>+key+<span class="string">'_MIN'</span>)]</span><br><span class="line">        <span class="comment"># 合并字段</span></span><br><span class="line">        train_prec_metal_temple = pd.merge(train_prec_metal_temple_STD, train_prec_metal_temple_MEAN, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_prec_metal_temple = pd.merge(train_prec_metal_temple, train_prec_metal_temple_MAX, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_prec_metal_temple = pd.merge(train_prec_metal_temple, train_prec_metal_temple_MIN, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        <span class="keyword">return</span> train_prec_metal_temple</span><br><span class="line">    train_prec_metal_temple = BY_MONTH_PREC_METAL(<span class="string">'BUS_CTG_CD'</span>)</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> [<span class="string">'CNT'</span>, <span class="string">'ARG_BAL'</span>, <span class="string">'MTH_ARG_ACCM'</span>]:</span><br><span class="line">        train_prec_metal_temple = pd.merge(train_prec_metal_temple, BY_MONTH_PREC_METAL(key))</span><br><span class="line">        train_prec_metal_temple.drop_duplicates(subset=<span class="keyword">None</span>, keep=<span class="string">'first'</span>, inplace=<span class="keyword">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> train_prec_metal_temple</span><br></pre></td></tr></table></figure>

<h4 id="代理保险账户信息（AGET-INSR）-处理"><a href="#代理保险账户信息（AGET-INSR）-处理" class="headerlink" title="代理保险账户信息（AGET_INSR）- 处理"></a>代理保险账户信息（AGET_INSR）- 处理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">BY_MONTH_AGET_INSR_METHOD</span><span class="params">(dataset_AGET_INSR)</span>:</span></span><br><span class="line">    <span class="comment"># 预处理</span></span><br><span class="line">    train_aget_insr_temple = dataset_AGET_INSR[[<span class="string">'DATA_DAT'</span>, <span class="string">'CUST_NO'</span>, <span class="string">'PREM'</span>, <span class="string">'CVAG'</span>, <span class="string">'INSE_CNT'</span>, <span class="string">'MTH_PREM_ACCM'</span>, <span class="string">'BEG_MTH_PREM_BAL'</span>]]</span><br><span class="line">    <span class="comment"># 按月将金额分组</span></span><br><span class="line">    BY_MONTH_AGET_INSR_TABLE = train_aget_insr_temple.groupby([<span class="string">'CUST_NO'</span>, <span class="string">'DATA_DAT'</span>])[[<span class="string">'PREM'</span>, <span class="string">'CVAG'</span>, <span class="string">'INSE_CNT'</span>, <span class="string">'MTH_PREM_ACCM'</span>, <span class="string">'BEG_MTH_PREM_BAL'</span>]].sum().unstack()</span><br><span class="line">    <span class="comment"># 声明函数 计算三个月的标准差、均值、最大值、最小值</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">BY_MONTH_AGET_INSR</span><span class="params">(key)</span>:</span></span><br><span class="line">        train_aget_insr_temple_STD = BY_MONTH_AGET_INSR_TABLE[key].std(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_aget_insr_temple_STD.columns = [<span class="string">'CUST_NO'</span>, str(<span class="string">'AGET_INSR_'</span>+key+<span class="string">'_STD'</span>)]</span><br><span class="line">        train_aget_insr_temple_MEAN = BY_MONTH_AGET_INSR_TABLE[key].mean(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_aget_insr_temple_MEAN.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'AGET_INSR_'</span>+key+<span class="string">'_MEAN'</span>)]</span><br><span class="line">        train_aget_insr_temple_MAX = BY_MONTH_AGET_INSR_TABLE[key].max(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_aget_insr_temple_MAX.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'AGET_INSR_'</span>+key+<span class="string">'_MAX'</span>)]</span><br><span class="line">        train_aget_insr_temple_MIN = BY_MONTH_AGET_INSR_TABLE[key].min(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_aget_insr_temple_MIN.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'AGET_INSR_'</span>+key+<span class="string">'_MIN'</span>)]</span><br><span class="line">        <span class="comment"># 合并字段</span></span><br><span class="line">        train_aget_insr_temple = pd.merge(train_aget_insr_temple_STD, train_aget_insr_temple_MEAN, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_aget_insr_temple = pd.merge(train_aget_insr_temple, train_aget_insr_temple_MAX, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_aget_insr_temple = pd.merge(train_aget_insr_temple, train_aget_insr_temple_MIN, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        <span class="keyword">return</span> train_aget_insr_temple</span><br><span class="line">    train_aget_insr_temple = BY_MONTH_AGET_INSR(<span class="string">'PREM'</span>)</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> [<span class="string">'CVAG'</span>, <span class="string">'INSE_CNT'</span>, <span class="string">'MTH_PREM_ACCM'</span>, <span class="string">'BEG_MTH_PREM_BAL'</span>]:</span><br><span class="line">        train_aget_insr_temple = pd.merge(train_aget_insr_temple, BY_MONTH_AGET_INSR(key))</span><br><span class="line">        train_aget_insr_temple.drop_duplicates(subset=<span class="keyword">None</span>, keep=<span class="string">'first'</span>, inplace=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> train_aget_insr_temple</span><br></pre></td></tr></table></figure>

<h3 id="表间融合"><a href="#表间融合" class="headerlink" title="表间融合"></a>表间融合</h3><h4 id="TRAIN集"><a href="#TRAIN集" class="headerlink" title="TRAIN集"></a>TRAIN集</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># train 集 38256</span></span><br><span class="line">dataset_train = pd.merge(IDV_CUST_BASIC_PARSE(CALC_AGE(train_idv_cust_basic)), IDV_TD_PARSE(train_idv_td), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_train = pd.merge(dataset_train, IDV_DPSA_PARSE(train_idv_dpsa), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_train = pd.merge(dataset_train, TR_DC_PARSE(train_tr_dc), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_train = pd.merge(dataset_train, BY_MONTH_IDV_TD_METHOD(train_idv_td), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_train = pd.merge(dataset_train, BY_MONTH_IDV_DPSA_METHOD(train_idv_dpsa), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_train = pd.merge(dataset_train, BY_MONTH_TR_DC_METHOD(train_tr_dc), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_train = pd.merge(dataset_train, THR_PTY_CSTD_PARSE(train_thr_pty_cstd), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_train = pd.merge(dataset_train, BY_MONTH_LOAN_METHOD(train_loan), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_train = pd.merge(dataset_train, BY_MONTH_FUND_METHOD(train_fund), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_train = pd.merge(dataset_train, BY_MONTH_BOND_METHOD(train_bond), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_train = pd.merge(dataset_train, BY_MONTH_PREC_METAL_METHOD(train_prec_metal), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_train = pd.merge(dataset_train, BY_MONTH_AGET_INSR_METHOD(train_aget_insr), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_train = pd.merge(dataset_train, AUM_NUMS(train_idv_td, train_bond, train_fund, train_prec_metal, train_aget_insr, train_idv_cust_basic), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_train = pd.merge(WEALTH(train_cust_result,train_idv_td,train_bond,train_fund,train_prec_metal,train_aget_insr,train_thr_pty_cstd), dataset_train, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br></pre></td></tr></table></figure>

<pre><code>/root/anaconda3/lib/python3.6/site-packages/ipykernel_launcher.py:20: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
/root/anaconda3/lib/python3.6/site-packages/ipykernel_launcher.py:26: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
/root/anaconda3/lib/python3.6/site-packages/pandas/core/reshape/merge.py:558: UserWarning: merging between different levels can give an unintended result (1 levels on the left, 2 on the right)
  warnings.warn(msg, UserWarning)
/root/anaconda3/lib/python3.6/site-packages/pandas/core/generic.py:2530: PerformanceWarning: dropping on a non-lexsorted multi-index without a level parameter may impact performance.
  obj = obj._drop_axis(labels, axis, level=level, errors=errors)</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将个人客户基本信息表与结果整合</span></span><br><span class="line">dataset_train = pd.merge(dataset_train, train_cust_result, on=<span class="string">'CUST_NO'</span>)</span><br></pre></td></tr></table></figure>

<h4 id="TRAIN-剪枝"><a href="#TRAIN-剪枝" class="headerlink" title="TRAIN 剪枝"></a>TRAIN 剪枝</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除无用字段</span></span><br><span class="line">dataset_train = dataset_train.drop([<span class="string">'CUST_NO'</span>], axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h4 id="A集"><a href="#A集" class="headerlink" title="A集"></a>A集</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A 集 4782</span></span><br><span class="line">dataset_A = pd.merge(IDV_CUST_BASIC_PARSE(CALC_AGE(A_idv_cust_basic)), IDV_TD_PARSE(A_idv_td), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_A = pd.merge(dataset_A, IDV_DPSA_PARSE(A_idv_dpsa), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_A = pd.merge(dataset_A, TR_DC_PARSE(A_tr_dc), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_A = pd.merge(dataset_A, BY_MONTH_IDV_TD_METHOD(A_idv_td), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_A = pd.merge(dataset_A, BY_MONTH_IDV_DPSA_METHOD(A_idv_dpsa), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_A = pd.merge(dataset_A, BY_MONTH_TR_DC_METHOD(A_tr_dc), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_A = pd.merge(dataset_A, THR_PTY_CSTD_PARSE(A_thr_pty_cstd), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_A = pd.merge(dataset_A, BY_MONTH_LOAN_METHOD(A_loan), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_A = pd.merge(dataset_A, BY_MONTH_FUND_METHOD(A_fund), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_A = pd.merge(dataset_A, BY_MONTH_BOND_METHOD(A_bond), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_A = pd.merge(dataset_A, BY_MONTH_PREC_METAL_METHOD(A_prec_metal), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_A = pd.merge(dataset_A, BY_MONTH_AGET_INSR_METHOD(A_aget_insr), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_A = pd.merge(dataset_A, AUM_NUMS(A_idv_td, A_bond, A_fund, A_prec_metal, A_aget_insr, A_idv_cust_basic), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_A = pd.merge(WEALTH(A_customid,A_idv_td,A_bond,A_fund,A_prec_metal,A_aget_insr,A_thr_pty_cstd), dataset_A, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br></pre></td></tr></table></figure>

<pre><code>/root/anaconda3/lib/python3.6/site-packages/ipykernel_launcher.py:20: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
/root/anaconda3/lib/python3.6/site-packages/ipykernel_launcher.py:26: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
/root/anaconda3/lib/python3.6/site-packages/pandas/core/reshape/merge.py:558: UserWarning: merging between different levels can give an unintended result (1 levels on the left, 2 on the right)
  warnings.warn(msg, UserWarning)
/root/anaconda3/lib/python3.6/site-packages/pandas/core/generic.py:2530: PerformanceWarning: dropping on a non-lexsorted multi-index without a level parameter may impact performance.
  obj = obj._drop_axis(labels, axis, level=level, errors=errors)</code></pre><h4 id="A-剪枝"><a href="#A-剪枝" class="headerlink" title="A 剪枝"></a>A 剪枝</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除无用字段</span></span><br><span class="line">dataset_A = dataset_A.drop([<span class="string">'CUST_NO'</span>], axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h4 id="B集"><a href="#B集" class="headerlink" title="B集"></a>B集</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A 集 4782</span></span><br><span class="line">dataset_B = pd.merge(IDV_CUST_BASIC_PARSE(CALC_AGE(B_idv_cust_basic)), IDV_TD_PARSE(B_idv_td), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_B = pd.merge(dataset_B, IDV_DPSA_PARSE(B_idv_dpsa), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_B = pd.merge(dataset_B, TR_DC_PARSE(B_tr_dc), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_B = pd.merge(dataset_B, BY_MONTH_IDV_TD_METHOD(B_idv_td), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_B = pd.merge(dataset_B, BY_MONTH_IDV_DPSA_METHOD(B_idv_dpsa), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_B = pd.merge(dataset_B, BY_MONTH_TR_DC_METHOD(B_tr_dc), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_B = pd.merge(dataset_B, THR_PTY_CSTD_PARSE(B_thr_pty_cstd), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_B = pd.merge(dataset_B, BY_MONTH_LOAN_METHOD(B_loan), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_B = pd.merge(dataset_B, BY_MONTH_FUND_METHOD(B_fund), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_B = pd.merge(dataset_B, BY_MONTH_BOND_METHOD(B_bond), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_B = pd.merge(dataset_B, BY_MONTH_PREC_METAL_METHOD(B_prec_metal), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_B = pd.merge(dataset_B, BY_MONTH_AGET_INSR_METHOD(B_aget_insr), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_B = pd.merge(dataset_B, AUM_NUMS(B_idv_td, B_bond, B_fund, B_prec_metal, B_aget_insr, B_idv_cust_basic), on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br><span class="line">dataset_B = pd.merge(WEALTH(B_customid,B_idv_td,B_bond,B_fund,B_prec_metal,B_aget_insr,B_thr_pty_cstd), dataset_B, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br></pre></td></tr></table></figure>

<pre><code>/root/anaconda3/lib/python3.6/site-packages/ipykernel_launcher.py:20: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
/root/anaconda3/lib/python3.6/site-packages/ipykernel_launcher.py:26: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
/root/anaconda3/lib/python3.6/site-packages/pandas/core/reshape/merge.py:558: UserWarning: merging between different levels can give an unintended result (1 levels on the left, 2 on the right)
  warnings.warn(msg, UserWarning)
/root/anaconda3/lib/python3.6/site-packages/pandas/core/generic.py:2530: PerformanceWarning: dropping on a non-lexsorted multi-index without a level parameter may impact performance.
  obj = obj._drop_axis(labels, axis, level=level, errors=errors)</code></pre><h4 id="B集剪枝"><a href="#B集剪枝" class="headerlink" title="B集剪枝"></a>B集剪枝</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除无用字段</span></span><br><span class="line">dataset_B = dataset_B.drop([<span class="string">'CUST_NO'</span>], axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h4 id="欠采样"><a href="#欠采样" class="headerlink" title="欠采样"></a>欠采样</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train_SAMPLE = pd.concat([dataset_train[dataset_train[<span class="string">'FLAG'</span>]==<span class="number">0</span>].sample(frac=<span class="number">0.20</span>),dataset_train[dataset_train[<span class="string">'FLAG'</span>]==<span class="number">1</span>]],axis=<span class="number">0</span>).sample(frac=<span class="number">1.0</span>)</span><br></pre></td></tr></table></figure>

<h3 id="算法分析"><a href="#算法分析" class="headerlink" title="算法分析"></a>算法分析</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np  </span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd  </span><br><span class="line"><span class="keyword">import</span> xgboost <span class="keyword">as</span> xgb  </span><br><span class="line"><span class="keyword">import</span> time  </span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> StratifiedKFold  </span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> imblearn.over_sampling <span class="keyword">import</span> SMOTE</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> GridSearchCV</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建特征  </span></span><br><span class="line"><span class="comment">#X = dataset_train.drop(['FLAG'],axis=1).fillna(0)</span></span><br><span class="line"><span class="comment">#y = dataset_train['FLAG']</span></span><br><span class="line">X = train_SAMPLE.drop([<span class="string">'FLAG'</span>],axis=<span class="number">1</span>).fillna(<span class="number">0</span>)</span><br><span class="line">y = train_SAMPLE[<span class="string">'FLAG'</span>]</span><br><span class="line"><span class="comment"># X = dataset_train_SAMPLE.drop(['FLAG'],axis=1)</span></span><br><span class="line"><span class="comment"># y = dataset_train_SAMPLE['FLAG']</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 用sklearn.cross_validation进行训练数据集划分</span></span><br><span class="line">X, val_X, y, val_y = train_test_split(  </span><br><span class="line">    X,  </span><br><span class="line">    y,  </span><br><span class="line">    test_size=<span class="number">0.01</span>,</span><br><span class="line">    <span class="comment">#test_size=0.125,</span></span><br><span class="line">    random_state=<span class="number">2020</span>,  </span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># SMOTE过采样</span></span><br><span class="line"><span class="comment"># smo = SMOTE(random_state=2019)</span></span><br><span class="line"><span class="comment"># X_smo, y_smo = smo.fit_sample(X, y)</span></span><br><span class="line"><span class="comment"># X_smo = pd.DataFrame(X_smo)</span></span><br><span class="line"><span class="comment"># X_smo.columns=['XXX']</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np  </span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd  </span><br><span class="line"><span class="keyword">import</span> xgboost <span class="keyword">as</span> xgb  </span><br><span class="line"><span class="keyword">import</span> time  </span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> StratifiedKFold  </span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> imblearn.over_sampling <span class="keyword">import</span> SMOTE</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> GridSearchCV</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建特征  </span></span><br><span class="line">X = dataset_train.drop([<span class="string">'FLAG'</span>],axis=<span class="number">1</span>).fillna(<span class="number">0</span>)</span><br><span class="line">y = dataset_train[<span class="string">'FLAG'</span>]</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 用sklearn.cross_validation进行训练数据集划分</span></span><br><span class="line">X, val_X, y, val_y = train_test_split(  </span><br><span class="line">    X,  </span><br><span class="line">    y,  </span><br><span class="line">    test_size=<span class="number">0.125</span>,</span><br><span class="line">    random_state=<span class="number">2019</span>,  </span><br><span class="line">)</span><br><span class="line">train_REAL = pd.concat([X,y],axis=<span class="number">1</span>)</span><br><span class="line">train_REAL = pd.concat([train_REAL[train_REAL[<span class="string">'FLAG'</span>]==<span class="number">0</span>].sample(frac=<span class="number">0.20</span>),train_REAL[train_REAL[<span class="string">'FLAG'</span>]==<span class="number">1</span>]],axis=<span class="number">0</span>).sample(frac=<span class="number">1.0</span>)</span><br><span class="line">X = train_REAL.drop([<span class="string">'FLAG'</span>],axis=<span class="number">1</span>)</span><br><span class="line">y = train_REAL[<span class="string">'FLAG'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="XGB算法"><a href="#XGB算法" class="headerlink" title="XGB算法"></a>XGB算法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># xgb矩阵赋值  </span></span><br><span class="line">xgb_val = xgb.DMatrix(val_X, label=val_y)  </span><br><span class="line"><span class="comment"># xgb_train = xgb.DMatrix(X_smo, label=y_smo)</span></span><br><span class="line">xgb_train = xgb.DMatrix(X, label=y)</span><br><span class="line">  </span><br><span class="line"><span class="comment"># xgboost模型#</span></span><br><span class="line">params = &#123;  </span><br><span class="line">    <span class="string">'booster'</span>: <span class="string">'gbtree'</span>,  </span><br><span class="line">    <span class="comment"># 'objective': 'multi:softmax',  # 多分类的问题、  </span></span><br><span class="line">    <span class="comment"># 'objective': 'multi:softprob',   # 多分类概率  </span></span><br><span class="line">    <span class="string">'objective'</span>: <span class="string">'binary:logistic'</span>,  </span><br><span class="line">    <span class="string">'eval_metric'</span>: <span class="string">'logloss'</span>,  </span><br><span class="line">    <span class="comment"># 'num_class': 9,  # 类别数，与 multisoftmax 并用  </span></span><br><span class="line">    <span class="string">'gamma'</span>: <span class="number">0.1</span>,  <span class="comment"># 用于控制是否后剪枝的参数,越大越保守，一般0.1、0.2这样子。  </span></span><br><span class="line">    <span class="string">'max_depth'</span>: <span class="number">5</span>,  <span class="comment"># 构建树的深度，越大越容易过拟合  </span></span><br><span class="line">    <span class="string">'alpha'</span>: <span class="number">0</span>,   <span class="comment"># L1正则化系数  </span></span><br><span class="line">    <span class="string">'lambda'</span>: <span class="number">8</span>,  <span class="comment"># 控制模型复杂度的权重值的L2正则化项参数，参数越大，模型越不容易过拟合。  </span></span><br><span class="line">    <span class="string">'subsample'</span>: <span class="number">1</span>,  <span class="comment"># 随机采样训练样本  </span></span><br><span class="line">    <span class="string">'colsample_bytree'</span>: <span class="number">0.6</span>,  <span class="comment"># 生成树时进行的列采样  </span></span><br><span class="line">    <span class="string">'min_child_weight'</span>: <span class="number">3</span>,  </span><br><span class="line">    <span class="comment"># 这个参数默认是 1，是每个叶子里面 h 的和至少是多少，对正负样本不均衡时的 0-1 分类而言  </span></span><br><span class="line">    <span class="comment"># ，假设 h 在 0.01 附近，min_child_weight 为 1 意味着叶子节点中最少需要包含 100 个样本。  </span></span><br><span class="line">    <span class="comment"># 这个参数非常影响结果，控制叶子节点中二阶导的和的最小值，该参数值越小，越容易 overfitting。  </span></span><br><span class="line">    <span class="string">'silent'</span>: <span class="number">0</span>,  <span class="comment"># 设置成1则没有运行信息输出，最好是设置为0.  </span></span><br><span class="line">    <span class="string">'eta'</span>: <span class="number">0.01</span> ,</span><br><span class="line">    <span class="comment">#'eta': 0.1,  # 如同学习率 - result 0.554455</span></span><br><span class="line">    <span class="string">'seed'</span>: <span class="number">1000</span>,  </span><br><span class="line">    <span class="string">'nthread'</span>: <span class="number">24</span>,  <span class="comment"># cpu 线程数  </span></span><br><span class="line">    <span class="string">'missing'</span>: <span class="number">1</span>,  </span><br><span class="line">    <span class="string">'scale_pos_weight'</span>: (np.sum(y==<span class="number">0</span>)/np.sum(y==<span class="number">1</span>))  <span class="comment"># 用来处理正负样本不均衡的问题,通常取：sum(negative cases) / sum(positive cases)  </span></span><br><span class="line">    <span class="comment"># 'eval_metric': 'auc'  </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">plst = list(params.items())  </span><br><span class="line">num_rounds = <span class="number">30000</span>  <span class="comment"># 迭代次数  </span></span><br><span class="line">watchlist = [(xgb_train, <span class="string">'train'</span>), (xgb_val, <span class="string">'val'</span>)]  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 交叉验证  </span></span><br><span class="line">result = xgb.cv(plst, xgb_train, num_boost_round=<span class="number">200</span>, nfold=<span class="number">4</span>, early_stopping_rounds=<span class="number">200</span>, verbose_eval=<span class="keyword">True</span>, folds=StratifiedKFold(n_splits=<span class="number">4</span>).split(X, y))  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 训练模型并保存  </span></span><br><span class="line"><span class="comment"># early_stopping_rounds 当设置的迭代次数较大时，early_stopping_rounds 可在一定的迭代次数内准确率没有提升就停止训练  </span></span><br><span class="line">model = xgb.train(plst, xgb_train, num_rounds, watchlist, early_stopping_rounds=<span class="number">400</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模型保存</span></span><br><span class="line">model.save_model(<span class="string">'./leezy_xgb.model'</span>)  <span class="comment"># 用于存储训练出的模型</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 读取模型</span></span><br><span class="line"><span class="comment"># model = xgb.Booster(model_file='5903-xgb.model')</span></span><br><span class="line"><span class="comment"># 本地验证</span></span><br><span class="line">xgb_test = xgb.DMatrix(val_X) </span><br><span class="line">preds = model.predict(xgb_test)</span><br><span class="line"><span class="comment"># 导出结果  </span></span><br><span class="line">threshold = <span class="number">0.70</span></span><br><span class="line">ans = []</span><br><span class="line"><span class="keyword">for</span> pred <span class="keyword">in</span> preds:  </span><br><span class="line">    result = <span class="number">1</span> <span class="keyword">if</span> pred &gt; threshold <span class="keyword">else</span> <span class="number">0</span> </span><br><span class="line">    ans.append(result)</span><br><span class="line">pred_result= pd.Series(ans, dtype=<span class="string">'int32'</span>)</span><br><span class="line">evaluate(val_y, pred_result)</span><br></pre></td></tr></table></figure>

<pre><code>test_pct_1: 0.1581
pred_pct_1: 0.1836
Precesion: 0.5581
Recall: 0.6481
F1-score: 0.5998
confusion matrix:
[[3638  388]
 [ 266  490]]

{&apos;Confusuion&apos;: array([[3638,  388],
        [ 266,  490]]),
 &apos;F1&apos;: 0.5997552019583843,
 &apos;Precision&apos;: 0.5580865603644647,
 &apos;acc&apos;: 0.863237139272271,
 &apos;pred_pct_1&apos;: 0.1836051861145964,
 &apos;recall&apos;: 0.6481481481481481,
 &apos;roc_auc&apos;: 0.7758872881823701,
 &apos;test_pct_1&apos;: 0.15809284818067754}</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A集训练</span></span><br><span class="line">xgb_A = xgb.DMatrix(dataset_A)</span><br><span class="line">A_preds = model.predict(xgb_A)  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 导出结果  </span></span><br><span class="line">threshold = <span class="number">0.40</span></span><br><span class="line">ans = []</span><br><span class="line"><span class="keyword">for</span> pred <span class="keyword">in</span> A_preds:  </span><br><span class="line">    result = <span class="number">1</span> <span class="keyword">if</span> pred &gt; threshold <span class="keyword">else</span> <span class="number">0</span> </span><br><span class="line">    ans.append(result)</span><br><span class="line">pred_A_result= pd.Series(ans, dtype=<span class="string">'int32'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># B集训练</span></span><br><span class="line">xgb_B = xgb.DMatrix(dataset_B)</span><br><span class="line">B_preds = model.predict(xgb_B)  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 导出结果  </span></span><br><span class="line">threshold = <span class="number">0.68</span></span><br><span class="line">ans = []</span><br><span class="line"><span class="keyword">for</span> pred <span class="keyword">in</span> B_preds:  </span><br><span class="line">    result = <span class="number">1</span> <span class="keyword">if</span> pred &gt; threshold <span class="keyword">else</span> <span class="number">0</span> </span><br><span class="line">    ans.append(result)</span><br><span class="line">pred_B_result= pd.Series(ans, dtype=<span class="string">'int32'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> operator</span><br><span class="line">importance = model.get_fscore()</span><br><span class="line">importance = sorted(importance.items(), key=operator.itemgetter(<span class="number">1</span>))</span><br><span class="line"><span class="comment"># print(importance)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">plt.rcParams[<span class="string">"figure.figsize"</span>]=(<span class="number">30</span>,<span class="number">40</span>)</span><br><span class="line">xgb.plot_importance(model, max_num_features=<span class="number">100</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<pre><code>/root/anaconda3/lib/python3.6/site-packages/matplotlib/font_manager.py:1320: UserWarning: findfont: Font family [&apos;sans-serif&apos;] not found. Falling back to DejaVu Sans
  (prop.get_family(), self.defaultFamily[fontext]))</code></pre><p><img src="/assets/blogImg/OUTPUT_IMPORTANCES.png" alt="IMPORTANCES"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看特征排名</span></span><br><span class="line">feature_rank(model, <span class="number">30</span>)</span><br></pre></td></tr></table></figure>

<h3 id="提交结果"><a href="#提交结果" class="headerlink" title="提交结果"></a>提交结果</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pred_B_result.value_counts()</span><br></pre></td></tr></table></figure>

<pre><code>0    3901
1     881
dtype: int64</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 合并结果</span></span><br><span class="line">result = pd.concat([B_customid, pred_B_result],axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result.to_csv(<span class="string">'111.csv'</span>,header=<span class="number">0</span>,index=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">init_woody</span><br></pre></td></tr></table></figure>

<pre><code>The prv extension is already loaded. To reload it, use:
  %reload_ext prv
Matplotlib env init complete.
Warnings off.</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">predict <span class="number">2</span> <span class="number">000.</span>csv</span><br></pre></td></tr></table></figure>

<pre><code>&apos;提交次数已用完，请明日再试！&apos;</code></pre><h3 id="深化特征工程"><a href="#深化特征工程" class="headerlink" title="深化特征工程"></a>深化特征工程</h3><h4 id="各类理财产品的持有数量"><a href="#各类理财产品的持有数量" class="headerlink" title="各类理财产品的持有数量"></a>各类理财产品的持有数量</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">train_idv_td = pd.read_csv(<span class="string">"../data/2/train/IDV_TD.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 个人定期存款账户信息（IDV_TD）</span></span><br><span class="line">train_bond = pd.read_csv(<span class="string">"../data/2/train/BOND.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 国债账户信息（BOND）</span></span><br><span class="line">train_fund = pd.read_csv(<span class="string">"../data/2/train/FUND.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 基金账户信息（FUND）</span></span><br><span class="line">train_prec_metal = pd.read_csv(<span class="string">"../data/2/train/PREC_METAL.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 贵金属账户信息（PREC_METAL）</span></span><br><span class="line">train_aget_insr = pd.read_csv(<span class="string">"../data/2/train/AGET_INSR.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 代理保险账户信息（AGET_INSR）</span></span><br><span class="line">train_idv_cust_basic = pd.read_csv(<span class="string">"../data/2/train/IDV_CUST_BASIC.csv"</span>, encoding=<span class="string">'utf-8'</span>) <span class="comment"># 个人客户基本信息（IDV_CUST_BASIC）</span></span><br></pre></td></tr></table></figure>

<pre><code>/root/anaconda3/lib/python3.6/site-packages/IPython/core/interactiveshell.py:2728: DtypeWarning: Columns (12) have mixed types. Specify dtype option on import or set low_memory=False.
  interactivity=interactivity, compiler=compiler, result=result)</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定期的个数</span></span><br><span class="line">train_idv_td_3 = train_idv_td[train_idv_td[<span class="string">'DATA_DAT'</span>]==<span class="number">3734035200</span>]</span><br><span class="line">train_idv_td_AUM = train_idv_td_3[[<span class="string">'CUST_NO'</span>, <span class="string">'ARG_CRT_DAT'</span>]]</span><br><span class="line">train_idv_td_num = train_idv_td_AUM.groupby(<span class="string">'CUST_NO'</span>).count().reset_index()</span><br><span class="line">train_idv_td_num.rename(columns=&#123;<span class="string">'ARG_CRT_DAT'</span>:<span class="string">'IDV_TD_NUM'</span>&#125;, inplace=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 国债的个数</span></span><br><span class="line">train_bond_3 = train_bond[train_bond[<span class="string">'DATA_DAT'</span>]==<span class="number">3734035200</span>]</span><br><span class="line">train_bond_AUM = train_bond_3[[<span class="string">'CUST_NO'</span>, <span class="string">'ARG_CRT_DAT'</span>]]</span><br><span class="line">train_bond_num = train_bond_AUM.groupby(<span class="string">'CUST_NO'</span>).count().reset_index()</span><br><span class="line">train_bond_num.rename(columns=&#123;<span class="string">'ARG_CRT_DAT'</span>:<span class="string">'BOND_NUM'</span>&#125;, inplace=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基金的个数</span></span><br><span class="line">train_fund_3 = train_fund[train_fund[<span class="string">'DATA_DAT'</span>]==<span class="number">3734035200</span>]</span><br><span class="line">train_fund_AUM = train_fund[[<span class="string">'CUST_NO'</span>, <span class="string">'ARG_CRT_DAT'</span>]]</span><br><span class="line">train_fund_num = train_fund_AUM.groupby(<span class="string">'CUST_NO'</span>).count().reset_index()</span><br><span class="line">train_fund_num.rename(columns=&#123;<span class="string">'ARG_CRT_DAT'</span>:<span class="string">'FUND_NUM'</span>&#125;, inplace=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 贵金属的个数</span></span><br><span class="line">train_prec_metal_3 = train_prec_metal[train_prec_metal[<span class="string">'DATA_DAT'</span>]==<span class="number">3734035200</span>]</span><br><span class="line">train_prec_metal_3.dropna(subset=[<span class="string">'SIGD_DAT'</span>], inplace=<span class="keyword">True</span>)</span><br><span class="line">train_prec_metal_AUM = train_prec_metal_3[[<span class="string">'CUST_NO'</span>, <span class="string">'SIGD_DAT'</span>]]</span><br><span class="line">train_prec_metal_num = train_prec_metal_AUM.groupby(<span class="string">'CUST_NO'</span>).count().reset_index()</span><br><span class="line">train_prec_metal_num.rename(columns=&#123;<span class="string">'SIGD_DAT'</span>:<span class="string">'PREC_METAL_NUM'</span>&#125;, inplace=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>

<pre><code>/root/anaconda3/lib/python3.6/site-packages/ipykernel_launcher.py:3: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
  This is separate from the ipykernel package so we can avoid doing imports until</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 保险的个数</span></span><br><span class="line">train_aget_insr_3 = train_aget_insr[train_aget_insr[<span class="string">'DATA_DAT'</span>]==<span class="number">3734035200</span>]</span><br><span class="line">train_aget_insr_3.dropna(subset=[<span class="string">'INSE_DAT'</span>], inplace=<span class="keyword">True</span>)</span><br><span class="line">train_aget_insr_AUM = train_aget_insr_3[[<span class="string">'CUST_NO'</span>, <span class="string">'INSE_DAT'</span>]]</span><br><span class="line">train_aget_insr_num = train_aget_insr_AUM.groupby(<span class="string">'CUST_NO'</span>).count().reset_index()</span><br><span class="line">train_aget_insr_num.rename(columns=&#123;<span class="string">'INSE_DAT'</span>:<span class="string">'AGET_INSR_NUM'</span>&#125;, inplace=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>

<pre><code>/root/anaconda3/lib/python3.6/site-packages/ipykernel_launcher.py:3: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
  This is separate from the ipykernel package so we can avoid doing imports until</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户ID</span></span><br><span class="line">CUST_NO_LSIT = train_idv_cust_basic[<span class="string">'CUST_NO'</span>].reset_index().drop(<span class="string">'index'</span>, axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 合并为一个表</span></span><br><span class="line">CUST_NO_AUM_LSIT = pd.merge(pd.merge(pd.merge(pd.merge(pd.merge(CUST_NO_LSIT, train_idv_td_num, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>), train_bond_num, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>), train_fund_num, </span><br><span class="line">                            on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>), train_prec_metal_num, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>), train_aget_insr_num, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>).fillna(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CUST_NO_AUM_LSIT[<span class="string">'PRODUCTS_NUM'</span>] = CUST_NO_AUM_LSIT[[<span class="string">'IDV_TD_NUM'</span>,<span class="string">'BOND_NUM'</span>,<span class="string">'FUND_NUM'</span>,<span class="string">'PREC_METAL_NUM'</span>,<span class="string">'AGET_INSR_NUM'</span>]].sum(axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CUST_NO_AUM_LSIT[CUST_NO_AUM_LSIT[<span class="string">'CUST_NO'</span>] == <span class="string">'a100d07faf0bc3c60d7d65abd704142a'</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CUST_NO_AUM_LSIT.head(<span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MyAUMTest = pd.merge(CUST_NO_AUM_LSIT, train_cust_result, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MyAUMTest.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CUST_NO_AUM_LSIT.shape</span><br></pre></td></tr></table></figure>

<pre><code>(38256, 6)</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关联关系</span></span><br><span class="line">g = sns.heatmap(MyAUMTest[[<span class="string">'FLAG'</span>, <span class="string">'IDV_TD_NUM'</span>,<span class="string">'BOND_NUM'</span>,<span class="string">'FUND_NUM'</span>,<span class="string">'PREC_METAL_NUM'</span>,<span class="string">'AGET_INSR_NUM'</span>,<span class="string">'PRODUCTS_NUM'</span>]].corr(), annot=<span class="keyword">True</span>, cmap=<span class="string">"coolwarm"</span>)</span><br></pre></td></tr></table></figure>

<pre><code>/root/anaconda3/lib/python3.6/site-packages/matplotlib/font_manager.py:1320: UserWarning: findfont: Font family [&apos;sans-serif&apos;] not found. Falling back to DejaVu Sans
  (prop.get_family(), self.defaultFamily[fontext]))</code></pre><p><img src="/assets/blogImg/OUTPUT_HEATMAP.png" alt="HEATMAP"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取到所有投资种类的和</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AUM_NUMS</span><span class="params">(train_idv_td, train_bond, train_fund, train_prec_metal, train_aget_insr, train_idv_cust_basic)</span>:</span></span><br><span class="line">    <span class="comment"># 定期的个数</span></span><br><span class="line">    train_idv_td_3 = train_idv_td[train_idv_td[<span class="string">'DATA_DAT'</span>]==<span class="number">3734035200</span>]</span><br><span class="line">    train_idv_td_AUM = train_idv_td_3[[<span class="string">'CUST_NO'</span>, <span class="string">'ARG_CRT_DAT'</span>]]</span><br><span class="line">    train_idv_td_num = train_idv_td_AUM.groupby(<span class="string">'CUST_NO'</span>).count().reset_index()</span><br><span class="line">    train_idv_td_num.rename(columns=&#123;<span class="string">'ARG_CRT_DAT'</span>:<span class="string">'IDV_TD_NUM'</span>&#125;, inplace=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># 国债的个数</span></span><br><span class="line">    train_bond_3 = train_bond[train_bond[<span class="string">'DATA_DAT'</span>]==<span class="number">3734035200</span>]</span><br><span class="line">    train_bond_AUM = train_bond_3[[<span class="string">'CUST_NO'</span>, <span class="string">'ARG_CRT_DAT'</span>]]</span><br><span class="line">    train_bond_num = train_bond_AUM.groupby(<span class="string">'CUST_NO'</span>).count().reset_index()</span><br><span class="line">    train_bond_num.rename(columns=&#123;<span class="string">'ARG_CRT_DAT'</span>:<span class="string">'BOND_NUM'</span>&#125;, inplace=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># 基金的个数</span></span><br><span class="line">    train_fund_3 = train_fund[train_fund[<span class="string">'DATA_DAT'</span>]==<span class="number">3734035200</span>]</span><br><span class="line">    train_fund_AUM = train_fund[[<span class="string">'CUST_NO'</span>, <span class="string">'ARG_CRT_DAT'</span>]]</span><br><span class="line">    train_fund_num = train_fund_AUM.groupby(<span class="string">'CUST_NO'</span>).count().reset_index()</span><br><span class="line">    train_fund_num.rename(columns=&#123;<span class="string">'ARG_CRT_DAT'</span>:<span class="string">'FUND_NUM'</span>&#125;, inplace=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># 贵金属的个数</span></span><br><span class="line">    train_prec_metal_3 = train_prec_metal[train_prec_metal[<span class="string">'DATA_DAT'</span>]==<span class="number">3734035200</span>]</span><br><span class="line">    train_prec_metal_3.dropna(subset=[<span class="string">'SIGD_DAT'</span>], inplace=<span class="keyword">True</span>)</span><br><span class="line">    train_prec_metal_AUM = train_prec_metal_3[[<span class="string">'CUST_NO'</span>, <span class="string">'SIGD_DAT'</span>]]</span><br><span class="line">    train_prec_metal_num = train_prec_metal_AUM.groupby(<span class="string">'CUST_NO'</span>).count().reset_index()</span><br><span class="line">    train_prec_metal_num.rename(columns=&#123;<span class="string">'SIGD_DAT'</span>:<span class="string">'PREC_METAL_NUM'</span>&#125;, inplace=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># 保险的个数</span></span><br><span class="line">    train_aget_insr_3 = train_aget_insr[train_aget_insr[<span class="string">'DATA_DAT'</span>]==<span class="number">3734035200</span>]</span><br><span class="line">    train_aget_insr_3.dropna(subset=[<span class="string">'INSE_DAT'</span>], inplace=<span class="keyword">True</span>)</span><br><span class="line">    train_aget_insr_AUM = train_aget_insr_3[[<span class="string">'CUST_NO'</span>, <span class="string">'INSE_DAT'</span>]]</span><br><span class="line">    train_aget_insr_num = train_aget_insr_AUM.groupby(<span class="string">'CUST_NO'</span>).count().reset_index()</span><br><span class="line">    train_aget_insr_num.rename(columns=&#123;<span class="string">'INSE_DAT'</span>:<span class="string">'AGET_INSR_NUM'</span>&#125;, inplace=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># 客户ID</span></span><br><span class="line">    CUST_NO_LSIT = train_idv_cust_basic[<span class="string">'CUST_NO'</span>].reset_index().drop(<span class="string">'index'</span>, axis=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 合并为一个表</span></span><br><span class="line">    CUST_NO_AUM_LSIT = pd.merge(pd.merge(pd.merge(pd.merge(pd.merge(CUST_NO_LSIT, train_idv_td_num, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>), train_bond_num, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>), train_fund_num, </span><br><span class="line">                            on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>), train_prec_metal_num, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>), train_aget_insr_num, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'outer'</span>).fillna(<span class="number">0</span>)</span><br><span class="line">    CUST_NO_AUM_LSIT[<span class="string">'PRODUCTS_NUM'</span>] = CUST_NO_AUM_LSIT[[<span class="string">'IDV_TD_NUM'</span>,<span class="string">'BOND_NUM'</span>,<span class="string">'FUND_NUM'</span>,<span class="string">'PREC_METAL_NUM'</span>,<span class="string">'AGET_INSR_NUM'</span>]].sum(axis=<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> CUST_NO_AUM_LSIT</span><br></pre></td></tr></table></figure>

<h4 id="三个月变动"><a href="#三个月变动" class="headerlink" title="三个月变动"></a>三个月变动</h4><h5 id="定期账户"><a href="#定期账户" class="headerlink" title="定期账户"></a>定期账户</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">BY_MONTH_IDV_TD_METHOD</span><span class="params">(dataset_IDV_TD)</span>:</span></span><br><span class="line">    <span class="comment"># 预处理</span></span><br><span class="line">    <span class="comment"># 简化IDV_TD表</span></span><br><span class="line">    train_idv_td_temple = dataset_IDV_TD.drop([<span class="string">'ARG_CRT_DAT'</span>, <span class="string">'CLS_ACCT_DAT'</span>, <span class="string">'MATU_DAT'</span>, <span class="string">'LAC'</span>, <span class="string">'ACCT_STS_CD'</span>,<span class="string">'DP_DAY_CD'</span>, <span class="string">'RDEP_IND_CD'</span>, <span class="string">'RDEP_DP_DAY_CD'</span>, <span class="string">'RAT_CTG'</span>,<span class="string">'FXDI_SA_ACCM'</span>, <span class="string">'MTH_ACT_DAYS_TOT'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 将train_idv_td和train_base_excg合并</span></span><br><span class="line">    train_idv_td_temple = pd.merge(train_idv_td_temple, train_base_excg, on = <span class="string">'CCY_CD'</span>)</span><br><span class="line">    <span class="comment"># 执行汇率计算函数</span></span><br><span class="line">    train_idv_td_temple[<span class="string">'CRBAL'</span>] = train_idv_td_temple.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'CRBAL'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_idv_td_temple[<span class="string">'REG_CAP'</span>] = train_idv_td_temple.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'REG_CAP'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_idv_td_temple[<span class="string">'FXDI_T_ACCM'</span>] = train_idv_td_temple.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'FXDI_T_ACCM'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_idv_td_temple[<span class="string">'TDOP_SHD_PAY_INTS'</span>] = train_idv_td_temple.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'TDOP_SHD_PAY_INTS'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_idv_td_temple[<span class="string">'MOTH_CR_ACCM'</span>] = train_idv_td_temple.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'MOTH_CR_ACCM'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_idv_td_temple = train_idv_td_temple.drop([<span class="string">'CCY_CD'</span>, <span class="string">'RMB_MID_PRIC'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 按月将金额分类</span></span><br><span class="line">    BY_MONTH_TD = train_idv_td_temple.groupby([<span class="string">'CUST_NO'</span>, <span class="string">'DATA_DAT'</span>])[[<span class="string">'CRBAL'</span>, <span class="string">'REG_CAP'</span>, <span class="string">'FXDI_T_ACCM'</span>, <span class="string">'TDOP_SHD_PAY_INTS'</span>, <span class="string">'MOTH_CR_ACCM'</span>]].sum().unstack()</span><br><span class="line">    <span class="comment"># 声明函数 计算三个月的标准差、均值、最大值、最小值</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">BY_MONTH_IDV_TD</span><span class="params">(key)</span>:</span></span><br><span class="line">        train_idv_td_temple_STD = BY_MONTH_TD[key].std(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_idv_td_temple_STD.columns = [<span class="string">'CUST_NO'</span>, str(<span class="string">'IDV_TD_'</span>+key+<span class="string">'_STD'</span>)]</span><br><span class="line">        train_idv_td_temple_MEAN = BY_MONTH_TD[key].mean(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_idv_td_temple_MEAN.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'IDV_TD_'</span>+key+<span class="string">'_MEAN'</span>)]</span><br><span class="line">        train_idv_td_temple_MAX = BY_MONTH_TD[key].max(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_idv_td_temple_MAX.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'IDV_TD_'</span>+key+<span class="string">'_MAX'</span>)]</span><br><span class="line">        train_idv_td_temple_MIN = BY_MONTH_TD[key].min(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_idv_td_temple_MIN.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'IDV_TD_'</span>+key+<span class="string">'_MIN'</span>)]</span><br><span class="line">        <span class="comment"># 合并字段</span></span><br><span class="line">        train_idv_td_temple = pd.merge(train_idv_td_temple_STD, train_idv_td_temple_MEAN, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_idv_td_temple = pd.merge(train_idv_td_temple, train_idv_td_temple_MAX, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_idv_td_temple = pd.merge(train_idv_td_temple, train_idv_td_temple_MIN, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_idv_td_temple = train_idv_td_temple.fillna(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> train_idv_td_temple</span><br><span class="line">    train_idv_td_temple = BY_MONTH_IDV_TD(<span class="string">'CRBAL'</span>)</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> [<span class="string">'REG_CAP'</span>, <span class="string">'FXDI_T_ACCM'</span>,<span class="string">'TDOP_SHD_PAY_INTS'</span>, <span class="string">'MOTH_CR_ACCM'</span>]:</span><br><span class="line">        train_idv_td_temple = pd.merge(train_idv_td_temple, BY_MONTH_IDV_TD(key))</span><br><span class="line">        train_idv_td_temple.drop_duplicates(subset=<span class="keyword">None</span>, keep=<span class="string">'first'</span>, inplace=<span class="keyword">True</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> train_idv_td_temple</span><br></pre></td></tr></table></figure>

<h5 id="活期账户"><a href="#活期账户" class="headerlink" title="活期账户"></a>活期账户</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">BY_MONTH_IDV_DPSA_METHOD</span><span class="params">(dataset_IDV_DPSA)</span>:</span></span><br><span class="line">    <span class="comment"># 预处理</span></span><br><span class="line">    <span class="comment"># 将IDV_DPSA表与汇率表整合</span></span><br><span class="line">    train_idv_dpsa_temple = pd.merge(dataset_IDV_DPSA, train_base_excg, on = <span class="string">'CCY_CD'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">    train_idv_dpsa_temple.drop_duplicates(subset=<span class="keyword">None</span>, keep=<span class="string">'first'</span>, inplace=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># 执行汇率计算函数</span></span><br><span class="line">    train_idv_dpsa_temple[<span class="string">'CRBAL'</span>] = train_idv_dpsa_temple.apply(compute_REAL_MONEY, axis=<span class="number">1</span>, args = (<span class="string">'CRBAL'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_idv_dpsa_temple[<span class="string">'ITST_BRNG_ACCM'</span>] = train_idv_dpsa_temple.apply(compute_REAL_MONEY, axis=<span class="number">1</span>, args = (<span class="string">'ITST_BRNG_ACCM'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_idv_dpsa_temple[<span class="string">'FRZ_TOT_AMT'</span>] = train_idv_dpsa_temple.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'FRZ_TOT_AMT'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_idv_dpsa_temple[<span class="string">'DAY_WD_ACT_AMT'</span>] = train_idv_dpsa_temple.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'DAY_WD_ACT_AMT'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_idv_dpsa_temple[<span class="string">'DAY_CSH_DP_SUM'</span>] = train_idv_dpsa_temple.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'DAY_CSH_DP_SUM'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_idv_dpsa_temple[<span class="string">'DAY_CSH_WD_SUM'</span>] = train_idv_dpsa_temple.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'DAY_CSH_WD_SUM'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_idv_dpsa_temple[<span class="string">'DAY_TFI_SUM'</span>] = train_idv_dpsa_temple.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'DAY_TFI_SUM'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_idv_dpsa_temple[<span class="string">'MOTH_CR_ACCM'</span>] = train_idv_dpsa_temple.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'MOTH_CR_ACCM'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_idv_dpsa_temple[<span class="string">'BEG_MOTH_CRBAL'</span>] = train_idv_dpsa_temple.apply(compute_REAL_MONEY, axis = <span class="number">1</span>, args = (<span class="string">'BEG_MOTH_CRBAL'</span>, <span class="string">'RMB_MID_PRIC'</span>))</span><br><span class="line">    train_idv_dpsa_temple = train_idv_dpsa_temple.drop([<span class="string">'CCY_CD'</span>, <span class="string">'RMB_MID_PRIC'</span>], axis=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 按月将金额分组</span></span><br><span class="line">    BY_MONTH_DPSA = train_idv_dpsa_temple.groupby([<span class="string">'CUST_NO'</span>, <span class="string">'DATA_DAT'</span>])[[<span class="string">'CRBAL'</span>, <span class="string">'ITST_BRNG_ACCM'</span>,</span><br><span class="line">           <span class="string">'FRZ_TOT_AMT'</span>, <span class="string">'DAY_WD_ACT_AMT'</span>, <span class="string">'DAY_CSH_DP_SUM'</span>, <span class="string">'DAY_CSH_WD_SUM'</span>,</span><br><span class="line">           <span class="string">'DAY_TFI_SUM'</span>, <span class="string">'MOTH_CR_ACCM'</span>, <span class="string">'BEG_MOTH_CRBAL'</span>]].sum().unstack()</span><br><span class="line">    <span class="comment"># 声明函数 计算三个月的标准差、均值、最大值、最小值</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">BY_MONTH_IDV_DPSA</span><span class="params">(key)</span>:</span></span><br><span class="line">        train_idv_dpsa_temple_STD = BY_MONTH_DPSA[key].std(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_idv_dpsa_temple_STD.columns = [<span class="string">'CUST_NO'</span>, str(<span class="string">'IDV_DPSA_'</span>+key+<span class="string">'_STD'</span>)]</span><br><span class="line">        train_idv_dpsa_temple_MEAN = BY_MONTH_DPSA[key].mean(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_idv_dpsa_temple_MEAN.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'IDV_DPSA_'</span>+key+<span class="string">'_MEAN'</span>)]</span><br><span class="line">        train_idv_dpsa_temple_MAX = BY_MONTH_DPSA[key].max(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_idv_dpsa_temple_MAX.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'IDV_DPSA_'</span>+key+<span class="string">'_MAX'</span>)]</span><br><span class="line">        train_idv_dpsa_temple_MIN = BY_MONTH_DPSA[key].min(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_idv_dpsa_temple_MIN.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'IDV_DPSA_'</span>+key+<span class="string">'_MIN'</span>)]</span><br><span class="line">        <span class="comment"># 合并字段</span></span><br><span class="line">        train_idv_dpsa_temple = pd.merge(train_idv_dpsa_temple_STD, train_idv_dpsa_temple_MEAN, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_idv_dpsa_temple = pd.merge(train_idv_dpsa_temple, train_idv_dpsa_temple_MAX, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_idv_dpsa_temple = pd.merge(train_idv_dpsa_temple, train_idv_dpsa_temple_MIN, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_idv_dpsa_temple = train_idv_dpsa_temple.fillna(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> train_idv_dpsa_temple</span><br><span class="line">    train_idv_dpsa_temple = BY_MONTH_IDV_DPSA(<span class="string">'CRBAL'</span>)</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> [<span class="string">'ITST_BRNG_ACCM'</span>,<span class="string">'FRZ_TOT_AMT'</span>, <span class="string">'DAY_WD_ACT_AMT'</span>, <span class="string">'DAY_CSH_DP_SUM'</span>, </span><br><span class="line">              <span class="string">'DAY_CSH_WD_SUM'</span>,<span class="string">'DAY_TFI_SUM'</span>, <span class="string">'MOTH_CR_ACCM'</span>, <span class="string">'BEG_MOTH_CRBAL'</span>]:</span><br><span class="line">        train_idv_dpsa_temple = pd.merge(train_idv_dpsa_temple, BY_MONTH_IDV_DPSA(key))</span><br><span class="line">        train_idv_dpsa_temple.drop_duplicates(subset=<span class="keyword">None</span>, keep=<span class="string">'first'</span>, inplace=<span class="keyword">True</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> train_idv_dpsa_temple</span><br></pre></td></tr></table></figure>

<h5 id="交易信息"><a href="#交易信息" class="headerlink" title="交易信息"></a>交易信息</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">BY_MONTH_TR_DC_METHOD</span><span class="params">(dataset_TR_DC)</span>:</span></span><br><span class="line">    <span class="comment"># 预处理</span></span><br><span class="line">    <span class="comment"># 去除抹帐(1),无意义列，这里全是0</span></span><br><span class="line">    dataset_TR_DC = dataset_TR_DC[dataset_TR_DC[<span class="string">'CAN_IND'</span>]==<span class="number">0</span>].drop([<span class="string">'RED_BLU_CD'</span>, <span class="string">'CRD_TYP1'</span>, <span class="string">'TR_TYPE'</span>, <span class="string">'TR_CHANL_CD'</span>, <span class="string">'CAN_IND'</span>, </span><br><span class="line">                                                                      <span class="string">'CARD_USETYPE'</span>, <span class="string">'CARD_ELECASH'</span>, <span class="string">'CARD_MATERIAL'</span>],axis=<span class="number">1</span>)</span><br><span class="line">    dataset_TR_DC.drop_duplicates(subset=<span class="keyword">None</span>, keep=<span class="string">'first'</span>, inplace=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># 交易表时间段打上标签</span></span><br><span class="line">    <span class="comment"># 2月份 [3726432000, 3728937600), 3月份 [3728937600, 3731616000), 4月份 [3731616000, 3734035200]</span></span><br><span class="line">    dataset_TR_DC[<span class="string">'TR_DAT'</span>] = pd.cut(dataset_TR_DC[<span class="string">'TR_DAT'</span>], [<span class="number">3726432000</span>, <span class="number">3728937600</span>, <span class="number">3731616000</span>, <span class="number">3734035200</span>], labels=[<span class="string">'2月份'</span>, <span class="string">'3月份'</span>, <span class="string">'4月份'</span>])</span><br><span class="line">    <span class="comment"># 将交易按照 正 / 负 分开</span></span><br><span class="line">    train_tr_dc[<span class="string">'INCOME'</span>] = train_tr_dc[<span class="string">'TR_AMT'</span>] &gt; <span class="number">0</span></span><br><span class="line">    myseries = train_tr_dc.groupby([<span class="string">'CUST_NO'</span>, <span class="string">'INCOME'</span>])[<span class="string">'TR_AMT'</span>].sum()</span><br><span class="line">    myseries = myseries.unstack().fillna(<span class="number">0</span>)</span><br><span class="line">    TR_DC_IN_OUT = pd.DataFrame(myseries).reset_index()</span><br><span class="line">    TR_DC_IN_OUT[<span class="string">'IN_SUM'</span>] = TR_DC_IN_OUT[<span class="keyword">True</span>]</span><br><span class="line">    TR_DC_IN_OUT[<span class="string">'OUT_SUM'</span>] = TR_DC_IN_OUT[<span class="keyword">False</span>]</span><br><span class="line">    TR_DC_IN_OUT = TR_DC_IN_OUT.drop([<span class="keyword">True</span>, <span class="keyword">False</span>], axis=<span class="number">1</span>)</span><br><span class="line">    BY_MONTH_DC = dataset_TR_DC.groupby([<span class="string">'CUST_NO'</span>, <span class="string">'TR_DAT'</span>])[[<span class="string">'TR_AMT'</span>]].sum().unstack()</span><br><span class="line">    <span class="comment"># 声明函数 计算三个月的标准差、均值、最大值、最小值</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">BY_MONTH_TR_DC</span><span class="params">(key)</span>:</span></span><br><span class="line">        train_tr_dc_temple_STD = BY_MONTH_DC[key].std(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_tr_dc_temple_STD.columns = [<span class="string">'CUST_NO'</span>, str(<span class="string">'TR_DC_'</span>+key+<span class="string">'_STD'</span>)]</span><br><span class="line">        train_tr_dc_temple_MEAN = BY_MONTH_DC[key].mean(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_tr_dc_temple_MEAN.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'TR_DC_'</span>+key+<span class="string">'_MEAN'</span>)]</span><br><span class="line">        train_tr_dc_temple_MAX = BY_MONTH_DC[key].max(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_tr_dc_temple_MAX.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'TR_DC_'</span>+key+<span class="string">'_MAX'</span>)]</span><br><span class="line">        train_tr_dc_temple_MIN = BY_MONTH_DC[key].min(axis=<span class="number">1</span>).reset_index()</span><br><span class="line">        train_tr_dc_temple_MIN.columns = [<span class="string">'CUST_NO'</span>,str(<span class="string">'TR_DC_'</span>+key+<span class="string">'_MIN'</span>)]</span><br><span class="line">        <span class="comment"># 合并字段</span></span><br><span class="line">        train_tr_dc_temple = pd.merge(train_tr_dc_temple_STD, train_tr_dc_temple_MEAN, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_tr_dc_temple = pd.merge(train_tr_dc_temple, train_tr_dc_temple_MAX, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_tr_dc_temple = pd.merge(train_tr_dc_temple, train_tr_dc_temple_MIN, on=<span class="string">'CUST_NO'</span>, how=<span class="string">'inner'</span>)</span><br><span class="line">        train_tr_dc_temple = train_tr_dc_temple.fillna(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> train_tr_dc_temple</span><br><span class="line">    train_tr_dc_temple = BY_MONTH_TR_DC(<span class="string">'TR_AMT'</span>)</span><br><span class="line">    <span class="keyword">return</span> train_tr_dc_temple</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train_tr_dc[<span class="string">'TR_DAT'</span>] = pd.cut(train_tr_dc[<span class="string">'TR_DAT'</span>], [<span class="number">3726432000</span>, <span class="number">3728937600</span>, <span class="number">3731616000</span>, <span class="number">3734035200</span>], labels=[<span class="string">'FEB'</span>, <span class="string">'MAR'</span>, <span class="string">'APR'</span>])</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BY_MONTH_TR_DC_METHOD = train_tr_dc[[<span class="string">'TR_DAT'</span>]]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sns.countplot(x=<span class="string">'TR_DAT'</span>, data=BY_MONTH_TR_DC_METHOD)</span><br></pre></td></tr></table></figure>

<pre><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f0167e23a58&gt;</code></pre><p><img src="/assets/blogImg/OUTPUT_COUNTPLOT.png" alt="COUNTPLOT"></p>
<h4 id="年龄"><a href="#年龄" class="headerlink" title="年龄"></a>年龄</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回单个 或 series 的ms对应日期, 再被 2015 减得到的年数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">adj_date</span><span class="params">(series, datatype=<span class="string">'series'</span>)</span>:</span></span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line">    <span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line">    initial_year = <span class="number">2015</span></span><br><span class="line">    adj_msj_obj = datetime.strptime(<span class="string">"2042-08-31 16:00:00.123"</span>, <span class="string">"%Y-%m-%d %H:%M:%S.%f"</span>)</span><br><span class="line">    adj_ms = int(time.mktime(adj_msj_obj.timetuple())*<span class="number">1000</span> + adj_msj_obj.microsecond/<span class="number">1000.0</span>)/<span class="number">1000</span></span><br><span class="line">    current_ms = train_idv_cust_basic[<span class="string">'DATA_DAT'</span>][<span class="number">0</span>]   <span class="comment"># 3736713600</span></span><br><span class="line">    <span class="keyword">if</span>(datatype==<span class="string">'single'</span>):</span><br><span class="line">        <span class="keyword">return</span> initial_year - int(time.strftime(<span class="string">"%Y%m"</span>, time.localtime(current_ms-adj_ms)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> series.map(<span class="keyword">lambda</span> x: initial_year - int(time.strftime(<span class="string">"%Y"</span>, time.localtime(x - adj_ms))) <span class="keyword">if</span> pd.notna(x) <span class="keyword">else</span> x)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 年龄计算函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">CALC_AGE</span><span class="params">(dataset_idv_cust_basic)</span>:</span></span><br><span class="line">    dataset_idv_cust_basic[<span class="string">'GC_BRTH'</span>] = dataset_idv_cust_basic[<span class="string">'GC_BRTH'</span>].fillna(dataset_idv_cust_basic[<span class="string">'GC_BRTH'</span>].mean())</span><br><span class="line">    dataset_idv_cust_basic[<span class="string">'AGE'</span>] = adj_date(dataset_idv_cust_basic[<span class="string">'GC_BRTH'</span>])</span><br><span class="line">    dataset_idv_cust_basic[<span class="string">'AGE'</span>] = np.where(dataset_idv_cust_basic[<span class="string">'AGE'</span>] &gt; <span class="number">100</span>, <span class="number">31</span>, dataset_idv_cust_basic[<span class="string">'AGE'</span>])</span><br><span class="line">    dataset_idv_cust_basic[<span class="string">'AGE'</span>] = np.where(dataset_idv_cust_basic[<span class="string">'AGE'</span>] &lt; <span class="number">16</span>, <span class="number">31</span>, dataset_idv_cust_basic[<span class="string">'AGE'</span>])</span><br><span class="line">    <span class="keyword">return</span> dataset_idv_cust_basic</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AGE = CALC_AGE(train_idv_cust_basic)[<span class="string">'AGE'</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AGE.hist()</span><br></pre></td></tr></table></figure>

<pre><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f01681b5cc0&gt;

/root/anaconda3/lib/python3.6/site-packages/matplotlib/font_manager.py:1320: UserWarning: findfont: Font family [&apos;sans-serif&apos;] not found. Falling back to DejaVu Sans
  (prop.get_family(), self.defaultFamily[fontext]))</code></pre><p><img src="/assets/blogImg/OUTPUT_HIST.png" alt="HIST"></p>
<h4 id="所有资产"><a href="#所有资产" class="headerlink" title="所有资产"></a>所有资产</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># td定期、bond国债、fund基金、prec_metal贵金属、aget_insr保险</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">WEALTH</span><span class="params">(target,td,bond,fund,prec_metal,agent_insurance,thr_pty_cstd)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    # 销户日期必须 &gt; 2月底，合约建立日期必须 &lt; 4月底</span></span><br><span class="line"><span class="string">        #gp = df_tr_train.groupby(['CUST_NO','TR_CD']).agg(&#123;'TR_AMT':['sum','mean','max','min','count','std']&#125;)</span></span><br><span class="line"><span class="string">        if len(suffix)==1:</span></span><br><span class="line"><span class="string">            td = td[td['DATA_DAT']==time_point[1]]</span></span><br><span class="line"><span class="string">            bond = bond[bond['DATA_DAT']==time_point[1]]</span></span><br><span class="line"><span class="string">            fund = fund[fund['DATA_DAT']==time_point[1]]</span></span><br><span class="line"><span class="string">            prec_metal = prec_metal[prec_metal['DATA_DAT']==time_point[1]]</span></span><br><span class="line"><span class="string">            agent_insurance = agent_insurance[agent_insurance['DATA_DAT']==time_point[1]]</span></span><br><span class="line"><span class="string">            thr_pty_cstd = thr_pty_cstd[thr_pty_cstd['DATA_DAT']==time_point[1]]</span></span><br><span class="line"><span class="string">        elif len(suffix)==2:</span></span><br><span class="line"><span class="string">            td = td[td['DATA_DAT']&gt;time_point[1]]</span></span><br><span class="line"><span class="string">            bond = bond[bond['DATA_DAT']&gt;time_point[1]]</span></span><br><span class="line"><span class="string">            fund = fund[fund['DATA_DAT']&gt;time_point[1]]</span></span><br><span class="line"><span class="string">            prec_metal = prec_metal[prec_metal['DATA_DAT']&gt;time_point[1]]</span></span><br><span class="line"><span class="string">            agent_insurance = agent_insurance[agent_insurance['DATA_DAT']&gt;time_point[1]]</span></span><br><span class="line"><span class="string">            thr_pty_cstd = thr_pty_cstd[thr_pty_cstd['DATA_DAT']&gt;time_point[1]]</span></span><br><span class="line"><span class="string">    '''</span>        </span><br><span class="line">            </span><br><span class="line">    <span class="comment"># 选取各表合并特征</span></span><br><span class="line">    td = td[[<span class="string">'CUST_NO'</span>,<span class="string">'DATA_DAT'</span>,<span class="string">'CRBAL'</span>,<span class="string">'MOTH_CR_ACCM'</span>]].groupby([<span class="string">'CUST_NO'</span>,<span class="string">'DATA_DAT'</span>]).sum().unstack().reset_index()</span><br><span class="line">    </span><br><span class="line">    bond = bond[[<span class="string">'CUST_NO'</span>,<span class="string">'DATA_DAT'</span>,<span class="string">'ARG_CUR_BAL'</span>,<span class="string">'NVTA_MOTH_ACCM'</span>]].groupby([<span class="string">'CUST_NO'</span>,<span class="string">'DATA_DAT'</span>]).sum().unstack().reset_index()</span><br><span class="line">    </span><br><span class="line">    fund = fund[[<span class="string">'CUST_NO'</span>,<span class="string">'DATA_DAT'</span>,<span class="string">'FUND_BAL'</span>,<span class="string">'FUND_BAL_MOTH_BAL_ACCM'</span>]].groupby([<span class="string">'CUST_NO'</span>,<span class="string">'DATA_DAT'</span>]).sum().unstack().reset_index()</span><br><span class="line">    </span><br><span class="line">    prec_metal = prec_metal[[<span class="string">'CUST_NO'</span>,<span class="string">'DATA_DAT'</span>,<span class="string">'ARG_BAL'</span>,<span class="string">'MTH_ARG_ACCM'</span>]].groupby([<span class="string">'CUST_NO'</span>,<span class="string">'DATA_DAT'</span>]).sum().unstack().reset_index()</span><br><span class="line">    </span><br><span class="line">    agent_insurance = agent_insurance[[<span class="string">'CUST_NO'</span>,<span class="string">'DATA_DAT'</span>,<span class="string">'BEG_MTH_PREM_BAL'</span>,<span class="string">'MTH_PREM_ACCM'</span>]].groupby([<span class="string">'CUST_NO'</span>,<span class="string">'DATA_DAT'</span>]).sum().unstack().reset_index()</span><br><span class="line">    </span><br><span class="line">    thr_pty_cstd = thr_pty_cstd[[<span class="string">'CUST_NO'</span>,<span class="string">'DATA_DAT'</span>,<span class="string">'AVL_BAL'</span>,<span class="string">'MTH_ARG_BAL_ACCM'</span>]].groupby([<span class="string">'CUST_NO'</span>,<span class="string">'DATA_DAT'</span>]).sum().unstack().reset_index()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 理财各月的金额、持有产品的数量、</span></span><br><span class="line">    wealth = pd.merge(target[[<span class="string">'CUST_NO'</span>]],td,on=[<span class="string">'CUST_NO'</span>],how=<span class="string">'outer'</span>)</span><br><span class="line">    wealth = pd.merge(wealth,bond,on=[<span class="string">'CUST_NO'</span>],how=<span class="string">'outer'</span>)</span><br><span class="line">    wealth = pd.merge(wealth,fund,on=[<span class="string">'CUST_NO'</span>],how=<span class="string">'outer'</span>)</span><br><span class="line">    wealth = pd.merge(wealth,prec_metal,on=[<span class="string">'CUST_NO'</span>],how=<span class="string">'outer'</span>)</span><br><span class="line">    wealth = pd.merge(wealth,thr_pty_cstd,on=[<span class="string">'CUST_NO'</span>],how=<span class="string">'outer'</span>)</span><br><span class="line">    wealth = pd.merge(wealth,agent_insurance,on=[<span class="string">'CUST_NO'</span>],how=<span class="string">'outer'</span>).fillna(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 理财各月的金额、持有产品的数量、</span></span><br><span class="line">    <span class="comment">#wealth['WEALTH_BAL'] = wealth['CRBAL'] + wealth['ARG_CUR_BAL'] + wealth['FUND_BAL'] + wealth['ARG_BAL'] + wealth['BEG_MTH_PREM_BAL'] #+ wealth['AVL_BAL']</span></span><br><span class="line">    <span class="comment">#wealth['WEALTH_ACCM'] = wealth['MOTH_CR_ACCM'] + wealth['NVTA_MOTH_ACCM'] + wealth['FUND_BAL_MOTH_BAL_ACCM'] + wealth['MTH_ARG_ACCM'] + wealth['MTH_PREM_ACCM'] #+ wealth['MTH_ARG_BAL_ACCM']</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">#wealth = wealth.groupby(['CUST_NO'])['WEALTH_BAL','WEALTH_ACCM'].sum().reset_index()</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 持有的理财产品种类（不同期限/合约建立日期、相同品种的算不同产品）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 首份理财合约建立时间、最近一份理财合约建立时间</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3个月内买入理财产品次数</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3个月存款积数之和（活期，活期+定期+三方存管）</span></span><br><span class="line">    X = wealth.copy()</span><br><span class="line">    X[<span class="string">'WEALTH_BAL_1'</span>] = X[(<span class="string">'CRBAL'</span>, <span class="number">3728764800</span>)]+X[(<span class="string">'ARG_CUR_BAL'</span>, <span class="number">3728764800</span>)]+X[(<span class="string">'FUND_BAL'</span>, <span class="number">3728764800</span>)]+X[(<span class="string">'ARG_BAL'</span>, <span class="number">3728764800</span>)]+X[(<span class="string">'AVL_BAL'</span>, <span class="number">3728764800</span>)]+X[(<span class="string">'BEG_MTH_PREM_BAL'</span>, <span class="number">3728764800</span>)]</span><br><span class="line">    X[<span class="string">'WEALTH_BAL_2'</span>] = X[(<span class="string">'CRBAL'</span>, <span class="number">3731443200</span>)]+X[(<span class="string">'ARG_CUR_BAL'</span>, <span class="number">3731443200</span>)]+X[(<span class="string">'FUND_BAL'</span>, <span class="number">3731443200</span>)]+X[(<span class="string">'ARG_BAL'</span>, <span class="number">3731443200</span>)]+X[(<span class="string">'AVL_BAL'</span>, <span class="number">3731443200</span>)]+X[(<span class="string">'BEG_MTH_PREM_BAL'</span>, <span class="number">3731443200</span>)]</span><br><span class="line">    X[<span class="string">'WEALTH_BAL_3'</span>] = X[(<span class="string">'CRBAL'</span>, <span class="number">3734035200</span>)]+X[(<span class="string">'ARG_CUR_BAL'</span>, <span class="number">3734035200</span>)]+X[(<span class="string">'FUND_BAL'</span>, <span class="number">3734035200</span>)]+X[(<span class="string">'ARG_BAL'</span>, <span class="number">3734035200</span>)]+X[(<span class="string">'AVL_BAL'</span>, <span class="number">3734035200</span>)]+X[(<span class="string">'BEG_MTH_PREM_BAL'</span>, <span class="number">3734035200</span>)]</span><br><span class="line">    X[<span class="string">'WEALTH_ACCM_1'</span>] = X[(<span class="string">'MOTH_CR_ACCM'</span>, <span class="number">3728764800</span>)]+X[(<span class="string">'NVTA_MOTH_ACCM'</span>, <span class="number">3728764800</span>)]+X[(<span class="string">'FUND_BAL_MOTH_BAL_ACCM'</span>, <span class="number">3728764800</span>)]+X[(<span class="string">'MTH_ARG_ACCM'</span>, <span class="number">3728764800</span>)]+X[(<span class="string">'MTH_ARG_BAL_ACCM'</span>, <span class="number">3728764800</span>)]+X[(<span class="string">'MTH_PREM_ACCM'</span>, <span class="number">3728764800</span>)]</span><br><span class="line">    X[<span class="string">'WEALTH_ACCM_2'</span>] = X[(<span class="string">'MOTH_CR_ACCM'</span>, <span class="number">3731443200</span>)]+X[(<span class="string">'NVTA_MOTH_ACCM'</span>, <span class="number">3731443200</span>)]+X[(<span class="string">'FUND_BAL_MOTH_BAL_ACCM'</span>, <span class="number">3731443200</span>)]+X[(<span class="string">'MTH_ARG_ACCM'</span>, <span class="number">3731443200</span>)]+X[(<span class="string">'MTH_ARG_BAL_ACCM'</span>, <span class="number">3731443200</span>)]+X[(<span class="string">'MTH_PREM_ACCM'</span>, <span class="number">3731443200</span>)]</span><br><span class="line">    X[<span class="string">'WEALTH_ACCM_3'</span>] = X[(<span class="string">'MOTH_CR_ACCM'</span>, <span class="number">3734035200</span>)]+X[(<span class="string">'NVTA_MOTH_ACCM'</span>, <span class="number">3734035200</span>)]+X[(<span class="string">'FUND_BAL_MOTH_BAL_ACCM'</span>, <span class="number">3734035200</span>)]+X[(<span class="string">'MTH_ARG_ACCM'</span>, <span class="number">3734035200</span>)]+X[(<span class="string">'MTH_ARG_BAL_ACCM'</span>, <span class="number">3734035200</span>)]+X[(<span class="string">'MTH_PREM_ACCM'</span>, <span class="number">3734035200</span>)]</span><br><span class="line">    </span><br><span class="line">    X2 = X[[<span class="string">'CUST_NO'</span>,<span class="string">'WEALTH_BAL_1'</span>,<span class="string">'WEALTH_BAL_2'</span>,<span class="string">'WEALTH_BAL_3'</span>,<span class="string">'WEALTH_ACCM_1'</span>,<span class="string">'WEALTH_ACCM_2'</span>,<span class="string">'WEALTH_ACCM_3'</span>]].set_index(<span class="string">'CUST_NO'</span>)</span><br><span class="line">    </span><br><span class="line">    X2[<span class="string">'WEALTH_BAL_MAX'</span>] = X2[[<span class="string">'WEALTH_BAL_1'</span>,<span class="string">'WEALTH_BAL_2'</span>,<span class="string">'WEALTH_BAL_3'</span>]].max(axis=<span class="number">1</span>)</span><br><span class="line">    X2[<span class="string">'WEALTH_BAL_MEAN'</span>] = X2[[<span class="string">'WEALTH_BAL_1'</span>,<span class="string">'WEALTH_BAL_2'</span>,<span class="string">'WEALTH_BAL_3'</span>]].mean(axis=<span class="number">1</span>)</span><br><span class="line">    X2[<span class="string">'WEALTH_BAL_STD'</span>] = X2[[<span class="string">'WEALTH_BAL_1'</span>,<span class="string">'WEALTH_BAL_2'</span>,<span class="string">'WEALTH_BAL_3'</span>]].std(axis=<span class="number">1</span>).fillna(<span class="number">0.0</span>)</span><br><span class="line">    X2[<span class="string">'WEALTH_BAL_CV'</span>] = X2[<span class="string">'WEALTH_BAL_STD'</span>]/X2[<span class="string">'WEALTH_BAL_MEAN'</span>]</span><br><span class="line">    X2[<span class="string">'WEALTH_ACCM_MAX'</span>] = X2[[<span class="string">'WEALTH_ACCM_1'</span>,<span class="string">'WEALTH_ACCM_2'</span>,<span class="string">'WEALTH_ACCM_3'</span>]].max(axis=<span class="number">1</span>)</span><br><span class="line">    X2[<span class="string">'WEALTH_ACCM_MEAN'</span>] = X2[[<span class="string">'WEALTH_ACCM_1'</span>,<span class="string">'WEALTH_ACCM_2'</span>,<span class="string">'WEALTH_ACCM_3'</span>]].mean(axis=<span class="number">1</span>)</span><br><span class="line">    X2[<span class="string">'WEALTH_ACCM_STD'</span>] = X2[[<span class="string">'WEALTH_ACCM_1'</span>,<span class="string">'WEALTH_ACCM_2'</span>,<span class="string">'WEALTH_ACCM_3'</span>]].std(axis=<span class="number">1</span>).fillna(<span class="number">0.0</span>)</span><br><span class="line">    X2[<span class="string">'WEALTH_ACCM_CV'</span>] = X2[<span class="string">'WEALTH_ACCM_STD'</span>]/X2[<span class="string">'WEALTH_ACCM_MEAN'</span>]    </span><br><span class="line">    </span><br><span class="line">    X3 = X2.fillna(<span class="number">0.0</span>).drop([<span class="string">'WEALTH_BAL_1'</span>,<span class="string">'WEALTH_BAL_2'</span>,<span class="string">'WEALTH_BAL_3'</span>,<span class="string">'WEALTH_ACCM_1'</span>,<span class="string">'WEALTH_ACCM_2'</span>,<span class="string">'WEALTH_ACCM_3'</span>,<span class="string">'WEALTH_BAL_STD'</span>,<span class="string">'WEALTH_ACCM_STD'</span>],axis=<span class="number">1</span>).reset_index()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> X3[[<span class="string">'CUST_NO'</span>,<span class="string">'WEALTH_ACCM_MEAN'</span>,<span class="string">'WEALTH_ACCM_CV'</span>]]</span><br></pre></td></tr></table></figure>

<h3 id="结果挖掘"><a href="#结果挖掘" class="headerlink" title="结果挖掘"></a>结果挖掘</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">train_cust_result_1 = train_cust_result[train_cust_result[<span class="string">'FLAG'</span>]==<span class="number">1</span>]</span><br><span class="line">train_cust_result_0 = train_cust_result[train_cust_result[<span class="string">'FLAG'</span>]==<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lightgbm <span class="keyword">import</span> LGBMRegressor</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">! pip install lightgbm<span class="number">-2.2</span><span class="number">.3</span>-py2.py3-none-manylinux1_x86_64.whl</span><br></pre></td></tr></table></figure>

<pre><code>Processing ./lightgbm-2.2.3-py2.py3-none-manylinux1_x86_64.whl
Requirement already satisfied: scikit-learn in /root/anaconda3/lib/python3.6/site-packages (from lightgbm==2.2.3)
Requirement already satisfied: scipy in /root/anaconda3/lib/python3.6/site-packages (from lightgbm==2.2.3)
Requirement already satisfied: numpy in /root/anaconda3/lib/python3.6/site-packages (from lightgbm==2.2.3)
Installing collected packages: lightgbm
Successfully installed lightgbm-2.2.3</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">! cp ./xgb_rfm-Copy1.ipynb ./xgb_rfm-Copy2.ipynb</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">! pip install imbalanced-learn</span><br></pre></td></tr></table></figure>

<pre><code>Requirement already satisfied: imbalanced-learn in /root/anaconda3/lib/python3.6/site-packages
Requirement already satisfied: scipy&gt;=0.17 in /root/anaconda3/lib/python3.6/site-packages (from imbalanced-learn)
Requirement already satisfied: joblib&gt;=0.11 in /root/anaconda3/lib/python3.6/site-packages (from imbalanced-learn)
Requirement already satisfied: scikit-learn&gt;=0.21 in /root/anaconda3/lib/python3.6/site-packages (from imbalanced-learn)
Requirement already satisfied: numpy&gt;=1.11 in /root/anaconda3/lib/python3.6/site-packages (from imbalanced-learn)</code></pre>
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Python/" rel="tag"><i class="fa fa-tag"></i> Python</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/02/27/CentOS安装MySQL8/" rel="next" title="CentOS安装MySQL 8.0">
                <i class="fa fa-chevron-left"></i> CentOS安装MySQL 8.0
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/09/05/JAVA基础知识-HashMap/" rel="prev" title="JAVA基础知识-HashMap">
                JAVA基础知识-HashMap <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">LEEZY</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">15</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="/string.zhengyang@gmail.com" title="E-Mail &rarr; string.zhengyang@gmail.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备工作"><span class="nav-number">1.</span> <span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据源准备"><span class="nav-number">2.</span> <span class="nav-text">数据源准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#公用函数"><span class="nav-number">3.</span> <span class="nav-text">公用函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#特征工程"><span class="nav-number">4.</span> <span class="nav-text">特征工程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#个人客户基本信息表-IDV-CUST-BASIC-处理"><span class="nav-number">4.1.</span> <span class="nav-text">个人客户基本信息表(IDV_CUST_BASIC) - 处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#个人定期存款账户信息（IDV-TD）-处理"><span class="nav-number">4.2.</span> <span class="nav-text">个人定期存款账户信息（IDV_TD）- 处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#个人活期存款账户信息（IDV-DPSA）-处理"><span class="nav-number">4.3.</span> <span class="nav-text">个人活期存款账户信息（IDV_DPSA）-  处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#交易信息（TR-DC）-处理"><span class="nav-number">4.4.</span> <span class="nav-text">交易信息（TR_DC） - 处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第三方存管账户信息（THR-PTY-CSTD）-处理"><span class="nav-number">4.5.</span> <span class="nav-text">第三方存管账户信息（THR_PTY_CSTD） - 处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#贷款账户信息（LOAN）-处理"><span class="nav-number">4.6.</span> <span class="nav-text">贷款账户信息（LOAN）- 处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基金账户信息（FUND）-处理"><span class="nav-number">4.7.</span> <span class="nav-text">基金账户信息（FUND）- 处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#国债账户信息（BOND）-处理"><span class="nav-number">4.8.</span> <span class="nav-text">国债账户信息（BOND）- 处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#贵金属账户信息（PREC-METAL）-处理"><span class="nav-number">4.9.</span> <span class="nav-text">贵金属账户信息（PREC_METAL）- 处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#代理保险账户信息（AGET-INSR）-处理"><span class="nav-number">4.10.</span> <span class="nav-text">代理保险账户信息（AGET_INSR）- 处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表间融合"><span class="nav-number">5.</span> <span class="nav-text">表间融合</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TRAIN集"><span class="nav-number">5.1.</span> <span class="nav-text">TRAIN集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TRAIN-剪枝"><span class="nav-number">5.2.</span> <span class="nav-text">TRAIN 剪枝</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#A集"><span class="nav-number">5.3.</span> <span class="nav-text">A集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#A-剪枝"><span class="nav-number">5.4.</span> <span class="nav-text">A 剪枝</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B集"><span class="nav-number">5.5.</span> <span class="nav-text">B集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B集剪枝"><span class="nav-number">5.6.</span> <span class="nav-text">B集剪枝</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#欠采样"><span class="nav-number">5.7.</span> <span class="nav-text">欠采样</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#算法分析"><span class="nav-number">6.</span> <span class="nav-text">算法分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#XGB算法"><span class="nav-number">6.1.</span> <span class="nav-text">XGB算法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#提交结果"><span class="nav-number">7.</span> <span class="nav-text">提交结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#深化特征工程"><span class="nav-number">8.</span> <span class="nav-text">深化特征工程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#各类理财产品的持有数量"><span class="nav-number">8.1.</span> <span class="nav-text">各类理财产品的持有数量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三个月变动"><span class="nav-number">8.2.</span> <span class="nav-text">三个月变动</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#定期账户"><span class="nav-number">8.2.1.</span> <span class="nav-text">定期账户</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#活期账户"><span class="nav-number">8.2.2.</span> <span class="nav-text">活期账户</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#交易信息"><span class="nav-number">8.2.3.</span> <span class="nav-text">交易信息</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#年龄"><span class="nav-number">8.3.</span> <span class="nav-text">年龄</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#所有资产"><span class="nav-number">8.4.</span> <span class="nav-text">所有资产</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#结果挖掘"><span class="nav-number">9.</span> <span class="nav-text">结果挖掘</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LEEZY</span>

  

  
</div>


  <div class="powered-by">由 <a href="#" class="theme-link">Hexo</a> 强力驱动 </div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="#" class="theme-link">NexT.Mist</a> </div>





  <span class="post-meta-divider">|</span>


<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共32.1k字</span>
</div></div>
        








        
      </footer></div>
    

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
      <div>
        <!-- Go to www.addthis.com/dashboard to customize your tools -->
<div class="addthis_inline_share_toolbox">
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c1ba94c46868e3e" async="async"></script>
</div>

      </div>
    
  

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script src="/js/src/utils.js?v=6.6.0"></script>

  <script src="/js/src/motion.js?v=6.6.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.6.0"></script>
<script src="/js/src/post-details.js?v=6.6.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>

  <script>
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'tdvMb2E4CfK077KFm5aDvXV7-gzGzoHsz',
        appKey: 'wPLAP3mIpwojzLkmbeiNMEoP',
        placeholder: 'Just go go',
        avatar:'identicon',
        meta:guest,
        pageSize:'10' || 10,
        visitor: false
    });
  </script>




  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script>
    
    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function ({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text(counter.time + 1);
            
            Counter('put', `/classes/Counter/${counter.objectId}`, JSON.stringify({ time: { "__op":"Increment", "amount":1 } }))
            
            .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
            })
          } else {
            
              Counter('post', '/classes/Counter', JSON.stringify({ title: title, url: url, time: 1}))
                .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(1);
                })
                .fail(function () {
                  console.log('Failed to create');
                });
            
          }
        })
      .fail(function ({ responseJSON }) {
        console.log('LeanCloud Counter Error:' + responseJSON.code + " " + responseJSON.error);
      });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "tdvMb2E4CfK077KFm5aDvXV7-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "tdvMb2E4CfK077KFm5aDvXV7-gzGzoHsz",
                'X-LC-Key': "wPLAP3mIpwojzLkmbeiNMEoP",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          addCount(Counter);
          
        })
    });
  </script>



  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>
